"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function mergeConfig(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return _.merge({},e,{types:types,fields:fields})}function temporalTables(e){return _.omitBy(_.mapValues(e,function(e){var t=_.get(e,"_backend",{});return t.temporal?{table:_.get(e,"_backend.collection")}:null}),function(e){return null===e})}function expandGQLErrors(e){if(_.isArray(e))return _.map(e,function(e){try{return _.isObject(e)?JSON.stringify(e):e}catch(t){return e}});try{return _.isObject(e)?JSON.stringify(e):e}catch(t){return e}}function safeParse(e){try{return JSON.parse(e)}catch(t){return e}}function convertType(e,t,r){if(!e||!t)throw new Error("could not determine type of variable name to convert");switch(e){case"ARRAY":if(r=_.isString(r)?safeParse(r):r,_.isArray(r))return r;case"BOOLEAN":if(r=_.isString(r)?safeParse(r):r,_.isBoolean(r))return Boolean(r);case"DATE":try{return new Date(r)}catch(e){}case"NUMBER":if(r=_.isString(r)?safeParse(r):r,_.isNumber(r))return Number(r);case"OBJECT":if(r=_.isString(r)?safeParse(r):r,_.isObject(r))return r;case"STRING":if(_.isString(r))return String(r);default:throw new Error(t+" could not be cast to type "+e)}}function mapInput(e,t,r){var n={};return _.forEach(r,function(r){if(r.class===INPUT)if(r.mapsTo){var o=_.find(t,function(e){return _.get(e,"parameter.id")===r.mapsTo})||{},a=o.parameter,u=o.value;a&&(n[r.name]=u)}else try{n[r.name]=convertType(r.type,r.name,_.get(e,r.name))}catch(e){}}),n}function winTieBreak(e,t){return!_.without(t,e).length||t.sort()[0]===e}function getStepRun(e,t,r){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow('{\n    readStepRun (id: "'+t+'") {\n      status,\n      thread { id, workflowRun { id } },\n      step { async, success }\n    }\n  }').then(function(e){return e.errors?r(new n(expandGQLErrors(e.errors))):r(null,_.get(e,"data.readStepRun[0]"))}).catch(r)}function endWorkflowRun(e,t,r,n){var o=e.graphql.GraphQLError;return e.lib.S2FWorkflow('mutation Mutation {\n    endWorkflowRun (id: "'+t+'", status: '+r+")\n  }").then(function(e){return e.errors?n(new o(expandGQLErrors(e.errors))):n(null,_.get(e,"data.endWorkflowRun"))}).catch(n)}function getRunSummary(e,t,r){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow('{\n    readWorkflowRun (id: "'+t+'") {\n      context {\n        parameter { name },\n        value\n      },\n      threads {\n        stepRuns {\n          step { type, failsWorkflow }\n          status\n        }\n      },\n      parentStepRun,\n      taskId\n    }\n  }').then(function(e){return e.errors?r(new n(expandGQLErrors(e.errors))):r(null,_.get(e,"data.readWorkflowRun[0]"))}).catch(r)}function getRunThreads(e,t,r){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow('{\n    readWorkflowRun (id: "'+t+'") {\n      threads { id, status }\n    }\n  }').then(function(e){return e.errors?r(new n(expandGQLErrors(e.errors))):r(null,_.get(e,"data.readWorkflowRun[0].threads"))}).catch(r)}function newStepRun(e,t,r,n){var o=e.graphql.GraphQLError;return e.lib.S2FWorkflow('mutation Mutation {\n    createStepRun (step: "'+t+'", workflowRunThread: "'+r+'"),\n    { id }\n  }').then(function(e){return e.errors?n(new o(expandGQLErrors(e.errors))):n(null,_.get(e,"data.createStepRun"))}).catch(n)}function getStep(e,t,r){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow('{\n    readStep (id: "'+t+'") {\n      id, name, type\n    }\n  }').then(function(e){return e.errors?r(new n(expandGQLErrors(e.errors))):r(null,_.get(e,"data.readStep[0]"))}).catch(r)}function newForks(e,t,r,n,o){var a=e.graphql.GraphQLError;return e.lib.S2FWorkflow('mutation Mutation {\n    createForks (step: "'+t+'", workflowRun: "'+r+'", workflowRunThread: "'+n+'")\n    { id }\n  }').then(function(e){return e.errors?o(new a(expandGQLErrors(e.errors))):o(null,_.get(e,"data.createForks"))}).catch(o)}function setStepRunStatus(e,t,r,n){var o=e.graphql.GraphQLError;return e.lib.S2FWorkflow('mutation Mutation {\n    setStepRunStatus (id: "'+t+'", status: '+r+")\n  }").then(function(e){return e.errors?n(new o(expandGQLErrors(e.errors))):n(null,_.get(e,"data.setStepRunStatus"))}).catch(n)}function updateAttributeValues(e,t,r){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow("mutation Mutation {\n    updateAttributeValues (values: "+obj2arg(t)+")\n  }").then(function(e){return e.errors?r(new n(expandGQLErrors(e.errors))):r(null,_.get(e,"data.updateAttributeValues"))}).catch(r)}function updateWorkflowRunThread(e,t,r){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow("mutation Mutation {\n    updateWorkflowRunThread ("+obj2arg(t,{noOuterBraces:!0})+")\n    { id }\n  }").then(function(e){return e.errors?r(new n(expandGQLErrors(e.errors))):r(null,_.get(e,"data.updateWorkflowRunThread"))}).catch(r)}function startStepRun(e,t,r,n){var o=e.graphql.GraphQLError;return e.lib.S2FWorkflow('mutation Mutation {\n    startStepRun (\n      id: "'+t+'",\n      taskId: "'+r+'"\n    )\n  }').then(function(e){return e.errors?n(new o(expandGQLErrors(e.errors))):n(null,_.get(e,"data.startStepRun"))}).catch(n)}function newWorkflowRun(e,t,r){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow("mutation Mutation {\n    createWorkflowRun ("+obj2arg(t,{noOuterBraces:!0})+") {\n      id,\n      threads { id }\n    }\n  }",{},t).then(function(e){return e.errors?r(new n(expandGQLErrors(e.errors))):r(null,_.get(e,"data.createWorkflowRun"))}).catch(r)}function getWorkflowRun(e,t,r,n){var o=e.graphql.GraphQLError;return e.lib.S2FWorkflow('{\n    readWorkflowRun (id: "'+t+'") {\n      workflow { endStep { id } },\n      args,\n      input,\n      context {\n        id,\n        parameter { id, name, type, scope, class },\n        value\n      },\n      threads (id: "'+r+'") {\n        currentStepRun {\n          id,\n          step {\n            id,\n            type,\n            async,\n            source,\n            subWorkflow {\n              _temporal { recordId },\n              id\n            },\n            timeout,\n            failsWorkflow,\n            waitOnSuccess,\n            requireResumeKey,\n            success,\n            fail,\n            parameters { id, name, type, scope, class, mapsTo }\n          }\n        }\n      }\n    }\n  }').then(function(e){return e.errors?n(new o(expandGQLErrors(e.errors))):n(null,_.get(e,"data.readWorkflowRun[0]"))}).catch(n)}function computeWorkflowStatus(e,t){var r=this;try{var n=function(){var n=e.runner,o=e.workflowRun,a=e.thread,u={};return r.log.trace({workflowRun:o},"attempting to complete workflow run computation"),{v:getRunSummary(r,o,function(e,l){if(e)return t(e);var i=l.context,d=l.threads,s=l.parentStepRun,c=l.taskId;if(!d)return t(new Error("no threads found"));_.forEach(i,function(e){var t=_.get(e,"parameter.name");t&&_.has(e,"value")&&(u[t]=e.value)});var p=_.reduce(d,function(e,t){return _.union(e,_.get(t,"stepRuns",[]))},[]),f=_.reduce(p,function(e,t){var r=_.includes([BASIC,TASK,WORKFLOW],t.type),n=!(t.failsWorkflow&&r&&t.status!==FAIL);return e&&n},!0),y=f?SUCCESS$1:FAIL;return updateWorkflowRunThread(r,{id:a,status:"Enum::"+JOINED$1},function(e){return e?t(e):(r.log.trace({workflowRun:o},"joined final thread"),endWorkflowRun(r,o,y,function(e){return e?t(e):(r.log.debug({workflowRun:o,success:f},"workflow run completed"),s&&n.resume(c,{status:y,context:u}),t(null,y,{context:u}))}))})})}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){this.log.error({errors:e.message||e,stack:e.stack},"Failed to compute workflow status"),t(e)}}function joinThreads(e,t){e.workflowRun,e.thread;t()}function nextStepRun(e,t){var r=this;try{var n=function(){var n=e.thread,o=e.nextStep,a=e.async,u=e.workflowRun,l=_.get(r,"server._emitter");return l||a?{v:getStep(r,o,function(i,d){if(i)return t(i);var s=_.get(d,"type");return s?s===JOIN?joinThreads.call(r,e,t):newStepRun(r,o,n,function(e,o){if(e)return t(e);var i=_.get(o,"id");if(!i)throw new Error("Unable to create StepRun");var d={id:n,status:"Enum::"+RUNNING,currentStepRun:i};return updateWorkflowRunThread(r,d,function(e){return e?t(e):(l.emit("schedule",{payload:{action:"runStep",context:{thread:n,workflowRun:u}}}),!!a||t())})}):t(new Error("failed to get next step type"))})}:{v:t(new Error("No event emitter"))}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){return this.log.error({errors:e.message||e,stack:e.stack},"Failed to start next step"),t(e)}}function resumeStep(e,t,r){try{return getStepRun(e,t,function(n,o){var a=_.get(o,"status"),u=_.get(o,"thread.id"),l=_.get(o,"thread.workflowRun.id"),i=_.get(o,"step.success"),d=_.get(o,"step.async",!1);return n?r(n):o?i?u&&l?a!==WAITING?r(new Error("invalid step run status "+a+", must be "+WAITING)):setStepRunStatus(e,t,SUCCESS,function(t){return t?r(t):nextStepRun.call(e,{thread:u,workflowRun:l,nextStep:i,async:d},r)}):r(new Error("unable to retrieve workflow run and/or thread info")):r(new Error("attempting to resume a step with no success path")):r(new Error("invalid step run"))})}catch(t){e.log.error({errors:t.message||t,stack:t.stack},"Failed to run source step"),r(t)}}function createFolder(e){return function(t,r,n,o){e.r,e.connection,e.getTypeCollection("Folder")}}function readFolder(e){return function(t,r,n,o){e.r,e.connection,e.getTypeCollection("Folder")}}function updateFolder(e){return function(t,r,n,o){e.r,e.connection,e.getTypeCollection("Folder")}}function deleteFolder(e){return function(t,r,n,o){e.r,e.connection,e.getTypeCollection("Folder")}}function readWorkflowFolder(e){return function(t,r,n,o){var a=(e.r,e.connection),u=e.getTypeCollection("Folder"),l=e.getTypeCollection("FolderMembership");return l.get(t._temporal.recordId).do(function(e){return e.eq(null).branch(u.filter({type:"WORKFLOW",parent:"ROOT"}).nth(0)("id"),e("folder"))}).run(a)}}function readRootFolder(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Folder"),i=e.getTypeCollection("FolderMembership"),d=e.getTypeCollection("Task"),s=e.getTypeCollection("Workflow");return l.filter(function(e){return e("type").eq(r.type).and(e("parent").eq("ROOT"))}).merge(function(e){return{subFolders:l.filter({parent:e("id")}).coerceTo("array"),entities:i.filter({folder:e("id")}).map(function(e){return a.expr(_.toLower(r.type)).eq("task").branch(d,s).filter({_temporal:{recordId:e("childId")}}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0).do(function(e){return{id:e("_temporal")("recordId"),branchId:e("id"),version:e("_temporal")("version"),name:e("name")}}))})}).filter(function(e){return e.eq(null).not()}).coerceTo("array")}}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0))}).run(u)}}function readSubFolder(e){return function(t,r,n,o){var a=(e.r,e.connection),u=e.getTypeCollection("Folder"),l=e.getTypeCollection("FolderMembership"),i=e.getTypeCollection("Task"),d=e.getTypeCollection("Workflow");return u.filter({id:r.id}).merge(function(e){return{subFolders:u.filter({parent:e("id")}).coerceTo("array"),entities:l.filter({folder:e("id")}).map(function(t){return e("type").eq("TASK").branch(i,d).filter({_temporal:{recordId:t("childId")}}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0).do(function(e){return{id:e("_temporal")("recordId"),branchId:e("id"),version:e("_temporal")("version"),name:e("name")}}))})}).filter(function(e){return e.eq(null).not()}).coerceTo("array")}}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0))}).run(a)}}function createParameter(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Parameter");if("WORKFLOW"===r.scope&&"ATTRIBUTE"!==r.class)throw new Error("Workflow parameters can only be of class ATTRIBUTE");return _.includes(["WORKFLOW","TASK"],r.scope)&&(r.mapsTo=null),r.entityType="PARAMETER",l.filter({parentId:r.parentId})("name").coerceTo("array").do(function(e){return a.branch(e.map(function(e){return e.downcase()}).contains(a.expr(r.name).downcase()),a.error("A parameter with the name "+r.name+" already exists on the current "+r.scope),l.insert(r,{returnChanges:!0})("changes").nth(0)("new_val"))}).run(u)}}function isParentPublished(e,t){var r=e.r,n=(e.connection,e.getTypeCollection("Parameter")),o=e.getTypeCollection("Workflow"),a=e.getTypeCollection("Step"),u=e.getTypeCollection("Task");return n.get(t).do(function(e){return r.branch(e.eq(null),r.error("Parameter does not exist"),r.branch(e("scope").eq("WORKFLOW"),o.get(e("parentId")),r.branch(e("scope").eq("TASK"),u.get(e("parentId")),a.get(e("parentId")))).do(function(e){return r.branch(e("_temporal")("version").ne(null),!0,!1)}))})}function updateParameter(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Parameter");return isParentPublished(e,r.id).branch(a.error("This parameter belongs to a published record and cannot be modified"),l.get(r.id).do(function(e){return a.branch(a.expr(["WORKFLOW","TASK"]).contains(e("scope")),l.get(r.id).update(_.omit(r,"id","mapsTo")).do(function(){return l.get(r.id)}),l.get(r.id).update(_.omit(r,"id")).do(function(){return l.get(r.id)}))})).run(u)}}function deleteParameter(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Parameter");return isParentPublished(e,r.id).branch(a.error("This parameter belongs to a published record and cannot be deleted"),l.get(r.id).delete().do(function(){return!0})).run(u)}}function createParameterRun(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Parameter"),i=e.getTypeCollection("ParameterRun");return l.get(r.parameter).eq(null).branch(a.error("Parameter "+r.parameter+" not found"),i.insert(r,{returnChanges:!0})("changes").nth(0)("new_val")).run(u)}}function updateParameterRun(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("ParameterRun");return l.get(r.id).eq(null).branch(a.error("ParameterRun not found"),l.get(r.id).update(_.omit(r,"id")).do(function(){return l.get(r.id)})).run(u)}}function deleteParameterRun(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("ParameterRun");return l.get(r.id).eq(null).branch(a.error("ParameterRun not found"),l.get(r.id).delete().do(function(){return!0})).run(u)}}function updateAttributeValues$1(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("ParameterRun"),i=e.getTypeCollection("Parameter");return a.expr(r.values).forEach(function(e){return l.get(e("id")).do(function(t){return t.eq(null).branch(a.error("ParameterRun not found"),i.get(t("parameter")).do(function(t){return t.eq(null).or(t("class").ne(ATTRIBUTE)).branch(a.error("Invalid Parameter type"),l.get(e("id")).update({value:e("value")}))}))})}).do(function(){return!0}).run(u)}}function isPublished(e,t,r){var n=e._r,o=e._db.table(e._tables[t].table);return o.get(r).do(function(e){return n.branch(e.eq(null),n.error(t+" does not exist"),n.branch(e("_temporal")("version").ne(null),!0,!1))})}function first(e){var t=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return e.coerceTo("array").do(function(e){return e.count().eq(0).branch(t,e.nth(0))})}function getWorkflowInputs(e,t,r){return e.filter({workflowId:r}).map(function(e){return t.filter({parentId:e("id"),class:INPUT$1}).filter(function(e){return e.hasFields("mapsTo").branch(e("mapsTo").eq(null).or(e("mapsTo").eq("")),!0)}).coerceTo("array")}).reduce(function(e,t){return e.union(t)})}function destroyStep(e,t){var r=e.r,n=(e.connection,e.getTypeCollection("Step")),o=e.getTypeCollection("Parameter");return t=_.isString(t)?[t]:t,n.filter(function(e){return r.expr(t).contains(e("id"))}).delete().do(function(){return o.filter(function(e){return r.expr(t).contains(e("parentId"))}).delete()}).do(function(){return!0})}function createStep(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Parameter"),i=e.getTypeCollection("Workflow"),d=this.globals._temporal,s=d.createTemporalStep,c=d.filterTemporalTask;if(_.includes(["START","END"],r.type))throw new graphql_error.GraphQLError("A "+r.type+" type can only be added during new workflow creation");if("TASK"===r.type&&!r.task)throw new graphql_error.GraphQLError("A step of type TASK must specifiy a published tasks recordId");return r.entityType="STEP",i.get(r.workflowId).eq(null).branch(a.error("Workflow "+r.workflowId+" does not exist"),a.expr(r.type).ne("TASK").branch(s(r)("changes").nth(0)("new_val"),c({recordId:r.task}).coerceTo("array").do(function(e){return e.count().eq(0).branch(a.error("The task specified does not have a current published version"),s(a.expr(r).merge({source:e.nth(0)("source")}))("changes").nth(0)("new_val"))}))).run(u).then(function(e){return"TASK"!==r.type?e:c({recordId:r.task}).nth(0)("id").do(function(t){return l.filter({parentId:t}).map(function(t){return t.merge({id:a.uuid(),scope:"STEP",parentId:e.id})}).forEach(function(e){return l.insert(e)}).do(function(){return e})}).run(u)})}}function readStepThreads(e){return function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=(arguments[1],arguments.length<=2||void 0===arguments[2]?{}:arguments[2],arguments[3],e.r,e.connection),n=e.getTypeCollection("Step");switch(t.type){case"FORK":return n.filter({fork:t.id}).run(r);default:return[]}}}function readStep(e){return function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=(arguments[3],e.r),a=e.connection,u=e.getTypeCollection("Step"),l=this.globals._temporal.filterTemporalStep;if(n.date=r.date||n.date,t.step)return u.get(t.step).run(a);var i=l(r);return t.id&&(i=u.filter({workflowId:t.id}),r.first&&(i=i.filter({type:"START"}).nth(0).do(function(e){return u.get(e("success")).count().eq(0).branch(o.expr([]),o.expr([u.get(e("success"))]))}))),i.coerceTo("array").run(a)}}function updateStep(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Step");return isPublished(e,"Step",r.id).branch(a.error("This step is published and cannot be modified"),l.get(r.id).update(_.omit(r,"id")).do(function(){return l.get(r.id)})).run(u)}}function deleteStep(e){return function(t,r,n,o){var a=e.r,u=e.connection;return isPublished(e,"Step",r.id).branch(a.error("This step is published and cannot be deleted"),destroyStep(e,r.id)).run(u)}}function readSource(e){return function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=(arguments[1],arguments.length<=2||void 0===arguments[2]?{}:arguments[2]),n=(arguments[3],e.r,e.connection),o=this.globals._temporal.filterTemporalTask,a=_.get(t,"task")||_.get(t,"task.id")||null;if(t.type!==TASK$1)return _.get(t,"source",null);var u=_.keys(t.versionArgs).length?t.versionArgs:_.merge(_.omit(r,["id","recordId"]),{recordId:a});return o(u).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0).hasFields("source").branch(e.nth(0)("source"),null))}).run(n)}}function readStepParams(e){return function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=(arguments[1],arguments.length<=2||void 0===arguments[2]?{}:arguments[2]),n=(arguments[3],e.r),o=e.connection,a=this.globals._temporal,u=a.filterTemporalWorkflow,l=a.filterTemporalTask,i=e.getTypeCollection("Parameter");return r=_.omit(r,["recordId","id"]),n.expr(t).do(function(e){return n.expr([WORKFLOW$1,TASK$1]).contains(e("type")).branch(e.hasFields("versionArgs").branch(e("versionArgs").keys().count().ne(0).branch(e("versionArgs"),n.expr(r)),n.expr(r)).do(function(t){return n.branch(e("type").eq(WORKFLOW$1).and(e.hasFields("subWorkflow")),u(t.merge({recordId:e("subWorkflow")})),e("type").eq(TASK$1).and(e.hasFields("task")),l(t.merge({recordId:e("task")})),n.error("Temporal relation missing reference")).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0)("id"))})}),e("id")).do(function(e){return i.filter({parentId:e}).coerceTo("array")})}).run(o)}}function newStepRun$1(e,t,r){var n=arguments.length<=3||void 0===arguments[3]||arguments[3],o=arguments.length<=4||void 0===arguments[4]||arguments[4],a=e.r,u=e.getTypeCollection("WorkflowRunThread"),l=e.getTypeCollection("Step"),i=e.getTypeCollection("StepRun"),d=e.getTypeCollection("ParameterRun"),s=e.getTypeCollection("Parameter"),c=e.getTypeCollection("WorkflowRun");return l.get(t.step).do(function(e){return e.eq(null).branch(a.error("Step does not exist"),r)}).do(function(e){return u.get(t.workflowRunThread).do(function(e){return e.eq(null).and(a.expr(o).eq(!0)).branch(a.error("Workflow Run Thread not found"),a.expr(t).hasFields("workflowRun").branch(a.expr(t)("workflowRun"),e("workflowRun")).do(function(e){return e.eq(null).branch(a.error("Unable to determine workflow run ID"),e)}))}).do(function(r){return c.get(r).do(function(o){return o.eq(null).branch(a.error("WorkflowRun not found"),s.filter({parentId:t.step,class:INPUT$2}).coerceTo("array").map(function(t){return{parameter:t("id"),parentId:e,value:t.hasFields("mapsTo").and(t("mapsTo").ne(null)).branch(d.filter({parentId:r,parameter:t("mapsTo")}).coerceTo("array").do(function(e){return e.count().gt(0).branch(e.nth(0)("value"),o("input").hasFields(t("name")).branch(o("input")(t("name")),t.hasFields("defaultValue").branch(t("defaultValue"),null)))}),o("input").hasFields(t("name")).branch(o("input")(t("name")),t.hasFields("defaultValue").branch(t("defaultValue"),null)))}}).do(function(e){return d.insert(e)}).do(function(){return i.insert({id:e,workflowRunThread:t.workflowRunThread,step:t.step,started:a.now(),status:CREATED$1,taskId:t.taskId},{returnChanges:n})}))})})})}function createStepRun(e){return function(t,r,n,o){var a=e.r,u=e.connection;return newStepRun$1(e,r,a.uuid())("changes").nth(0)("new_val").run(u)}}function startStepRun$1(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("StepRun");return r.started=a.now(),r.status=RUNNING$2,l.get(r.id).do(function(e){return e.eq(null).branch(a.error("StepRun not found"),e("status").ne(CREATED$1).branch(a.error("StepRun is not in a state that can be started"),l.get(r.id).update(_.omit(r,"id")).do(function(){return!0})))}).run(u)}}function setStepRunStatus$1(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("StepRun");return r.ended=a.now(),l.get(r.id).eq(null).branch(a.error("StepRun not found"),l.get(r.id).update(_.omit(r,"id")).do(function(){return!0})).run(u)}}function createForks(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("WorkflowRun"),i=e.getTypeCollection("WorkflowRunThread"),d=e.getTypeCollection("Step");return l.get(r.workflowRun).do(function(e){return e.eq(null).branch(a.error("Workflow run does not exist"),e)}).do(function(){return d.get(r.step).do(function(t){return t.eq(null).branch(a.error("Step does not exist"),t("type").ne(FORK).branch(a.error("Step is not a FORK"),d.filter({fork:t("id")}).coerceTo("array").map(function(e){return{threadId:a.uuid(),stepRunId:a.uuid(),step:e("id")}}).do(function(t){return t.forEach(function(t){return newStepRun$1(e,{workflowRun:r.workflowRun,step:t("step"),workflowRunThread:t("threadId")},t("stepRunId"),!1,!1)}).do(function(){return i.get(r.workflowRunThread).do(function(e){return e.eq(null).branch(a.error("Parent thread does not exist"),i.get(r.workflowRunThread).update({status:FORKED}))})}).do(function(){return t.map(function(e){return{id:e("threadId"),workflowRun:r.workflowRun,currentStepRun:e("stepRunId"),status:CREATED$1,parentThread:r.workflowRunThread}}).coerceTo("array").do(function(e){return i.insert(e,{returnChanges:!0})("changes")("new_val")})})})))})}).run(u)}}function getJoinThreads(e){return function(t,r,n,o){var a=(e.r,e.connection),u=e.getTypeCollection("WorkflowRunThread"),l=e.getTypeCollection("Step"),i=e.getTypeCollection("StepRun");return l.filter({join:r.step})("id").coerceTo("array").do(function(e){return u.filter({workflowRun:r.workflowRun}).merge(function(e){return{step:i.get(e("currentStepRun")).do(function(e){return l.get(e("step"))("id")})}}).filter(function(t){return e.contains(t("step"))}).coerceTo("array")}).run(a)}}function isNewId(e){return null!==e.match(/^new:/)}function mapIds(e,t,r){var n=arguments.length<=3||void 0===arguments[3]?"":arguments[3],o={recordId:r.get(n).eq(null).branch(t.uuid(),r.get(n)("_temporal")("recordId"))};return o[e.id]=isNewId(e.id)?{op:INSERT,id:t.uuid()}:{op:UPDATE,id:e.id},_.forEach(e.parameters,function(e){o[e.id]=isNewId(e.id)?{op:INSERT,id:t.uuid()}:{op:UPDATE,id:e.id}}),_.forEach(e.steps,function(e){o[e.id]=isNewId(e.id)?{op:INSERT,id:t.uuid()}:{op:UPDATE,id:e.id},_.forEach(e.parameters,function(e){o[e.id]=isNewId(e.id)?{op:INSERT,id:t.uuid()}:{op:UPDATE,id:e.id}})}),o}function getOp(e,t,r){var n,o=_.get(e,t,{}),a=o.op,u=o.id;return n={},defineProperty(n,r+"Id",u),defineProperty(n,r+"Op",a),n}function syncWorkflow(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Parameter"),i=e.getTypeCollection("Workflow"),d=e.getTypeCollection("Step"),s=e.getTypeCollection("Folder"),c=e.getTypeCollection("FolderMembership"),p=r.owner||null,f=function(e,t){return _.merge(e,{_temporal:{recordId:t,name:"initial",validFrom:null,validTo:null,version:null,owner:p,changeLog:[{type:"CREATE",user:p,message:"created workflow"}]}})};return a.expr(mapIds(r,a,i,r.id)).run(u).then(function(e){var t,n=!1,o=[],p=[],y=[],m={},T=(t={},defineProperty(t,INSERT,{workflow:{},parameter:{},step:{}}),defineProperty(t,UPDATE,{workflow:{},parameter:{},step:{}}),t),S=getOp(e,r.id,"wf"),g=S.wfId,w=S.wfOp,b={id:g,entityType:WORKFLOW$2};return m[g]=[],w===INSERT&&(n=!0,f(b,e.recordId)),_.set(T,'["'+w+'"].workflow["'+g+'"]',_.merge({},_.omit(r,["parameters","steps","_temporal.owner","_temporal.name"]),b)),_.forEach(r.parameters,function(t){var r=getOp(e,t.id,"param"),n=r.paramId,o=r.paramOp;m[g].push(n),_.set(T,'["'+o+'"].parameter["'+n+'"]',_.merge({},t,{id:n,parentId:g,scope:ParameterScopeEnum.ATTRIBUTE,entityType:PARAMETER}))}),_.forEach(r.steps,function(t){var r=getOp(e,t.id,"step"),n=r.stepId,o=r.stepOp;m[n]=[],y.push(n);var a={id:n,success:_.get(e,'["'+t.success+'"].id',null),fail:_.get(e,'["'+t.fail+'"].id',null),task:_.get(t,"task._temporal.recordId"),subWorkflow:_.get(t,"subWorkflow._temporal.recordId"),entityType:STEP,workflowId:g};o===INSERT&&f(a),_.set(T,'["'+o+'"].step["'+n+'"]',_.merge({},_.omit(t,["threads","parameters"]),a)),_.forEach(t.parameters,function(t){var r=getOp(e,t.id,"param"),o=r.paramId,a=r.paramOp;m[n].push(o),_.set(T,'["'+a+'"].parameter["'+o+'"]',_.merge({},t,{id:o,parentId:n,mapsTo:_.get(e,'["'+t.mapsTo+'"].id',null),scope:ParameterScopeEnum.STEP,entityType:PARAMETER}))})}),_.forEach(r.steps,function(t){var r=getOp(e,t.id,"step"),n=r.stepId;t.threads.length&&p.push(n),_.forEach(t.threads,function(t){var r=getOp(e,t.id,"thread"),o=r.threadId;if(o){var a=_.get(T[INSERT].step,o)||_.get(T[UPDATE].step,o);a&&(a.fork=n)}})}),_.forEach(r.steps,function(t){var r=getOp(e,t.id,"step"),n=r.stepId,o=_.get(T[INSERT].step,n)||_.get(T[UPDATE].step,n);o.fork=_.includes(p,o.fork)?o.fork:null}),_.forEach(T,function(e,t){_.forEach(e,function(e,r){_.forEach(e,function(e,n){o.push({id:n,op:t,collection:r,data:e})})})}),a.expr(o).forEach(function(e){return e("op").eq(INSERT).branch(a.branch(e("collection").eq("workflow"),i.insert(e("data")),e("collection").eq("step"),d.insert(e("data")),l.insert(e("data"))),a.branch(e("collection").eq("workflow"),i.get(e("id")).update(e("data")),e("collection").eq("step"),d.get(e("id")).update(e("data")),l.get(e("id")).update(e("data"))))}).do(function(){return s.get(r.folder||"").ne(null).branch(a.expr(n).branch(c.insert({folder:r.folder,childId:e.recordId,childType:FolderType.WORKFLOW}),c.get(e.recordId).update({folder:r.folder})),s.filter({type:FolderType.WORKFLOW,parent:FolderType.ROOT}).nth(0).do(function(t){return a.expr(n).branch(c.insert({folder:t("id"),childId:e.recordId,childType:FolderType.WORKFLOW}),c.get(e.recordId).update({folder:t("id")}))}))}).do(function(){return d.filter({workflowId:g}).filter(function(e){return a.expr(y).contains(e("id")).not()}).forEach(function(e){return l.filter({parentId:e("id")}).delete().do(function(){return d.get(e("id")).delete()})})}).do(function(){var e=_.map(m,function(e,t){return{parentId:t,parameters:e}});return a.expr(e).forEach(function(e){return l.filter({parentId:e("parentId")}).filter(function(t){return e("parameters").contains(t("id")).not()}).delete()})}).do(function(){return i.get(g)}).run(u)})}}function isNewId$1(e){return null!==e.match(/^new:/)}function mapIds$1(e,t,r){var n=arguments.length<=3||void 0===arguments[3]?"":arguments[3],o={recordId:r.get(n).eq(null).branch(t.uuid(),r.get(n)("_temporal")("recordId"))};return o[e.id]=isNewId$1(e.id)?{op:INSERT$1,id:t.uuid()}:{op:UPDATE$1,id:e.id},_.forEach(e.parameters,function(e){o[e.id]=isNewId$1(e.id)?{op:INSERT$1,id:t.uuid()}:{op:UPDATE$1,id:e.id}}),o}function getOp$1(e,t,r){var n,o=_.get(e,t,{}),a=o.op,u=o.id;return n={},defineProperty(n,r+"Id",u),defineProperty(n,r+"Op",a),n}function syncTask(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Task"),i=e.getTypeCollection("Parameter"),d=e.getTypeCollection("Folder"),s=e.getTypeCollection("FolderMembership"),c=r.owner||null,p=function(e,t){return _.merge(e,{_temporal:{recordId:t,name:"initial",validFrom:null,validTo:null,version:null,owner:c,changeLog:[{type:"CREATE",user:c,message:"created workflow"}]}})};return a.expr(mapIds$1(r,a,l,r.id)).run(u).then(function(e){var t,n=!1,o=[],c=[],f=(t={},defineProperty(t,INSERT$1,{task:{},parameter:{}}),defineProperty(t,UPDATE$1,{task:{},parameter:{}}),t),y=getOp$1(e,r.id,"task"),m=y.taskId,T=y.taskOp,S={id:m,entityType:TASK$2};return T===INSERT$1&&(n=!0,p(S,e.recordId)),_.set(f,'["'+T+'"].task["'+m+'"]',_.merge({},_.omit(r,["parameters","steps","_temporal.owner","_temporal.name"]),S)),_.forEach(r.parameters,function(t){var r=getOp$1(e,t.id,"param"),n=r.paramId,o=r.paramOp;c.push(n),_.set(f,'["'+o+'"].parameter["'+n+'"]',_.merge({},t,{id:n,parentId:m,scope:ParameterScopeEnum.TASK,entityType:PARAMETER$1}))}),_.forEach(f,function(e,t){_.forEach(e,function(e,r){_.forEach(e,function(e,n){o.push({id:n,op:t,collection:r,data:e})})})}),a.expr(o).forEach(function(e){return e("op").eq(INSERT$1).branch(a.branch(e("collection").eq("task"),l.insert(e("data")),i.insert(e("data"))),a.branch(e("collection").eq("task"),l.get(e("id")).update(e("data")),i.get(e("id")).update(e("data"))))}).do(function(){return d.get(r.folder||"").ne(null).branch(a.expr(n).branch(s.insert({folder:r.folder,childId:e.recordId,childType:FolderType$1.TASK}),s.get(e.recordId).update({folder:r.folder})),d.filter({type:FolderType$1.TASK,parent:FolderType$1.ROOT}).nth(0).do(function(t){return a.expr(n).branch(s.insert({folder:t("id"),childId:e.recordId,childType:FolderType$1.TASK}),s.get(e.recordId).update({folder:t("id")}))}))}).do(function(){return i.filter({parentId:m}).filter(function(e){return a.expr(c).contains(e("id")).not()}).delete()}).do(function(){return l.get(m)}).run(u)})}}function createTask(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Task"),i=this.globals._temporal.createTemporalTask;return r.entityType="TASK",l.filter(function(e){return e("name").match("(?i)^"+r.name+"$")}).count().ne(0).branch(a.error("A task with the name "+r.name+" already exists"),i(r)("changes").nth(0)("new_val")).run(u)}}function readTask(e){return function(t,r){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=(arguments[3],e.r),a=e.connection,u=_.get(t,"task")||_.get(t,"task.id"),l=this.globals._temporal,i=l.filterTemporalTask,d=l.mostCurrentTemporalTask;n.date=r.date||n.date;var s=o.expr(null);if(t)u&&(s=i({recordId:u,date:n.date}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0))}));else{if(!_.keys(r).length)return d().run(a);s=i(r)}return s.run(a)}}function readTaskVersions(e){return function(t,r){
var n=(arguments.length<=2||void 0===arguments[2]?{}:arguments[2],arguments[3],e.r,e.connection),o=e.getTypeCollection("Task"),a=o.filter({_temporal:{recordId:r.recordId}});return r.offset&&(a=a.skip(r.offset)),r.limit&&(a=a.limit(r.limit)),a.run(n)}}function updateTask(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Task");return isPublished(e,"Task",r.id).branch(a.error("This task is published and cannot be modified"),l.get(r.id).update(_.omit(r,"id")).do(function(){return l.get(r.id)})).run(u)}}function deleteTask(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Task"),i=e.getTypeCollection("Parameter"),d=e.getTypeCollection("Step");return isPublished(e,"Task",r.id).branch(a.error("This task is published and cannot be deleted"),d.filter(function(e){return e("task").eq(r.id).and(e("_temporal")("version").ne(null))}).count().ne(0).branch(a.error("This task belongs to a published step and cannot be deleted"),l.get(r.id).delete().do(function(){return i.filter({parentId:r.id}).delete().do(function(){return!0})}))).run(u)}}function getFullWorkflow(e,t){var r=e.r,n=(e.connection,e.getTypeCollection("Workflow")),o=e.getTypeCollection("Parameter"),a=e.getTypeCollection("Step");return n.get(t.id).eq(null).branch(r.error("Invalid workflow version"),n.get(t.id).merge(function(e){return{parameters:o.filter({parentId:t.id}).coerceTo("array"),steps:a.filter({workflowId:e("id")}).coerceTo("array").merge(function(e){return{parameters:o.filter({parentId:e("id")}).coerceTo("array")}})}}))}function getNewUuids(e,t,r){var n="fork"===e?["FORKID"]:[];return n.push(r.id),_.forEach(r.parameters,function(e){return n.push(e.id)}),_.forEach(r.steps,function(e){n.push(e.id),_.forEach(e.parameters,function(e){return n.push(e.id)})}),t.expr(n).map(function(e){return{orig:e,cur:t.uuid()}})}function remapObjects(e,t){var r=[],n=[],o=_.merge({},_.omit(e,["steps","parameters"]));return t.FORKID&&(o._temporal.recordId=t.FORKID),o._temporal.version=null,o._temporal.validFrom=null,o._temporal.validTo=null,o._temporal.changeLog=_.isArray(e._temporal.changeLog)?e._temporal.changeLog:[],o.id=t[e.id],_.forEach(e.parameters,function(e){n.push(_.merge({},e,{id:t[e.id],parentId:t[e.parentId]}))}),_.forEach(e.steps,function(e){var o=_.merge({},e);o._temporal.version=null,o._temporal.validFrom=null,o._temporal.validTo=null,o.id=_.get(t,e.id,null),o.workflowId=_.get(t,e.workflowId,null),o.success=_.get(t,e.success,null),o.fork=_.get(t,e.fork,null),o.fail=_.get(t,e.fail,null),r.push(o),_.forEach(e.parameters,function(e){n.push(_.merge({},e,{id:t[e.id],parentId:t[e.parentId]}))})}),{newWorkflow:o,newParams:n,newSteps:r}}function cloneWorkflow(e,t,r){var n=t.r,o=t.connection,a=t.getTypeCollection("Workflow"),u=t.getTypeCollection("Parameter"),l=t.getTypeCollection("Step"),i={};return getFullWorkflow(t,r).run(o).then(function(t){return getNewUuids(e,n,t).run(o).then(function(d){_.forEach(d,function(e){return i[e.orig]=e.cur});var s=remapObjects(t,i,r),c=s.newWorkflow,p=s.newSteps,f=s.newParams;return c._temporal.name=r.name||c.id,c._temporal.owner=r.owner||null,c._temporal.changeLog.push(_.merge(r.changeLog||{user:"SYSTEM",message:e},{date:n.now(),type:"branch"===e?"BRANCH":"FORK"})),n.expr([u.insert(f),l.insert(p)]).do(function(){return a.insert(c,{returnChanges:!0})("changes").nth(0)("new_val")}).run(o)})})}function branchWorkflow(e){return function(t,r,n,o){return cloneWorkflow("branch",e,r)}}function forkWorkflow(e){return function(t,r,n,o){return cloneWorkflow("fork",e,r)}}function publishWorkflow(e){return function(t,r,n,o){var a=(e.r,e.connection),u=e.getTypeCollection("Step"),l=e.getTypeComputed("Workflow").collection,i=this.globals._temporal.extendPublish;return i(l,r).then(function(e){var t=e._temporal,r=t.version,n=t.validFrom,o=t.validTo,l=e.id;return u.filter({workflowId:l}).update({_temporal:{version:r,validFrom:n,validTo:o}}).run(a).then(function(){return e})})}}function readWorkflowInputs(e){return function(t,r){var n=(arguments.length<=2||void 0===arguments[2]?{}:arguments[2],arguments[3],e.r,e.connection),o=e.getTypeCollection("Parameter"),a=e.getTypeCollection("Step");return getWorkflowInputs(a,o,t.id).run(n)}}function createWorkflow(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=this.globals._temporal,i=l.createTemporalWorkflow,d=l.createTemporalStep;return a.do(a.uuid(),a.uuid(),a.uuid(),function(e,t,n){return r.id=e,r.entityType="WORKFLOW",d([{id:t,entityType:"STEP",name:"Start",description:"Starting point of the workflow",type:"START",timeout:0,failsWorkflow:!1,waitOnSuccess:!1,requireResumeKey:!1,success:n,fail:n,workflowId:e},{id:n,entityType:"STEP",name:"End",description:"Ending point of the workflow",type:"END",timeout:0,failsWorkflow:!1,waitOnSuccess:!1,requireResumeKey:!1,success:n,fail:n,workflowId:e}]).do(function(){return i(r)("changes").nth(0)("new_val")})}).run(u)}}function readWorkflow(e){return function(t,r){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=(arguments[3],e.r),a=e.connection,u=e.getTypeCollection("Workflow"),l=this.globals._temporal,i=l.filterTemporalWorkflow,d=l.mostCurrentTemporalWorkflow;n.date=r.date||n.date;var s=o.expr(null);if(_.isEmpty(t)){if(!_.keys(r).length)return d().run(a);s=i(r)}else{if(t.workflow)return u.get(t.workflow).run(a);t.subWorkflow&&(s=i({recordId:t.subWorkflow,date:n.date}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0))}))}return s.run(a)}}function readWorkflowVersions(e){return function(t,r){var n=(arguments.length<=2||void 0===arguments[2]?{}:arguments[2],arguments[3],e.r,e.connection),o=e.getTypeCollection("Workflow"),a=o.filter({_temporal:{recordId:r.recordId}});return r.offset&&(a=a.skip(r.offset)),r.limit&&(a=a.limit(r.limit)),a.run(n)}}function updateWorkflow(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Workflow");return isPublished(e,"Workflow",r.id).branch(a.error("This workflow is published and cannot be modified"),l.get(r.id).update(_.omit(r,"id")).do(function(){return l.get(r.id)})).run(u)}}function deleteWorkflow(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("Workflow"),i=e.getTypeCollection("Parameter"),d=e.getTypeCollection("Step");return isPublished(e,"Workflow",r.id).branch(a.error("This workflow is published and cannot be deleted"),d.filter({workflowId:r.id}).map(function(e){return e("id")}).coerceTo("array").do(function(t){return destroyStep(e,t)}).do(function(){return i.filter({parentId:r.id}).delete()}).do(function(){return l.get(r.id).delete().do(function(){return!0})})).run(u)}}function readWorkflowParameters(e){return function(t,r,n,o){var a=(e.r,e.connection),u=e.getTypeCollection("Parameter");return u.filter({parentId:t.id,class:ATTRIBUTE$1}).run(a)}}function readEndStep(e){return function(t,r,n,o){var a=(e.r,e.connection),u=e.getTypeCollection("Step");return u.filter({workflowId:t.id,type:END$1}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0))}).run(a)}}function firstStep(e,t,r){return first(t.filter({workflowId:r,type:START}),e.error("no start step found")).do(function(r){return t.get(r("success")).do(function(t){return e.branch(t.eq(null),e.error("no first step found, make sure all steps have connections"),t("type").eq(END$2),e.error("start is directly connected to end and cannot determine the first step task"),t)})})}function createWorkflowRun(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("WorkflowRun"),i=e.getTypeCollection("Parameter"),d=e.getTypeCollection("ParameterRun"),s=e.getTypeCollection("Step"),c=e.getTypeCollection("StepRun"),p=e.getTypeCollection("WorkflowRunThread"),f=this.globals._temporal.filterTemporalWorkflow,y=_.isObject(r.input)?r.input:{};return first(f(r.args),a.error("wokflow not found")).merge(function(e){return{inputs:getWorkflowInputs(s,i,e("id")).coerceTo("array"),parameters:i.filter({parentId:e("id"),class:ATTRIBUTE$2}).coerceTo("array"),step:firstStep(a,s,e("id")).merge(function(e){return{subWorkflow:e.hasFields("subWorkflow").branch(first(f(a.expr(r).merge(function(){return{recordId:e("_temporal")("recordId")}},e.hasFields("versionArgs").branch(e("versionArgs"),{}))),null),null),parameters:i.filter({parentId:e("id")}).coerceTo("array")}})}}).run(u).then(function(e){var t=!0,n=!1,o=void 0;try{for(var i,s=e.inputs[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var f=i.value;if(f.required&&!_.has(y,f.name))throw new Error("missing required input "+f.name);_.has(y,f.name)&&(y[f.name]=convertType(f.type,f.name,y[f.name]))}}catch(e){n=!0,o=e}finally{try{!t&&s.return&&s.return()}finally{if(n)throw o}}return a.do(a.now(),a.uuid(),a.uuid(),a.uuid(),function(t,n,o,a){return l.insert({id:n,workflow:e.id,args:r.args,input:y,started:t,status:"RUNNING",taskId:r.taskId,parentStepRun:r.parent},{returnChanges:!0})("changes").nth(0)("new_val").do(function(t){return p.insert({id:a,workflowRun:n,currentStepRun:o,status:"CREATED"}).do(function(){return _.isArray(e.parameters)&&e.parameters.length?d.insert(_.map(e.parameters,function(e){return{parameter:e.id,parentId:n,class:e.class,value:_.get(e,"defaultValue")}})):null}).do(function(){return c.insert({id:o,workflowRunThread:a,step:e.step.id,status:"CREATED",taskId:r.taskId})}).do(function(){if(!e.step.parameters.length)return null;var t=[];return _.forEach(e.step.parameters,function(r){var n=null;if(r.mapsTo)n=_.get(_.find(e.parameters,{id:r.mapsTo}),"defaultValue");else if(!r.mapsTo&&_.has(y,r.name))try{n=convertType(r.type,r.name,_.get(y,r.name))}catch(e){}t.push({parameter:r.id,parentId:o,class:r.class,value:n})}),d.insert(t)}).do(function(){return t})})}).run(u)})}}function updateWorkflowRun(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("WorkflowRun");return l.get(r.id).eq(null).branch(a.error("WorkflowRun not found"),l.get(r.id).update(_.omit(r,"id")).do(function(){return l.get(r.id)})).run(u)}}function deleteWorkflowRun(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("WorkflowRun");return l.get(r.id).eq(null).branch(a.error("WorkflowRun not found"),l.get(r.id).delete().do(function(){return!0})).run(u)}}function endWorkflowRun$1(e){return function(t,r,n,o){var a=e.r,u=e.connection,l=e.getTypeCollection("WorkflowRun");return r.ended=a.now(),l.get(r.id).eq(null).branch(a.error("WorkflowRun not found"),l.get(r.id).update(_.omit(r,"id")).do(function(){return!0})).run(u)}}function readWorkflowRunThread(e){return function(t,r,n,o){var a=(e.r,e.connection),u=e.getTypeCollection("WorkflowRunThread");return t&&t.workflowRunThread?u.get(t.workflowRunThread).run(a):_.isArray(o.path)&&o.path.join(".").match(/threads$/)&&t&&t.id?u.filter({workflowRun:t.id}).run(a):r.id?u.filter({id:r.id}).run(a):u.run(a)}}function endWorkflow(e,t){var r=this;try{var n=function(){var n=e.workflowRun,o=e.thread,a=[],u=[];return{v:updateWorkflowRunThread(r,{id:o,status:"Enum::"+ENDING$1},function(l){return l?t(l):getRunThreads(r,n,function(n,l){return n?t(n):(_.forEach(l,function(e){_.includes(RUNNING_STATES$1,e.status)?u.push(e.id):e.status===ENDING$1&&a.push(e.id)}),u.length||!winTieBreak(o,a)?updateWorkflowRunThread(r,{id:o,status:"Enum::"+JOINED$2},function(e){return e?t(e):t()}):computeWorkflowStatus.call(r,e,t))})})}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){this.log.error({errors:e.message||e,stack:e.stack},"Failed to end workflow"),t(e)}}function handleContext(e,t){var r=this;return function(n){try{var o=function(){var o=[],a=(e.runner,e.workflowRun),u=e.thread,l=e.endStep,i=(e.localCtx,e.context),d=(e.args,e.step),s=e.stepRunId,c=d.async,p=(d.source,d.timeout,d.failsWorkflow,d.waitOnSuccess,d.success),f=d.fail,y=d.parameters;f=f||l;var m=n._exception||n._result===!1,T=m?f:p,S=m?FAIL$1:SUCCESS$2;switch(d.type){case CONDITION$1:S=SUCCESS$2;break;case LOOP$2:S=SUCCESS$2}return _.forEach(y,function(e){if(e.class===OUTPUT$1&&_.has(n,e.name)&&_.has(e,"mapsTo"))try{var t=_.find(i,{parameter:{id:e.mapsTo,class:ATTRIBUTE$3}});if(!t)return;o.push({id:t.id,value:convertType(e.type,e.name,_.get(n,e.name))})}catch(e){r.log.warn({error:e},"type conversion failed so value will not be set")}}),{v:updateAttributeValues(r,o,function(n){return n?t(n):d.waitOnSuccess&&S===SUCCESS$2?setStepRunStatus(r,s,WAITING$1,function(e){if(e)return t(e)}):setStepRunStatus(r,s,S,function(n){return n?t(n):T===l?endWorkflow.call(r,e,t):c?t():nextStepRun.call(r,{thread:u,workflowRun:a,nextStep:T,async:c},t)})})}}();if("object"===("undefined"==typeof o?"undefined":_typeof(o)))return o.v}catch(e){r.log.error({errors:e.message||e,stack:e.stack},"Failed to handle context"),t(e)}}}function basicRun(e){var t=this,r=e.source,n=e.context,o=e.timeout,a=e.payload,u=e.done,l=_.merge({context:n,timeout:o},_.get(this.options,"vm",{}));return sbx.vm(r,l,function(e,r){return e?u(e):handleContext.call(t,a,u)(r)})}function loopRun(e){var t=this,r=arguments.length<=1||void 0===arguments[1]?0:arguments[1],n=e.source,o=e.context,a=e.timeout,u=e.payload,l=e.done,i=_.merge({context:o,timeout:a},_.get(this.options,"vm",{}));return o.loop=r,sbx.vm(n,i,function(e,o){return e?l(e):o._result===!1||o._exception?handleContext.call(t,u,l)(o):loopRun.call(t,{source:n,context:o,timeout:a,payload:u,done:l},r++)})}function runSource(e,t){var r=this;try{var n=function(){var n=e.thread,o=e.endStep,a=e.localCtx,u=e.step,l=e.workflowRun,i=u.async,d=u.source,s=u.timeout,c=u.success;return d?{v:updateWorkflowRunThread(r,{id:n,status:"Enum::"+RUNNING$3},function(p){if(p)return t(p);var f={source:d,context:a,timeout:s,payload:e,done:t},y=u.type===LOOP$1?loopRun.call(r,f):basicRun.call(r,f);return i&&c!==o?nextStepRun.call(r,{thread:n,workflowRun:l,nextStep:c,async:i},t):y})}:{v:t(new Error("No source"))}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){this.log.error({errors:e.message||e,stack:e.stack},"Failed to run source step"),t(e)}}function forkSteps(e,t){var r=this;try{var n=function(){var n=e.workflowRun,o=e.thread,a=e.stepRunId,u=e.step.id,l=_.get(r,"server._emitter");return l?{v:newForks(r,u,n,o,function(e,o){return e?t(e):setStepRunStatus(r,a,FORKED$1,function(e){return e?t(e):(_.forEach(o,function(e){l.emit("schedule",{payload:{action:"runStep",context:{thread:e.id,workflowRun:n}}})}),t())})})}:{v:t(new Error("no event emitter"))}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){this.log.error({errors:e.message||e,stack:e.stack},"Failed to fork step"),t(e)}}function runSubWorkflow(e,t){var r=this;try{var n=function(){var n=e.runner,o=e.taskId,a=e.thread,u=e.localCtx,l=e.args,i=e.step,d=e.stepRunId,s=i.subWorkflow;return{v:updateWorkflowRunThread(r,{id:a,status:"Enum::"+RUNNING$5},function(e){return e?t(e):startWorkflow(r)(n,{id:o,context:{args:{recordId:_.get(s,"_temporal.recordId"),date:l.date,version:l.version},input:u,parent:d}},function(e){if(e)return t(e)})})}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){return this.log.error({errors:e.message||e,stack:e.stack},"Failed to run sub workflow"),t(e)}}function runStep(e){return function(t,r,n){try{var o=function(){var o=r.resume,a=r.context,u=a.workflowRun,l=a.thread,i=r.id,d=_.get(r,"data.context",{});return u&&l?{v:getWorkflowRun(e,u,l,function(a,s){if(a)return n(a);var c=s.workflow,p=s.args,f=s.input,y=s.context,m=s.threads,T=_.get(m,"[0].currentStepRun.step"),S=_.get(m,"[0].currentStepRun.id"),g=_.get(c,"endStep.id");if(!T)return n(new Error("No step found in thread"));if(!g)return n(new Error("No end step found"));e.log.trace({step:T.id,type:T.type},"successfully read step");var w=mapInput(f,y,_.get(T,"parameters",[]));w._resumeKey=S,w._taskId=i;var b={runner:t,task:r,taskId:i,workflowRun:u,thread:l,endStep:g,localCtx:w,context:y,args:p,step:T,stepRunId:S};return o?handleContext.call(e,b,n)(d):startStepRun(e,S,i,function(t){if(t)return n(t);switch(T.type){case BASIC$1:return runSource.call(e,b,n);case TASK$4:return runSource.call(e,b,n);case LOOP:return runSource.call(e,b,n);case CONDITION:return runSource.call(e,b,n);case JOIN$1:return joinThreads.call(e,b,n);case WORKFLOW$4:return runSubWorkflow.call(e,b,n);case FORK$1:return forkSteps.call(e,b,n);default:return n(new Error("Invalid step type or action cannot be performed on type"))}})})}:{v:n(new Error("No workflow run or main thread created"))}}();if("object"===("undefined"==typeof o?"undefined":_typeof(o)))return o.v}catch(t){return e.log.error({errors:t.message||t,stack:t.stack},"Failed to start step"),n(t)}}}function startWorkflow(e){return function(t,r,n){try{var o=function(){var o=r.context,a=o.args,u=o.input,l=o.parent,i=r.id;return a?{v:newWorkflowRun(e,{args:a,input:u,taskId:i,parent:l},function(r,o){if(r)return n(r);var a=_.get(o,"id"),u=_.get(o,"threads[0].id");return runStep(e)(t,{id:i,context:{workflowRun:a,thread:u}},n)})}:{v:n(new Error("No arguments were supplied"))}}();if("object"===("undefined"==typeof o?"undefined":_typeof(o)))return o.v}catch(t){return e.log.error({errors:t.message||t,stack:t.stack},"Failed to start workflow"),n(t)}}}function actions(e){return{startWorkflow:startWorkflow(e),runStep:runStep(e)}}function rethinkdb$1(e,t,r,n,o){return new S2fRethinkDBBackend(e,t,r,n,o)}Object.defineProperty(exports,"__esModule",{value:!0});var _=_interopDefault(require("lodash")),chalk=require("chalk"),yellowjacket=require("yellowjacket"),FactoryTemporalPlugin=_interopDefault(require("graphql-factory-temporal")),graphqlFactoryTemporal_backend=require("graphql-factory-temporal/backend"),obj2arg=_interopDefault(require("graphql-obj2arg")),graphql_error=require("graphql/error"),sbx=_interopDefault(require("sbx")),S2FDescribed={description:{type:"String"}},S2FEntity={id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"}},S2FNamed={name:{type:"String"}},fields={S2FDescribed:S2FDescribed,S2FEntity:S2FEntity,S2FNamed:S2FNamed},EntitySummary={fields:{id:"String",branchId:"String",version:"String",name:"String",description:"String"}},EntityTypeEnum={type:"Enum",values:{PARAMETER:"PARAMETER",PARAMETERRUN:"PARAMETERRUN",STEP:"STEP",STEPRUN:"STEPRUN",TASK:"TASK",WORKFLOW:"WORKFLOW",WORKFLOWRUN:"WORKFLOWRUN",RUNQUEUE:"RUNQUEUE",FOLDER:"FOLDER"}},Folder={fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String",nullable:!1},parent:{type:"String",nullable:!1},type:{type:"FolderChildTypeEnum",nullable:!1}},_backend:{schema:"S2FWorkflow",collection:"folder",query:{readRootFolder:{type:"FolderView",args:{type:{type:"FolderChildTypeEnum",nullable:!1}},resolve:"readRootFolder"},readSubFolder:{type:"FolderView",args:{id:{type:"String",nullable:!1}},resolve:"readSubFolder"}}}},FolderChildTypeEnum={type:"Enum",values:{ROOT:"ROOT",WORKFLOW:"WORKFLOW",TASK:"TASK"}},FolderMembership={fields:{childId:{type:"String",primary:!0},folder:{type:"String"},childType:{type:"FolderChildTypeEnum"}},_backend:{schema:"S2FWorkflow",collection:"folder_membership"}},FolderView={fields:{id:"String",name:"String",parent:"String",type:"FolderChildTypeEnum",subFolders:["Folder"],entities:["EntitySummary"]}},Parameter={type:["Object","Input"],fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String"},description:{type:"String"},type:{description:"The data type of the parameter",type:"ParameterTypeEnum",nullable:!1},scope:{description:"The scope of the parameter",type:"ParameterScopeEnum",nullable:!1,omitFrom:"Input"},class:{description:"Class of parameter",type:"ParameterClassEnum"},required:{description:"Parameter is required",type:"Boolean",nullable:!1},mapsTo:{description:"Name of global context parameter to map",type:"String"},defaultValue:{description:"Default value",type:"String"},parentId:{description:"Object the parameter belongs to",type:"String",belongsTo:{Workflow:{parameters:"id"},Step:{parameters:"id"},Task:{parameters:"id"}}}},_backend:{schema:"S2FWorkflow",collection:"parameter",mutation:{create:{resolve:"createParameter"},update:{resolve:"updateParameter"},delete:{resolve:"deleteParameter"}}}},ParameterClassEnum={type:"Enum",values:{ATTRIBUTE:"ATTRIBUTE",INPUT:"INPUT",OUTPUT:"OUTPUT"}},ParameterRun={fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},parameter:{type:"Parameter",has:"id"},parentId:{type:"String",belongsTo:{WorkflowRun:{context:"id"},StepRun:{context:"id"}}},value:{type:"FactoryJSON"}},_backend:{schema:"S2FWorkflow",collection:"parameter_run",mutation:{create:{type:"ParameterRun",args:{parameter:{type:"String",nullable:!1},parentId:{type:"String",nullable:!1},value:{type:"FactoryJSON"}},resolve:"createParameterRun"},update:{type:"ParameterRun",args:{id:{type:"String",nullable:!1},value:{type:"FactoryJSON"}},resolve:"updateParameterRun"},delete:{args:{id:{type:"String",nullable:!1}},resolve:"deleteParameterRun"},updateAttributeValues:{type:"Boolean",args:{values:{type:["ParameterRunValueInput"],nullable:!1}},resolve:"updateAttributeValues"}}}},ParameterRunValueInput={type:"Input",fields:{id:{type:"String"},value:{type:"FactoryJSON"}}},ParameterTypeEnum={type:"Enum",values:{ARRAY:"ARRAY",BOOLEAN:"BOOLEAN",DATE:"DATE",NUMBER:"NUMBER",OBJECT:"OBJECT",STRING:"STRING",PASSWORD:"PASSWORD"}},ParameterScopeEnum={type:"Enum",values:{WORKFLOW:"WORKFLOW",STEP:"STEP",TASK:"TASK"}},RunStatusEnum={type:"Enum",values:{CREATED:"CREATED",RUNNING:"RUNNING",WAITING:"WAITING",JOINING:"JOINING",FORKING:"FORKING",SUCCESS:"SUCCESS",FAIL:"FAIL",FORKED:"FORKED",JOINED:"JOINED",ENDING:"ENDING",ENDED:"ENDED"}},Step={extendFields:["TemporalType"],fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String"},description:{type:"String"},workflowId:{description:"Workflow the step belongs to",type:"String",nullable:!1,belongsTo:{Workflow:{steps:"id"}}},type:{description:"Step type (condition, loop, fork, join, workflow, task, etc...)",type:"StepTypeEnum",nullable:!1},async:{description:"Step runs asynchronously",type:"Boolean"},source:{description:"Source code to run. Can be null if a task or subworkflow is being used",type:"String",resolve:"readSource"},task:{description:"Published task to use as source for execution code",type:"Task",has:"id",resolve:"readTask"},subWorkflow:{description:"Nested workflow to run",type:"Workflow",has:"id",resolve:"readWorkflow"},versionArgs:{description:"Lock a task or subworkflow into a specific version",type:"FactoryJSON"},timeout:{description:"Time in ms to allow the step to run before timing out",type:"Int"},failsWorkflow:{description:"If true and this step fails, the workflow will be considered failed",type:"Boolean",nullable:!1},waitOnSuccess:{description:"On successful step completion wait for external input to resume",type:"Boolean",nullable:!1},requireResumeKey:{description:"Used with waitOnSuccess. The StepRun key is required to initiate a workflow resume",type:"Boolean",nullable:!1},success:{description:"Step to execute on success",type:"String"},fail:{description:"Step to execute on failure, defaults to end",type:"String"},parameters:{description:"Local parameters associated with the step",type:["Parameter"],resolve:"readParameter"},fork:{type:"String",belongsTo:{Step:{threads:"id"}}},threads:{description:"Keeps track of the forked threads for a fork or the threads that will join if a join",type:["Step"],resolve:"readStepThreads"},ex:{description:"Extension data, can be used by plugins for example ui positioning information",type:"FactoryJSON"}},_backend:{schema:"S2FWorkflow",collection:"step",temporal:!0,query:{read:{resolve:"readStep"}},mutation:{create:{type:"Step",args:{workflowId:{type:"String",nullable:!1},name:{type:"String",nullable:!1},type:{type:"StepTypeEnum",nullable:!1},async:{type:"Boolean",defaultValue:!1},source:{type:"String"},task:{type:"String"},subWorkflow:{type:"String"},timeout:{type:"Int",defaultValue:0},failsWorkflow:{type:"Boolean",defaultValue:!1},waitOnSuccess:{type:"Boolean",defaultValue:!1},requireResumeKey:{type:"Boolean",defaultValue:!1},success:{type:"String"},fail:{type:"String"}},resolve:"createStep"},update:{type:"Step",args:{id:{type:"String",nullable:!1},name:{type:"String"},async:{type:"Boolean"},source:{type:"String"},task:{type:"String"},subWorkflow:{type:"String"},timeout:{type:"Int"},failsWorkflow:{type:"Boolean"},waitOnSuccess:{type:"Boolean"},requireResumeKey:{type:"Boolean"},success:{type:"String"},fail:{type:"String"}},resolve:"updateStep"},delete:{type:"Boolean",args:{id:{type:"String",nullable:!1}},resolve:"deleteStep"}}}},StepInput={type:"Input",fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String"},description:{type:"String"},type:{description:"Step type (condition, loop, fork, join, workflow, task, etc...)",type:"StepTypeEnum",nullable:!1},async:{description:"Step runs asynchronously",type:"Boolean"},source:{description:"Source code to run. Can be null if a task or subworkflow is being used",type:"String"},subWorkflow:{description:"Nested workflow to run",type:"String"},timeout:{description:"Time in ms to allow the step to run before timing out",type:"Int",nullable:!1},failsWorkflow:{description:"If true and this step fails, the workflow will be considered failed",type:"Boolean",nullable:!1},waitOnSuccess:{description:"On successful step completion wait for external input to resume",type:"Boolean",nullable:!1},requireResumeKey:{description:"Used with waitOnSuccess. The StepRun key is required to initiate a workflow resume",type:"Boolean",nullable:!1},success:{description:"Step to execute on success",type:"String"},fail:{description:"Step to execute on failure, defaults to end",type:"String"},parameters:{type:["ParameterInput"]}}},StepRun={fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},workflowRunThread:{type:"String",belongsTo:{WorkflowRunThread:{stepRuns:"id"}}},thread:{type:"WorkflowRunThread",resolve:"readWorkflowRunThread"},context:{type:["ParameterRun"]},step:{description:"The step associated with this run",type:"Step",has:"id"},started:{type:"FactoryDateTime"},ended:{type:"FactoryDateTime"},status:{type:"RunStatusEnum"},taskId:{type:"String"}},_backend:{schema:"S2FWorkflow",collection:"step_run",mutation:{create:{type:"StepRun",args:{step:{type:"String",nullable:!1},workflowRunThread:{type:"String",nullable:!1},taskId:{type:"String"}},resolve:"createStepRun"},update:{type:"StepRun",args:{id:{type:"String",nullable:!1},status:{type:"RunStatusEnum"},taskId:{type:"String"},ended:{type:"FactoryDateTime"}}},delete:{type:"Boolean",args:{id:{type:"String",nullable:!1}}},startStepRun:{type:"Boolean",args:{id:{type:"String",nullable:!1},taskId:{type:"String"}},resolve:"startStepRun"},setStepRunStatus:{type:"Boolean",args:{id:{type:"String",nullable:!1},status:{type:"RunStatusEnum",nullable:!1}},resolve:"setStepRunStatus"},createForks:{type:["WorkflowRunThread"],args:{step:{type:"String",nullable:!1},workflowRun:{type:"String",nullable:!1},workflowRunThread:{type:"String",nullable:!1}},resolve:"createForks"},getJoinThreads:{type:["WorkflowRunThread"],args:{step:{type:"String",nullable:!1},workflowRun:{type:"String",nullable:!1}},resolve:"getJoinThreads"}}}},StepTypeEnum={type:"Enum",values:{BASIC:"BASIC",CONDITION:"CONDITION",END:"END",FORK:"FORK",JOIN:"JOIN",LOOP:"LOOP",START:"START",TASK:"TASK",WORKFLOW:"WORKFLOW"}},SyncIdInput={type:"Input",fields:{id:{type:"String",nullable:!1}}},SyncParameterInput={type:"Input",fields:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},description:{type:"String"},type:{type:"ParameterTypeEnum",nullable:!1},scope:{type:"ParameterScopeEnum",nullable:!1},class:{type:"ParameterClassEnum",nullable:!1},required:{type:"Boolean"},mapsTo:{type:"String"},defaultValue:{type:"String"}}},SyncStepInput={type:"Input",fields:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},description:{type:"String"},type:{type:"StepTypeEnum",nullable:!1},async:"Boolean",source:"String",versionArgs:"FactoryJSON",timeout:"Int",failsWorkflow:"Boolean",waitOnSuccess:"Boolean",requireResumeKey:"Boolean",parameters:["SyncParameterInput"],task:"SyncTemporalInput",subWorkflow:"SyncTemporalInput",success:"String",fail:"String",ex:"FactoryJSON",threads:["SyncIdInput"]}},SyncTemporalInput={type:"Input",fields:{_temporal:{type:"SyncTemporalMetadataInput"},id:{type:"String"}}},SyncTemporalMetadataInput={type:"Input",fields:{recordId:{type:"String"}}},Task={extendFields:["TemporalType"],fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String"},description:{type:"String"},source:{type:"String",nullable:!1},parameters:{type:["Parameter"],resolve:"readParameter"}},_backend:{schema:"S2FWorkflow",collection:"task",temporal:!0,query:{read:{type:["Task"],args:{recordId:{type:"String"},id:{type:"String"},version:{type:"String"},date:{type:"FactoryDateTime"}},resolve:"readTask"},readTaskVersions:{type:["Task"],args:{recordId:{type:"String",nullable:!1},limit:{type:"Int"},offset:{type:"Int"}},resolve:"readTaskVersions"}},mutation:{create:{type:"Task",args:{name:{type:"String",nullable:!1},description:{type:"String"},source:{type:"String",nullable:!1}},resolve:"createTask"},update:{type:"Task",args:{id:{type:"String",nullable:!1},name:{type:"String"},description:{type:"String"},source:{type:"String"}},resolve:"updateTask"},delete:{type:"Boolean",args:{id:{type:"String",nullable:!1}},resolve:"deleteTask"},branchTask:{type:"Task",args:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},owner:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"branchTemporalTask"},forkTask:{type:"Task",args:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},owner:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"forkTemporalTask"},publishTask:{type:"Task",args:{id:{type:"String",nullable:!1},version:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"publishTemporalTask"},syncTask:{type:"Task",args:{owner:{type:"String"},id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},description:{type:"String"},source:{type:"String",nullable:!1},folder:{type:"String"},parameters:["SyncParameterInput"]},resolve:"syncTask"}}}},Workflow={extendFields:["TemporalType"],fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String"},description:{type:"String"},folder:{type:"String",resolve:"readWorkflowFolder"},inputs:{description:"Inputs from steps",type:["Parameter"],args:{id:{type:"String"}},resolve:"readWorkflowInputs"},parameters:{description:"Global parameters",type:["Parameter"],args:{id:{type:"String"}},resolve:"readParameter"},steps:{description:"Steps in the workflow",type:["Step"],args:{id:{type:"String"},first:{type:"Boolean"}},resolve:"readStep"},endStep:{type:"Step",resolve:"readEndStep"}},_backend:{schema:"S2FWorkflow",collection:"workflow",temporal:!0,query:{read:{type:["Workflow"],args:{recordId:{type:"String"},id:{type:"String"},version:{type:"String"},date:{type:"FactoryDateTime"}},resolve:"readWorkflow"},readWorkflowVersions:{type:["Workflow"],args:{recordId:{type:"String",nullable:!1},limit:{type:"Int"},offset:{type:"Int"}},resolve:"readWorkflowVersions"}},mutation:{create:{type:"Workflow",args:{name:{type:"String",nullable:!1},description:{type:"String"}},resolve:"createWorkflow"},update:{type:"Workflow",args:{name:{type:"String"},description:{type:"String"}},resolve:"updateWorkflow"},delete:{type:"Boolean",args:{id:{type:"String",nullable:!1}},resolve:"deleteWorkflow"},branchWorkflow:{type:"Workflow",args:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},owner:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"branchWorkflow"},forkWorkflow:{type:"Workflow",args:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},owner:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"forkWorkflow"},publishWorkflow:{type:"Workflow",args:{id:{type:"String",nullable:!1
},version:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"publishWorkflow"},syncWorkflow:{type:"Workflow",args:{owner:{type:"String"},id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},description:{type:"String"},folder:{type:"String"},parameters:["SyncParameterInput"],steps:["SyncStepInput"]},resolve:"syncWorkflow"}}}},WorkflowRun={fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},workflow:{type:"Workflow",has:"id",resolve:"readWorkflow"},args:{type:"FactoryJSON"},input:{type:"FactoryJSON"},context:{type:["ParameterRun"],resolve:"readParameterRun"},threads:{type:["WorkflowRunThread"],resolve:"readWorkflowRunThread"},started:{type:"FactoryDateTime"},ended:{type:"FactoryDateTime"},status:{type:"RunStatusEnum"},taskId:{type:"String"},parentStepRun:{type:"String"}},_backend:{schema:"S2FWorkflow",collection:"workflow_run",mutation:{create:{args:{workflow:{type:"String"},args:{type:"FactoryJSON"},input:{type:"FactoryJSON"},parameters:{type:["ParameterInput"]},step:{type:"StepInput"},taskId:{type:"String"},parent:{type:"String"}},resolve:"createWorkflowRun"},update:{type:"WorkflowRun",args:{id:{type:"String",nullable:!1},status:{type:"RunStatusEnum"},ended:{type:"FactoryDateTime"}},resolve:"updateWorkflowRun"},delete:{type:"Boolean",args:{id:{type:"String",nullable:!1}},resolve:"deleteWorkflowRun"},endWorkflowRun:{type:"Boolean",args:{id:{type:"String",nullable:!1},status:{type:"RunStatusEnum",nullable:!1}},resolve:"endWorkflowRun"}}}},WorkflowRunThread={fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},parentThread:{type:"WorkflowRunThread",has:"id",resolve:"readWorkflowRunThread"},workflowRun:{type:"WorkflowRun",belongsTo:{WorkflowRun:{threads:"id"}},has:"id"},currentStepRun:{type:"StepRun",has:"id",resolve:"readStepRun"},stepRuns:{type:["StepRun"],resolve:"readStepRun"},status:{type:"RunStatusEnum"}},_backend:{schema:"S2FWorkflow",collection:"workflow_run_thread",mutation:{create:{args:{workflowRun:{type:"String",nullable:!1},currentStepRun:{type:"String",nullable:!1}}},update:{args:{id:{type:"String",nullable:!1},currentStepRun:{type:"String"},status:{type:"RunStatusEnum"}}},delete:{args:{id:{type:"String",nullable:!1}}}}}},types={EntitySummary:EntitySummary,EntityTypeEnum:EntityTypeEnum,Folder:Folder,FolderChildTypeEnum:FolderChildTypeEnum,FolderMembership:FolderMembership,FolderView:FolderView,Parameter:Parameter,ParameterClassEnum:ParameterClassEnum,ParameterRun:ParameterRun,ParameterRunValueInput:ParameterRunValueInput,ParameterTypeEnum:ParameterTypeEnum,ParameterScopeEnum:ParameterScopeEnum,RunStatusEnum:RunStatusEnum,Step:Step,StepInput:StepInput,StepRun:StepRun,StepTypeEnum:StepTypeEnum,SyncIdInput:SyncIdInput,SyncParameterInput:SyncParameterInput,SyncStepInput:SyncStepInput,SyncTemporalInput:SyncTemporalInput,SyncTemporalMetadataInput:SyncTemporalMetadataInput,Task:Task,Workflow:Workflow,WorkflowRun:WorkflowRun,WorkflowRunThread:WorkflowRunThread},_ParameterClassEnum$v=ParameterClassEnum.values,INPUT=_ParameterClassEnum$v.INPUT,OUTPUT=_ParameterClassEnum$v.OUTPUT,_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},asyncGenerator=function(){function e(e){this.value=e}function t(t){function r(e,t){return new Promise(function(r,o){var l={key:e,arg:t,resolve:r,reject:o,next:null};u?u=u.next=l:(a=u=l,n(e,t))})}function n(r,a){try{var u=t[r](a),l=u.value;l instanceof e?Promise.resolve(l.value).then(function(e){n("next",e)},function(e){n("throw",e)}):o(u.done?"return":"normal",u.value)}catch(e){o("throw",e)}}function o(e,t){switch(e){case"return":a.resolve({value:t,done:!0});break;case"throw":a.reject(t);break;default:a.resolve({value:t,done:!1})}a=a.next,a?n(a.key,a.arg):u=null}var a,u;this._invoke=r,"function"!=typeof t.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},defineProperty=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},_StepTypeEnum$values=StepTypeEnum.values,BASIC=_StepTypeEnum$values.BASIC,TASK=_StepTypeEnum$values.TASK,WORKFLOW=_StepTypeEnum$values.WORKFLOW,_RunStatusEnum$values$2=RunStatusEnum.values,FAIL=_RunStatusEnum$values$2.FAIL,SUCCESS$1=_RunStatusEnum$values$2.SUCCESS,JOINED$1=_RunStatusEnum$values$2.JOINED,_RunStatusEnum$values$1=RunStatusEnum.values,CREATED=_RunStatusEnum$values$1.CREATED,FORKING=_RunStatusEnum$values$1.FORKING,JOINING=_RunStatusEnum$values$1.JOINING,ENDING=_RunStatusEnum$values$1.ENDING,RUNNING$1=_RunStatusEnum$values$1.RUNNING,JOINED=_RunStatusEnum$values$1.JOINED,RUNNING_STATES=[CREATED,FORKING,JOINING,RUNNING$1],RUNNING=RunStatusEnum.values.RUNNING,JOIN=StepTypeEnum.values.JOIN,_RunStatusEnum$values=RunStatusEnum.values,SUCCESS=_RunStatusEnum$values.SUCCESS,WAITING=_RunStatusEnum$values.WAITING,resume={handler:function(e){var t=e.payload,r=e.socket,n=e.requestId,o=this.backend.log,a="workflow.resume."+n,u=_.get(this.backend,"server._emitter"),l=t.resumeKey;if(!l||!n){var i=[new Error("no resumeKey or requestId specified")];o.error({resumeKey:l,requestId:n},"missing resume key or requestId"),u.emit(a,{errors:i}),r&&r.emit(a,{errors:i})}return resumeStep(this.backend,l,function(e){var t=e?{errors:[e]}:{status:"OK"};t.errors&&o.error({errors:t.errors},"failed to resume step"),u.emit(a,t),r&&r.emit(a,t)})}},workflow={handler:function(e){var t=e.payload,r=e.socket,n=e.requestId,o=t.query,a=t.rootValue,u=t.contextValue,l=t.variableValues,i=t.operationName;return this.backend.lib.S2FWorkflow(o,a,u,l,i).then(function(e){r&&r.emit("result."+n,e)}).catch(function(e){r&&r.emit("result."+n,{errors:[e]})})}},local={"workflow.resume":resume,workflow:workflow},resume$1={handler:function(e){this._emitter.emit("workflow.resume",e)}},workflow$1={handler:function(e){this._emitter.emit("workflow",e)}},socket={"workflow.resume":resume$1,workflow:workflow$1},events={local:local,socket:socket},ATTRIBUTE=ParameterClassEnum.values.ATTRIBUTE,INPUT$1=ParameterClassEnum.values.INPUT,_StepTypeEnum$values$1=StepTypeEnum.values,WORKFLOW$1=_StepTypeEnum$values$1.WORKFLOW,TASK$1=_StepTypeEnum$values$1.TASK,INPUT$2=ParameterClassEnum.values.INPUT,_RunStatusEnum$values$3=RunStatusEnum.values,FORKED=_RunStatusEnum$values$3.FORKED,CREATED$1=_RunStatusEnum$values$3.CREATED,RUNNING$2=_RunStatusEnum$values$3.RUNNING,FORK=StepTypeEnum.values.FORK,UPDATE="update",INSERT="insert",END=StepTypeEnum.values.END,_EntityTypeEnum$value=EntityTypeEnum.values,PARAMETER=_EntityTypeEnum$value.PARAMETER,WORKFLOW$2=_EntityTypeEnum$value.WORKFLOW,STEP=_EntityTypeEnum$value.STEP,FolderType=FolderChildTypeEnum.values,UPDATE$1="update",INSERT$1="insert",_EntityTypeEnum$value$1=EntityTypeEnum.values,PARAMETER$1=_EntityTypeEnum$value$1.PARAMETER,TASK$2=_EntityTypeEnum$value$1.TASK,FolderType$1=FolderChildTypeEnum.values,_StepTypeEnum$values$2=StepTypeEnum.values,TASK$3=_StepTypeEnum$values$2.TASK,WORKFLOW$3=_StepTypeEnum$values$2.WORKFLOW,END$1=_StepTypeEnum$values$2.END,_ParameterClassEnum$v$1=ParameterClassEnum.values,INPUT$3=_ParameterClassEnum$v$1.INPUT,ATTRIBUTE$1=_ParameterClassEnum$v$1.ATTRIBUTE,ATTRIBUTE$2=ParameterClassEnum.values.ATTRIBUTE,_StepTypeEnum$values$3=StepTypeEnum.values,START=_StepTypeEnum$values$3.START,END$2=_StepTypeEnum$values$3.END,functions={createFolder:createFolder,readFolder:readFolder,updateFolder:updateFolder,deleteFolder:deleteFolder,readRootFolder:readRootFolder,readSubFolder:readSubFolder,readWorkflowFolder:readWorkflowFolder,createParameter:createParameter,updateParameter:updateParameter,deleteParameter:deleteParameter,createParameterRun:createParameterRun,updateParameterRun:updateParameterRun,deleteParameterRun:deleteParameterRun,updateAttributeValues:updateAttributeValues$1,createStep:createStep,readStep:readStep,updateStep:updateStep,deleteStep:deleteStep,readStepThreads:readStepThreads,readSource:readSource,readStepParams:readStepParams,createStepRun:createStepRun,startStepRun:startStepRun$1,setStepRunStatus:setStepRunStatus$1,createForks:createForks,getJoinThreads:getJoinThreads,syncWorkflow:syncWorkflow,syncTask:syncTask,createTask:createTask,readTask:readTask,readTaskVersions:readTaskVersions,updateTask:updateTask,deleteTask:deleteTask,branchWorkflow:branchWorkflow,forkWorkflow:forkWorkflow,publishWorkflow:publishWorkflow,createWorkflow:createWorkflow,readWorkflow:readWorkflow,updateWorkflow:updateWorkflow,deleteWorkflow:deleteWorkflow,readWorkflowInputs:readWorkflowInputs,readWorkflowVersions:readWorkflowVersions,readWorkflowParameters:readWorkflowParameters,readEndStep:readEndStep,createWorkflowRun:createWorkflowRun,updateWorkflowRun:updateWorkflowRun,deleteWorkflowRun:deleteWorkflowRun,endWorkflowRun:endWorkflowRun$1,readWorkflowRunThread:readWorkflowRunThread},_RunStatusEnum$values$5=RunStatusEnum.values,CREATED$2=_RunStatusEnum$values$5.CREATED,FORKING$1=_RunStatusEnum$values$5.FORKING,JOINING$1=_RunStatusEnum$values$5.JOINING,ENDING$1=_RunStatusEnum$values$5.ENDING,RUNNING$4=_RunStatusEnum$values$5.RUNNING,JOINED$2=_RunStatusEnum$values$5.JOINED,RUNNING_STATES$1=[CREATED$2,FORKING$1,JOINING$1,RUNNING$4],_RunStatusEnum$values$4=RunStatusEnum.values,SUCCESS$2=_RunStatusEnum$values$4.SUCCESS,FAIL$1=_RunStatusEnum$values$4.FAIL,WAITING$1=_RunStatusEnum$values$4.WAITING,_ParameterClassEnum$v$2=ParameterClassEnum.values,OUTPUT$1=_ParameterClassEnum$v$2.OUTPUT,ATTRIBUTE$3=_ParameterClassEnum$v$2.ATTRIBUTE,_StepTypeEnum$values$4=StepTypeEnum.values,CONDITION$1=_StepTypeEnum$values$4.CONDITION,LOOP$2=_StepTypeEnum$values$4.LOOP,RUNNING$3=RunStatusEnum.values.RUNNING,LOOP$1=StepTypeEnum.values.LOOP,FORKED$1=RunStatusEnum.values.FORKED,RUNNING$5=RunStatusEnum.values.RUNNING,_StepTypes$values=StepTypeEnum.values,BASIC$1=_StepTypes$values.BASIC,CONDITION=_StepTypes$values.CONDITION,FORK$1=_StepTypes$values.FORK,JOIN$1=_StepTypes$values.JOIN,LOOP=_StepTypes$values.LOOP,TASK$4=_StepTypes$values.TASK,WORKFLOW$4=_StepTypes$values.WORKFLOW,Task$2=[{_temporal:{changeLog:[{date:new Date(1473606625377),message:"Publish",type:"PUBLISH",user:"SYSTEM"}],recordId:"4c35b5a7-e971-4719-9846-ca06db2f8eb2",validFrom:new Date(1473606625377),validTo:null,version:"0.1.0"},entityType:"TASK",id:"0ea85a8a-ba97-4c31-8ed0-37926989b384",name:"Say Hello",source:'console.log("Hello", name)'},{_temporal:{recordId:"4c35b5a7-e971-4719-9846-ca06db2f8eb2",validFrom:null,validTo:null,version:null},entityType:"TASK",id:"b98548c6-d294-4406-88c1-3d7cffb97cfa",name:"Say Hello",source:'console.log("Hi", name)'}],Parameter$2=[{entityType:"PARAMETER",id:"0a329a80-3b97-4b83-832f-7f9c960afdfc",name:"name",parentId:"0ea85a8a-ba97-4c31-8ed0-37926989b384",required:"false",scope:"TASK",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"fed6aa1e-5a25-4cd6-8b35-20ad0e6547df",name:"name",parentId:"b98548c6-d294-4406-88c1-3d7cffb97cfa",required:"false",scope:"TASK",class:"INPUT",type:"STRING"}],SayHello={Task:Task$2,Parameter:Parameter$2},tasks=[SayHello],Workflow$2=[{_temporal:{changeLog:[],recordId:"72264666-5e7b-4bd7-b6f6-efff3a5aa73c",validFrom:null,validTo:null,version:null},entityType:"WORKFLOW",id:"170ab3d5-4ff4-41ed-b875-010067d1ebc5",name:"Fork Join Test",endStep:"44dad1a6-31d6-4d9b-9106-b80d05823195"}],Step$2=[{_temporal:{changeLog:[],recordId:"f32485c9-3087-43bc-9565-55a594fe9224",validFrom:null,validTo:null,version:null},description:"Ending point of the workflow",entityType:"STEP",fail:"44dad1a6-31d6-4d9b-9106-b80d05823195",failsWorkflow:!1,id:"44dad1a6-31d6-4d9b-9106-b80d05823195",name:"End",requireResumeKey:!1,success:"44dad1a6-31d6-4d9b-9106-b80d05823195",timeout:0,type:"END",waitOnSuccess:!1,workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"f1b70a2c-e583-4fcb-abf0-ae01621678c5",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"b6a0edaa-2417-4e75-8083-c62250dae391",name:"Fork",requireResumeKey:!1,timeout:0,type:"FORK",waitOnSuccess:!1,workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"e432ac48-6f52-4776-8c20-842246fe54f9",validFrom:null,validTo:null,version:null},async:!0,entityType:"STEP",failsWorkflow:!1,id:"80c73966-aac8-4f7b-b889-e64363322b4b",name:"Fork Left",source:'console.log("===========");\nconsole.log("=========== Forking Left", name);\nconsole.log("===========")',requireResumeKey:!1,success:"453721c9-9347-4d22-a07f-b85630954835",timeout:0,type:"BASIC",waitOnSuccess:!1,fork:"b6a0edaa-2417-4e75-8083-c62250dae391",workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"2108ead8-917f-43ef-ba2a-0d074bb300bd",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"453721c9-9347-4d22-a07f-b85630954835",name:"After Fork Left",source:'console.log("===========");\nconsole.log("=========== After Fork Left");\nconsole.log("===========")',requireResumeKey:!1,success:"b97ca7ae-b5de-4204-8440-5b695dfe45f9",timeout:0,type:"BASIC",waitOnSuccess:!1,workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"86393566-88b7-4971-97bf-6f60ea8df80c",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"3e5d2306-d12d-48f9-a9ee-a4b53acc753b",name:"Fork Right",source:'console.log("===========");\nconsole.log("=========== Forking Right");\nconsole.log("===========")',requireResumeKey:!1,success:"b97ca7ae-b5de-4204-8440-5b695dfe45f9",timeout:0,type:"BASIC",waitOnSuccess:!1,fork:"b6a0edaa-2417-4e75-8083-c62250dae391",workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"75c03bdd-ec3d-49ad-9ecb-207e9b511869",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"b97ca7ae-b5de-4204-8440-5b695dfe45f9",name:"Join",requireResumeKey:!1,timeout:0,type:"JOIN",success:"44dad1a6-31d6-4d9b-9106-b80d05823195",waitOnSuccess:!1,workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"7af16dd4-346a-4527-b9d4-b58d31017c4d",validFrom:null,validTo:null,version:null},description:"Starting point of the workflow",entityType:"STEP",fail:"44dad1a6-31d6-4d9b-9106-b80d05823195",failsWorkflow:!1,id:"1cb92ccb-e022-4b43-aa29-8e37492b021e",name:"Start",requireResumeKey:!1,success:"b6a0edaa-2417-4e75-8083-c62250dae391",timeout:0,type:"START",waitOnSuccess:!1,workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"}],Parameter$3=[{entityType:"PARAMETER",id:"c9cf9ca4-4053-4c32-b052-ad79f262df27",name:"name",parentId:"80c73966-aac8-4f7b-b889-e64363322b4b",required:"false",scope:"STEP",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"4686b2eb-7815-4bad-a941-dcbd36f1fba7",name:"name",parentId:"80c73966-aac8-4f7b-b889-e64363322b4b",required:"false",scope:"STEP",mapsTo:"9bbf9716-f6eb-4dd5-a9c5-b44fb29f93d0",class:"OUTPUT",type:"STRING"},{entityType:"PARAMETER",id:"9bbf9716-f6eb-4dd5-a9c5-b44fb29f93d0",name:"message",defaultValue:"Hello",parentId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5",required:"false",scope:"WORKFLOW",class:"ATTRIBUTE",type:"STRING"}],ForkJoinTest={Workflow:Workflow$2,Step:Step$2,Parameter:Parameter$3},Workflow$3=[{_temporal:{changeLog:[],recordId:"151743c4-93ee-48ab-a7d3-608a5d06900e",validFrom:null,validTo:null,version:null},entityType:"WORKFLOW",id:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a",name:"Fork Test",endStep:"c6c463db-68bf-4e6f-aeaa-c546dae14525"}],Step$3=[{_temporal:{changeLog:[],recordId:"17bbc6b5-00c8-4aab-a9ca-05cdd38ab1ae",validFrom:null,validTo:null,version:null},description:"Ending point of the workflow",entityType:"STEP",fail:"c6c463db-68bf-4e6f-aeaa-c546dae14525",failsWorkflow:!1,id:"c6c463db-68bf-4e6f-aeaa-c546dae14525",name:"End",requireResumeKey:!1,success:"c6c463db-68bf-4e6f-aeaa-c546dae14525",timeout:0,type:"END",waitOnSuccess:!1,workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"},{_temporal:{changeLog:[],recordId:"31f7d5cf-4799-4029-a4b8-45be79f33e3f",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"4cc47451-7115-49b5-ace2-4d05fc3ad09c",name:"Fork",requireResumeKey:!1,timeout:0,type:"FORK",waitOnSuccess:!1,workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"},{_temporal:{changeLog:[],recordId:"c9c1531e-ef6d-4199-b559-796fd144d983",validFrom:null,validTo:null,version:null},async:!0,entityType:"STEP",failsWorkflow:!1,id:"9417a242-0f72-4ef7-b876-61efb23ad446",name:"Fork Left",source:'console.log("===========");\nconsole.log("=========== Forking Left", name);\nconsole.log("===========")',requireResumeKey:!1,success:"aff95d33-9f8a-4ece-87f7-462d1b71eeb9",timeout:0,type:"BASIC",waitOnSuccess:!1,fork:"4cc47451-7115-49b5-ace2-4d05fc3ad09c",workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"},{_temporal:{changeLog:[],recordId:"bbfe82e3-6ee6-4001-8ea6-2b00d932f2d3",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"aff95d33-9f8a-4ece-87f7-462d1b71eeb9",name:"After Fork Left",source:'console.log("===========");\nconsole.log("=========== After Fork Left");\nconsole.log("===========")',requireResumeKey:!1,success:"c6c463db-68bf-4e6f-aeaa-c546dae14525",timeout:0,type:"BASIC",waitOnSuccess:!1,workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"},{_temporal:{changeLog:[],recordId:"2a7f16df-3c7f-46ab-bdf9-9314a46c0c29",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"44580253-4216-4fe1-9333-dcef4927280f",name:"Fork Right",source:'console.log("===========");\nconsole.log("=========== Forking Right");\nconsole.log("===========")',requireResumeKey:!1,success:"c6c463db-68bf-4e6f-aeaa-c546dae14525",timeout:0,type:"BASIC",waitOnSuccess:!1,fork:"4cc47451-7115-49b5-ace2-4d05fc3ad09c",workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"},{_temporal:{changeLog:[],recordId:"ceff4a5d-3f73-4c63-8ba2-5fef6d65be28",validFrom:null,validTo:null,version:null},description:"Starting point of the workflow",entityType:"STEP",fail:"c6c463db-68bf-4e6f-aeaa-c546dae14525",failsWorkflow:!1,id:"3347466a-3abf-42c6-9fd7-3ddf22976af8",name:"Start",requireResumeKey:!1,success:"4cc47451-7115-49b5-ace2-4d05fc3ad09c",timeout:0,type:"START",waitOnSuccess:!1,workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"}],Parameter$4=[{entityType:"PARAMETER",id:"912f5d3b-9d4f-4fe5-93f1-a6446b983ed5",name:"name",parentId:"9417a242-0f72-4ef7-b876-61efb23ad446",required:"false",scope:"STEP",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"3361dde6-3db4-4a4e-8b4f-58d7f8fd2a90",name:"name",parentId:"9417a242-0f72-4ef7-b876-61efb23ad446",required:"false",scope:"STEP",mapsTo:"93f439a5-9833-4706-9cd8-7acf19b01901",class:"OUTPUT",type:"STRING"},{entityType:"PARAMETER",id:"93f439a5-9833-4706-9cd8-7acf19b01901",name:"message",defaultValue:"Hello",parentId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a",required:"false",scope:"WORKFLOW",class:"ATTRIBUTE",type:"STRING"}],ForkTest={Workflow:Workflow$3,Step:Step$3,Parameter:Parameter$4},Workflow$4=[{_temporal:{changeLog:[],recordId:"c5801b61-a7cd-4995-964b-c0a1f368de7c",validFrom:null,validTo:null,version:null},entityType:"WORKFLOW",id:"f4a8f894-06ba-4213-80f1-80ff72e1039b",name:"Hello World",endStep:"d2618ad7-a4d2-4213-b921-935b6eeafaf4"},{_temporal:{changeLog:[],recordId:"c5801b61-a7cd-4995-964b-c0a1f368de7c",validFrom:new Date("2016-01-01"),validTo:null,version:"0.1.0"},entityType:"WORKFLOW",id:"e38faf1f-1ae4-4450-91b8-afb7c2e472c8",name:"Hello World",endStep:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb"}],Step$4=[{_temporal:{changeLog:[],recordId:"2f703d65-3aa7-40fc-b99d-3a0610ee6645",validFrom:null,validTo:null,version:null},description:"Ending point of the workflow",entityType:"STEP",fail:"d2618ad7-a4d2-4213-b921-935b6eeafaf4",failsWorkflow:!1,id:"d2618ad7-a4d2-4213-b921-935b6eeafaf4",name:"End",requireResumeKey:!1,success:"d2618ad7-a4d2-4213-b921-935b6eeafaf4",timeout:0,type:"END",waitOnSuccess:!1,workflowId:"f4a8f894-06ba-4213-80f1-80ff72e1039b"},{_temporal:{changeLog:[],recordId:"e86715f1-11a4-402c-9aa3-1b7c61a4af8c",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"68e5264a-89ef-4c85-9235-09d8e944580f",name:"Say Hello",requireResumeKey:!1,task:"4c35b5a7-e971-4719-9846-ca06db2f8eb2",versionArgs:{},success:"d2618ad7-a4d2-4213-b921-935b6eeafaf4",timeout:0,type:"TASK",waitOnSuccess:!1,workflowId:"f4a8f894-06ba-4213-80f1-80ff72e1039b"},{_temporal:{changeLog:[],recordId:"19a1e436-3532-4f51-8508-868d4f234bd2",validFrom:null,validTo:null,version:null},description:"Starting point of the workflow",entityType:"STEP",fail:"d2618ad7-a4d2-4213-b921-935b6eeafaf4",failsWorkflow:!1,id:"93a66216-21f5-45b5-92ae-f200a23c5c82",name:"Start",requireResumeKey:!1,success:"68e5264a-89ef-4c85-9235-09d8e944580f",timeout:0,type:"START",waitOnSuccess:!1,workflowId:"f4a8f894-06ba-4213-80f1-80ff72e1039b"},{_temporal:{changeLog:[],recordId:"b0199df1-50be-4958-9e51-39104ead1bee",validFrom:null,validTo:null,version:null},description:"Ending point of the workflow",entityType:"STEP",fail:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb",failsWorkflow:!1,id:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb",name:"End",requireResumeKey:!1,success:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb",timeout:0,type:"END",waitOnSuccess:!1,workflowId:"e38faf1f-1ae4-4450-91b8-afb7c2e472c8"},{_temporal:{changeLog:[],recordId:"cc76353e-5de4-44e8-8523-fd64f5a9149c",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"f8904d60-a73c-4348-867a-6d5df19bf6cc",name:"Say Hello",requireResumeKey:!1,task:"4c35b5a7-e971-4719-9846-ca06db2f8eb2",versionArgs:{},success:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb",timeout:0,type:"TASK",waitOnSuccess:!1,workflowId:"e38faf1f-1ae4-4450-91b8-afb7c2e472c8"},{_temporal:{changeLog:[],recordId:"758c4bea-0fc0-4f61-888c-7ef45d8fef35",validFrom:null,validTo:null,version:null},description:"Starting point of the workflow",entityType:"STEP",fail:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb",failsWorkflow:!1,id:"85a7ba22-4d74-41e1-b291-c82f69d15456",name:"Start",requireResumeKey:!1,success:"f8904d60-a73c-4348-867a-6d5df19bf6cc",timeout:0,type:"START",waitOnSuccess:!1,workflowId:"e38faf1f-1ae4-4450-91b8-afb7c2e472c8"}],Parameter$5=[{entityType:"PARAMETER",id:"a2189572-dce9-46b8-897f-18d5bb221c08",name:"name",parentId:"68e5264a-89ef-4c85-9235-09d8e944580f",required:"false",scope:"STEP",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"1e5782b6-e8c0-47c0-b4bc-a0eca56805c1",name:"message",defaultValue:"Hello",parentId:"f4a8f894-06ba-4213-80f1-80ff72e1039b",required:"false",scope:"WORKFLOW",class:"ATTRIBUTE",type:"STRING"},{entityType:"PARAMETER",id:"97eacabd-6dbd-42fa-b6c4-3e8c49cde118",name:"name",parentId:"f8904d60-a73c-4348-867a-6d5df19bf6cc",required:"false",scope:"STEP",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"d01a6dad-9a0a-4eb5-abf6-04a212eda686",name:"message",defaultValue:"Hello",parentId:"e38faf1f-1ae4-4450-91b8-afb7c2e472c8",required:"false",scope:"WORKFLOW",class:"ATTRIBUTE",type:"STRING"}],HelloWorld={Workflow:Workflow$4,Step:Step$4,Parameter:Parameter$5},Workflow$5=[{_temporal:{changeLog:[],recordId:"2464780a-92ba-475b-b7a6-c49a0a9d189b",validFrom:null,validTo:null,version:null},entityType:"WORKFLOW",id:"de3f6477-aafb-49bb-9c88-ee3d7f65beff",name:"Sub Workflow Test",endStep:"c3dd216f-aa42-472d-806e-7beaf48609ed"}],Step$5=[{_temporal:{changeLog:[],recordId:"9231a271-0f03-418d-ac9c-faa46c59506e",validFrom:null,validTo:null,version:null},description:"Starting point of the workflow",entityType:"STEP",fail:"c3dd216f-aa42-472d-806e-7beaf48609ed",failsWorkflow:!1,id:"68084694-e75a-45ab-816e-615c3c606596",name:"Start",requireResumeKey:!1,success:"6cb7a7e5-1c6c-468e-8106-29abeb585844",timeout:0,type:"START",waitOnSuccess:!1,workflowId:"de3f6477-aafb-49bb-9c88-ee3d7f65beff"},{_temporal:{changeLog:[],recordId:"a0c84a22-4bde-4ee7-abc9-f098b082bef0",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"6cb7a7e5-1c6c-468e-8106-29abeb585844",name:"Test Name",source:'console.log("===========");\nconsole.log("Sub Workflow Start");\nconsole.log("===========");',requireResumeKey:!1,task:"5ca86058-4b93-4feb-8136-554195516cd1",success:"845a78a5-a2fa-422c-9cd5-806004be0038",timeout:0,type:"BASIC",waitOnSuccess:!1,workflowId:"de3f6477-aafb-49bb-9c88-ee3d7f65beff"},{_temporal:{changeLog:[],recordId:"4fb2fdd9-8698-4f97-ad37-19bfe9f05bad",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"845a78a5-a2fa-422c-9cd5-806004be0038",name:"Hello World",requireResumeKey:!1,subWorkflow:"c5801b61-a7cd-4995-964b-c0a1f368de7c",success:"c3dd216f-aa42-472d-806e-7beaf48609ed",timeout:0,type:"WORKFLOW",waitOnSuccess:!1,workflowId:"de3f6477-aafb-49bb-9c88-ee3d7f65beff"},{_temporal:{changeLog:[],recordId:"94aa101f-4a8a-47a8-aae2-699cfeba541c",validFrom:null,validTo:null,version:null},description:"Ending point of the workflow",entityType:"STEP",fail:"c3dd216f-aa42-472d-806e-7beaf48609ed",failsWorkflow:!1,id:"c3dd216f-aa42-472d-806e-7beaf48609ed",name:"End",requireResumeKey:!1,success:"c3dd216f-aa42-472d-806e-7beaf48609ed",timeout:0,type:"END",waitOnSuccess:!1,workflowId:"de3f6477-aafb-49bb-9c88-ee3d7f65beff"}],Parameter$6=[{entityType:"PARAMETER",id:"1cf60c78-bfc9-4845-985c-343923f8c1d1",name:"name",parentId:"6cb7a7e5-1c6c-468e-8106-29abeb585844",required:"false",scope:"STEP",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"3fc2c440-5c1e-442f-9bfd-2250f88b2f0b",name:"message",defaultValue:"Hello",parentId:"de3f6477-aafb-49bb-9c88-ee3d7f65beff",required:"false",scope:"WORKFLOW",class:"ATTRIBUTE",type:"STRING"}],SubWorkflowTest={Workflow:Workflow$5,Step:Step$5,Parameter:Parameter$6},workflows=[ForkJoinTest,ForkTest,HelloWorld,SubWorkflowTest],Workflow$1=[],Step$1=[],Parameter$1=[],Task$1=[],Folder$1=[{id:"c841607d-9d26-43fc-9e7e-8eab7c9fd892",entityType:"FOLDER",name:"Workflows",parent:"ROOT",type:"WORKFLOW"},{id:"4acb1f18-2935-4708-8d3c-69c7209f8d87",entityType:"FOLDER",name:"Tasks",parent:"ROOT",type:"TASK"},{id:"9595014b-5614-4475-8e0e-4d07e4e865b6",entityType:"FOLDER",name:"Examples",parent:"c841607d-9d26-43fc-9e7e-8eab7c9fd892",type:"WORKFLOW"},{id:"067c20db-c009-4277-aeda-e3db9af31472",entityType:"FOLDER",name:"Examples",parent:"4acb1f18-2935-4708-8d3c-69c7209f8d87",type:"TASK"}],FolderMembership$1=[{folder:"067c20db-c009-4277-aeda-e3db9af31472",childType:"TASK",childId:"4c35b5a7-e971-4719-9846-ca06db2f8eb2"},{folder:"c841607d-9d26-43fc-9e7e-8eab7c9fd892",childType:"WORKFLOW",childId:"72264666-5e7b-4bd7-b6f6-efff3a5aa73c"},{folder:"c841607d-9d26-43fc-9e7e-8eab7c9fd892",childType:"WORKFLOW",childId:"151743c4-93ee-48ab-a7d3-608a5d06900e"},{folder:"9595014b-5614-4475-8e0e-4d07e4e865b6",childType:"WORKFLOW",childId:"c5801b61-a7cd-4995-964b-c0a1f368de7c"},{folder:"9595014b-5614-4475-8e0e-4d07e4e865b6",childType:"WORKFLOW",childId:"2464780a-92ba-475b-b7a6-c49a0a9d189b"}];_.forEach(_.union(workflows,tasks),function(e){_.isArray(e.Workflow)&&(Workflow$1=_.union(Workflow$1,e.Workflow)),_.isArray(e.Step)&&(Step$1=_.union(Step$1,e.Step)),_.isArray(e.Parameter)&&(Parameter$1=_.union(Parameter$1,e.Parameter)),_.isArray(e.Task)&&(Task$1=_.union(Task$1,e.Task))});var installData={Workflow:Workflow$1,Step:Step$1,Parameter:Parameter$1,Task:Task$1,Folder:Folder$1,FolderMembership:FolderMembership$1},S2fRethinkDBBackend=function(e){function t(e,r,n){var o=arguments.length<=3||void 0===arguments[3]?{}:arguments[3],a=arguments[4];classCallCheck(this,t),o=mergeConfig(o);var u={tables:temporalTables(o.types),prefix:_.get(o,"options.prefix"),db:_.get(o,"options.store")},l=new graphqlFactoryTemporal_backend.rethinkdb(n,r,u,a),i=FactoryTemporalPlugin(l);o.plugin=_.union([i],_.isArray(o.plugin)?o.plugin:[]);var d=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n,o,a));return d.type="S2fRethinkDBBackend",d.addInstallData(installData),d.addFunctions(functions),d.addActions(actions(d)),d.addEvents(events),d}return inherits(t,e),t}(yellowjacket.YellowjacketRethinkDBBackend),index={rethinkdb:rethinkdb$1,S2fRethinkDBBackend:S2fRethinkDBBackend};exports.rethinkdb=rethinkdb$1,exports.S2fRethinkDBBackend=S2fRethinkDBBackend,exports.default=index;