"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function mergeConfig(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _.merge({},e,{types:types,fields:fields})}function temporalTables(e){return _.omitBy(_.mapValues(e,function(e){var r=_.get(e,"_backend",{});return r.temporal?{table:_.get(e,"_backend.collection")}:null}),function(e){return null===e})}function expandGQLErrors(e){if(_.isArray(e))return _.map(e,function(e){try{return _.isObject(e)?JSON.stringify(e):e}catch(r){return e}});try{return _.isObject(e)?JSON.stringify(e):e}catch(r){return e}}function safeParse(e){try{return JSON.parse(e)}catch(r){return e}}function convertType(e,r,t){if(!e||!r)throw new Error("could not determine type of variable name to convert");switch(e){case"ARRAY":if(t=_.isString(t)?safeParse(t):t,_.isArray(t))return t;case"BOOLEAN":if(t=_.isString(t)?safeParse(t):t,_.isBoolean(t))return Boolean(t);case"DATE":try{return new Date(t)}catch(e){}case"NUMBER":if(t=_.isString(t)?safeParse(t):t,_.isNumber(t))return Number(t);case"OBJECT":if(t=_.isString(t)?safeParse(t):t,_.isObject(t))return t;case"STRING":if(_.isString(t))return String(t);default:throw new Error(r+" could not be cast to type "+e)}}function mapInput(e,r,t){var n={};return _.forEach(t,function(t){if(t.class===INPUT)if(t.mapsTo){var o=_.find(r,function(e){return _.get(e,"parameter.id")===t.mapsTo})||{},a=o.parameter,l=o.value;a&&(n[t.name]=l)}else try{n[t.name]=convertType(t.type,t.name,_.get(e,t.name))}catch(e){}}),n}function winTieBreak(e,r){return!_.without(r,e).length||r.sort()[0]===e}function getStepRun(e,r,t){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow('{\n    readStepRun (id: "'+r+'") {\n      status,\n      thread { id, workflowRun { id } },\n      step { async, success }\n    }\n  }').then(function(e){return e.errors?t(new n(expandGQLErrors(e.errors))):t(null,_.get(e,"data.readStepRun[0]"))}).catch(t)}function endWorkflowRun(e,r,t,n){var o=e.graphql.GraphQLError;return e.lib.S2FWorkflow('mutation Mutation {\n    endWorkflowRun (id: "'+r+'", status: '+t+")\n  }").then(function(e){return e.errors?n(new o(expandGQLErrors(e.errors))):n(null,_.get(e,"data.endWorkflowRun"))}).catch(n)}function getRunSummary(e,r,t){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow('{\n    readWorkflowRun (id: "'+r+'") {\n      context {\n        parameter { name },\n        value\n      },\n      threads {\n        stepRuns {\n          step { type, failsWorkflow }\n          status\n        }\n      },\n      parentStepRun,\n      taskId\n    }\n  }').then(function(e){return e.errors?t(new n(expandGQLErrors(e.errors))):t(null,_.get(e,"data.readWorkflowRun[0]"))}).catch(t)}function getRunThreads(e,r,t){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow('{\n    readWorkflowRun (id: "'+r+'") {\n      threads { id, status }\n    }\n  }').then(function(e){return e.errors?t(new n(expandGQLErrors(e.errors))):t(null,_.get(e,"data.readWorkflowRun[0].threads"))}).catch(t)}function newStepRun(e,r,t,n){var o=e.graphql.GraphQLError;return e.lib.S2FWorkflow('mutation Mutation {\n    createStepRun (step: "'+r+'", workflowRunThread: "'+t+'"),\n    { id }\n  }').then(function(e){return e.errors?n(new o(expandGQLErrors(e.errors))):n(null,_.get(e,"data.createStepRun"))}).catch(n)}function getStep(e,r,t){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow('{\n    readStep (id: "'+r+'") {\n      id, name, type\n    }\n  }').then(function(e){return e.errors?t(new n(expandGQLErrors(e.errors))):t(null,_.get(e,"data.readStep[0]"))}).catch(t)}function newForks(e,r,t,n,o){var a=e.graphql.GraphQLError;return e.lib.S2FWorkflow('mutation Mutation {\n    createForks (step: "'+r+'", workflowRun: "'+t+'", workflowRunThread: "'+n+'")\n    { id }\n  }').then(function(e){return e.errors?o(new a(expandGQLErrors(e.errors))):o(null,_.get(e,"data.createForks"))}).catch(o)}function setStepRunStatus(e,r,t,n){var o=e.graphql.GraphQLError;return e.lib.S2FWorkflow('mutation Mutation {\n    setStepRunStatus (id: "'+r+'", status: '+t+")\n  }").then(function(e){return e.errors?n(new o(expandGQLErrors(e.errors))):n(null,_.get(e,"data.setStepRunStatus"))}).catch(n)}function updateAttributeValues(e,r,t){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow("mutation Mutation {\n    updateAttributeValues (values: "+obj2arg(r)+")\n  }").then(function(e){return e.errors?t(new n(expandGQLErrors(e.errors))):t(null,_.get(e,"data.updateAttributeValues"))}).catch(t)}function updateWorkflowRunThread(e,r,t){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow("mutation Mutation {\n    updateWorkflowRunThread ("+obj2arg(r,{noOuterBraces:!0})+")\n    { id }\n  }").then(function(e){return e.errors?t(new n(expandGQLErrors(e.errors))):t(null,_.get(e,"data.updateWorkflowRunThread"))}).catch(t)}function startStepRun(e,r,t,n){var o=e.graphql.GraphQLError;return e.lib.S2FWorkflow('mutation Mutation {\n    startStepRun (\n      id: "'+r+'",\n      taskId: "'+t+'"\n    )\n  }').then(function(e){return e.errors?n(new o(expandGQLErrors(e.errors))):n(null,_.get(e,"data.startStepRun"))}).catch(n)}function newWorkflowRun(e,r,t){var n=e.graphql.GraphQLError;return e.lib.S2FWorkflow("mutation Mutation {\n    createWorkflowRun ("+obj2arg(r,{noOuterBraces:!0})+") {\n      id,\n      threads { id }\n    }\n  }",{},r).then(function(e){return e.errors?t(new n(expandGQLErrors(e.errors))):t(null,_.get(e,"data.createWorkflowRun"))}).catch(t)}function getWorkflowRun(e,r,t,n){var o=e.graphql.GraphQLError;return e.lib.S2FWorkflow('{\n    readWorkflowRun (id: "'+r+'") {\n      workflow { endStep { id } },\n      args,\n      input,\n      context {\n        id,\n        parameter { id, name, type, scope, class },\n        value\n      },\n      threads (id: "'+t+'") {\n        currentStepRun {\n          id,\n          step {\n            id,\n            type,\n            async,\n            source,\n            subWorkflow {\n              _temporal { recordId },\n              id\n            },\n            timeout,\n            failsWorkflow,\n            waitOnSuccess,\n            requireResumeKey,\n            success,\n            fail,\n            parameters { id, name, type, scope, class, mapsTo }\n          }\n        }\n      }\n    }\n  }').then(function(e){return e.errors?n(new o(expandGQLErrors(e.errors))):n(null,_.get(e,"data.readWorkflowRun[0]"))}).catch(n)}function computeWorkflowStatus(e,r){var t=this;try{var n=function(){var n=e.runner,o=e.workflowRun,a=e.thread,l={};return t.log.trace({workflowRun:o},"attempting to complete workflow run computation"),{v:getRunSummary(t,o,function(e,u){if(e)return r(e);var i=u.context,d=u.threads,c=u.parentStepRun,s=u.taskId;if(!d)return r(new Error("no threads found"));_.forEach(i,function(e){var r=_.get(e,"parameter.name");r&&_.has(e,"value")&&(l[r]=e.value)});var p=_.reduce(d,function(e,r){return _.union(e,_.get(r,"stepRuns",[]))},[]),f=_.reduce(p,function(e,r){var t=_.includes([BASIC,TASK,WORKFLOW],r.type),n=!(r.failsWorkflow&&t&&r.status!==FAIL);return e&&n},!0),y=f?SUCCESS$1:FAIL;return updateWorkflowRunThread(t,{id:a,status:"Enum::"+JOINED$1},function(e){return e?r(e):(t.log.trace({workflowRun:o},"joined final thread"),endWorkflowRun(t,o,y,function(e){return e?r(e):(t.log.debug({workflowRun:o,success:f},"workflow run completed"),c&&n.resume(s,{status:y,context:l}),r(null,y,{context:l}))}))})})}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){this.log.error({errors:e.message||e,stack:e.stack},"Failed to compute workflow status"),r(e)}}function joinThreads(e,r){e.workflowRun,e.thread;r()}function nextStepRun(e,r){var t=this;try{var n=function(){var n=e.thread,o=e.nextStep,a=e.async,l=e.workflowRun,u=_.get(t,"server._emitter");return u||a?{v:getStep(t,o,function(i,d){if(i)return r(i);var c=_.get(d,"type");return c?c===JOIN?joinThreads.call(t,e,r):newStepRun(t,o,n,function(e,o){if(e)return r(e);var i=_.get(o,"id");if(!i)throw new Error("Unable to create StepRun");var d={id:n,status:"Enum::"+RUNNING,currentStepRun:i};return updateWorkflowRunThread(t,d,function(e){return e?r(e):(u.emit("schedule",{payload:{action:"runStep",context:{thread:n,workflowRun:l}}}),!!a||r())})}):r(new Error("failed to get next step type"))})}:{v:r(new Error("No event emitter"))}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){return this.log.error({errors:e.message||e,stack:e.stack},"Failed to start next step"),r(e)}}function resumeStep(e,r,t){try{return getStepRun(e,r,function(n,o){var a=_.get(o,"status"),l=_.get(o,"thread.id"),u=_.get(o,"thread.workflowRun.id"),i=_.get(o,"step.success"),d=_.get(o,"step.async",!1);return n?t(n):o?i?l&&u?a!==WAITING?t(new Error("invalid step run status "+a+", must be "+WAITING)):setStepRunStatus(e,r,SUCCESS,function(r){return r?t(r):nextStepRun.call(e,{thread:l,workflowRun:u,nextStep:i,async:d},t)}):t(new Error("unable to retrieve workflow run and/or thread info")):t(new Error("attempting to resume a step with no success path")):t(new Error("invalid step run"))})}catch(r){e.log.error({errors:r.message||r,stack:r.stack},"Failed to run source step"),t(r)}}function createFolder(e){return function(r,t,n,o){e.r,e.connection,e.getTypeCollection("Folder")}}function readFolder(e){return function(r,t,n,o){e.r,e.connection,e.getTypeCollection("Folder")}}function updateFolder(e){return function(r,t,n,o){e.r,e.connection,e.getTypeCollection("Folder")}}function deleteFolder(e){return function(r,t,n,o){e.r,e.connection,e.getTypeCollection("Folder")}}function readWorkflowFolder(e){return function(r,t,n,o){var a=(e.r,e.connection),l=e.getTypeCollection("Folder"),u=e.getTypeCollection("FolderMembership");return u.get(r._temporal.recordId).do(function(e){return e.eq(null).branch(l.filter({type:"WORKFLOW",parent:"ROOT"}).nth(0)("id"),e("folder"))}).run(a)}}function readRootFolder(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Folder"),i=e.getTypeCollection("FolderMembership"),d=e.getTypeCollection("Task"),c=e.getTypeCollection("Workflow");return u.filter(function(e){return e("type").eq(t.type).and(e("parent").eq("ROOT"))}).merge(function(e){return{subFolders:u.filter({parent:e("id")}).coerceTo("array"),entities:i.filter({folder:e("id")}).map(function(e){return a.expr(_.toLower(t.type)).eq("task").branch(d,c).filter({_temporal:{recordId:e("childId")}}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0).do(function(e){return{id:e("_temporal")("recordId"),branchId:e("id"),version:e("_temporal")("version"),name:e("name")}}))})}).filter(function(e){return e.eq(null).not()}).coerceTo("array")}}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0))}).run(l)}}function readSubFolder(e){return function(r,t,n,o){var a=(e.r,e.connection),l=e.getTypeCollection("Folder"),u=e.getTypeCollection("FolderMembership"),i=e.getTypeCollection("Task"),d=e.getTypeCollection("Workflow");return l.filter({id:t.id}).merge(function(e){return{subFolders:l.filter({parent:e("id")}).coerceTo("array"),entities:u.filter({folder:e("id")}).map(function(r){return e("type").eq("TASK").branch(i,d).filter({_temporal:{recordId:r("childId")}}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0).do(function(e){return{id:e("_temporal")("recordId"),branchId:e("id"),version:e("_temporal")("version"),name:e("name")}}))})}).filter(function(e){return e.eq(null).not()}).coerceTo("array")}}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0))}).run(a)}}function createParameter(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Parameter");if("WORKFLOW"===t.scope&&"ATTRIBUTE"!==t.class)throw new Error("Workflow parameters can only be of class ATTRIBUTE");return _.includes(["WORKFLOW","TASK"],t.scope)&&(t.mapsTo=null),t.entityType="PARAMETER",u.filter({parentId:t.parentId})("name").coerceTo("array").do(function(e){return a.branch(e.map(function(e){return e.downcase()}).contains(a.expr(t.name).downcase()),a.error("A parameter with the name "+t.name+" already exists on the current "+t.scope),u.insert(t,{returnChanges:!0})("changes").nth(0)("new_val"))}).run(l)}}function isParentPublished(e,r){var t=e.r,n=(e.connection,e.getTypeCollection("Parameter")),o=e.getTypeCollection("Workflow"),a=e.getTypeCollection("Step"),l=e.getTypeCollection("Task");return n.get(r).do(function(e){return t.branch(e.eq(null),t.error("Parameter does not exist"),t.branch(e("scope").eq("WORKFLOW"),o.get(e("parentId")),t.branch(e("scope").eq("TASK"),l.get(e("parentId")),a.get(e("parentId")))).do(function(e){return t.branch(e("_temporal")("version").ne(null),!0,!1)}))})}function updateParameter(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Parameter");return isParentPublished(e,t.id).branch(a.error("This parameter belongs to a published record and cannot be modified"),u.get(t.id).do(function(e){return a.branch(a.expr(["WORKFLOW","TASK"]).contains(e("scope")),u.get(t.id).update(_.omit(t,"id","mapsTo")).do(function(){return u.get(t.id)}),u.get(t.id).update(_.omit(t,"id")).do(function(){return u.get(t.id)}))})).run(l)}}function deleteParameter(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Parameter");return isParentPublished(e,t.id).branch(a.error("This parameter belongs to a published record and cannot be deleted"),u.get(t.id).delete().do(function(){return!0})).run(l)}}function createParameterRun(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Parameter"),i=e.getTypeCollection("ParameterRun");return u.get(t.parameter).eq(null).branch(a.error("Parameter "+t.parameter+" not found"),i.insert(t,{returnChanges:!0})("changes").nth(0)("new_val")).run(l)}}function updateParameterRun(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("ParameterRun");return u.get(t.id).eq(null).branch(a.error("ParameterRun not found"),u.get(t.id).update(_.omit(t,"id")).do(function(){return u.get(t.id)})).run(l)}}function deleteParameterRun(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("ParameterRun");return u.get(t.id).eq(null).branch(a.error("ParameterRun not found"),u.get(t.id).delete().do(function(){return!0})).run(l)}}function updateAttributeValues$1(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("ParameterRun"),i=e.getTypeCollection("Parameter");return a.expr(t.values).forEach(function(e){return u.get(e("id")).do(function(r){return r.eq(null).branch(a.error("ParameterRun not found"),i.get(r("parameter")).do(function(r){return r.eq(null).or(r("class").ne(ATTRIBUTE)).branch(a.error("Invalid Parameter type"),u.get(e("id")).update({value:e("value")}))}))})}).do(function(){return!0}).run(l)}}function isPublished(e,r,t){var n=e._r,o=e._db.table(e._tables[r].table);return o.get(t).do(function(e){return n.branch(e.eq(null),n.error(r+" does not exist"),n.branch(e("_temporal")("version").ne(null),!0,!1))})}function first(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return e.coerceTo("array").do(function(e){return e.count().eq(0).branch(r,e.nth(0))})}function getWorkflowInputs(e,r,t){return e.filter({workflowId:t}).map(function(e){return r.filter({parentId:e("id"),class:INPUT$1}).filter(function(e){return e.hasFields("mapsTo").branch(e("mapsTo").eq(null).or(e("mapsTo").eq("")),!0)}).coerceTo("array")}).reduce(function(e,r){return e.union(r)})}function destroyStep(e,r){var t=e.r,n=(e.connection,e.getTypeCollection("Step")),o=e.getTypeCollection("Parameter");return r=_.isString(r)?[r]:r,n.filter(function(e){return t.expr(r).contains(e("id"))}).delete().do(function(){return o.filter(function(e){return t.expr(r).contains(e("parentId"))}).delete()}).do(function(){return!0})}function createStep(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Parameter"),i=e.getTypeCollection("Workflow"),d=this.globals._temporal,c=d.createTemporalStep,s=d.filterTemporalTask;if(_.includes(["START","END"],t.type))throw new graphql_error.GraphQLError("A "+t.type+" type can only be added during new workflow creation");if("TASK"===t.type&&!t.task)throw new graphql_error.GraphQLError("A step of type TASK must specifiy a published tasks recordId");return t.entityType="STEP",i.get(t.workflowId).eq(null).branch(a.error("Workflow "+t.workflowId+" does not exist"),a.expr(t.type).ne("TASK").branch(c(t)("changes").nth(0)("new_val"),s({recordId:t.task}).coerceTo("array").do(function(e){return e.count().eq(0).branch(a.error("The task specified does not have a current published version"),c(a.expr(t).merge({source:e.nth(0)("source")}))("changes").nth(0)("new_val"))}))).run(l).then(function(e){return"TASK"!==t.type?e:s({recordId:t.task}).nth(0)("id").do(function(r){return u.filter({parentId:r}).map(function(r){return r.merge({id:a.uuid(),scope:"STEP",parentId:e.id})}).forEach(function(e){return u.insert(e)}).do(function(){return e})}).run(l)})}}function readStepThreads(e){return function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(arguments[1],arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},arguments[3],e.r,e.connection),n=e.getTypeCollection("Step");switch(r.type){case"FORK":return n.filter({fork:r.id}).run(t);default:return[]}}}function readStep(e){return function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=(arguments[3],e.r),a=e.connection,l=e.getTypeCollection("Step"),u=this.globals._temporal.filterTemporalStep;if(n.date=t.date||n.date,r.step)return l.get(r.step).run(a);var i=u(t);return r.id&&(i=l.filter({workflowId:r.id}),t.first&&(i=i.filter({type:"START"}).nth(0).do(function(e){return l.get(e("success")).count().eq(0).branch(o.expr([]),o.expr([l.get(e("success"))]))}))),i.coerceTo("array").run(a)}}function updateStep(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Step");return isPublished(e,"Step",t.id).branch(a.error("This step is published and cannot be modified"),u.get(t.id).update(_.omit(t,"id")).do(function(){return u.get(t.id)})).run(l)}}function deleteStep(e){return function(r,t,n,o){var a=e.r,l=e.connection;return isPublished(e,"Step",t.id).branch(a.error("This step is published and cannot be deleted"),destroyStep(e,t.id)).run(l)}}function readSource(e){return function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(arguments[1],arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}),n=(arguments[3],e.r,e.connection),o=this.globals._temporal.filterTemporalTask,a=_.get(r,"task")||_.get(r,"task.id")||null;if(r.type!==TASK$1)return _.get(r,"source",null);var l=_.keys(r.versionArgs).length?r.versionArgs:_.merge(_.omit(t,["id","recordId"]),{recordId:a});return o(l).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0).hasFields("source").branch(e.nth(0)("source"),null))}).run(n)}}function readStepParams(e){return function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(arguments[1],arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}),n=(arguments[3],e.r),o=e.connection,a=this.globals._temporal,l=a.filterTemporalWorkflow,u=a.filterTemporalTask,i=e.getTypeCollection("Parameter");return t=_.omit(t,["recordId","id"]),n.expr(r).do(function(e){return n.expr([WORKFLOW$1,TASK$1]).contains(e("type")).branch(e.hasFields("versionArgs").branch(e("versionArgs").keys().count().ne(0).branch(e("versionArgs"),n.expr(t)),n.expr(t)).do(function(r){return n.branch(e("type").eq(WORKFLOW$1).and(e.hasFields("subWorkflow")),l(r.merge({recordId:e("subWorkflow")})),e("type").eq(TASK$1).and(e.hasFields("task")),u(r.merge({recordId:e("task")})),n.error("Temporal relation missing reference")).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0)("id"))})}),e("id")).do(function(e){return i.filter({parentId:e}).coerceTo("array")})}).run(o)}}function newStepRun$1(e,r,t){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=e.r,l=e.getTypeCollection("WorkflowRunThread"),u=e.getTypeCollection("Step"),i=e.getTypeCollection("StepRun"),d=e.getTypeCollection("ParameterRun"),c=e.getTypeCollection("Parameter"),s=e.getTypeCollection("WorkflowRun");return u.get(r.step).do(function(e){return e.eq(null).branch(a.error("Step does not exist"),t)}).do(function(e){return l.get(r.workflowRunThread).do(function(e){return e.eq(null).and(a.expr(o).eq(!0)).branch(a.error("Workflow Run Thread not found"),a.expr(r).hasFields("workflowRun").branch(a.expr(r)("workflowRun"),e("workflowRun")).do(function(e){return e.eq(null).branch(a.error("Unable to determine workflow run ID"),e)}))}).do(function(t){return s.get(t).do(function(o){return o.eq(null).branch(a.error("WorkflowRun not found"),c.filter({parentId:r.step,class:INPUT$2}).coerceTo("array").map(function(r){return{parameter:r("id"),parentId:e,value:r.hasFields("mapsTo").and(r("mapsTo").ne(null)).branch(d.filter({parentId:t,parameter:r("mapsTo")}).coerceTo("array").do(function(e){return e.count().gt(0).branch(e.nth(0)("value"),o("input").hasFields(r("name")).branch(o("input")(r("name")),r.hasFields("defaultValue").branch(r("defaultValue"),null)))}),o("input").hasFields(r("name")).branch(o("input")(r("name")),r.hasFields("defaultValue").branch(r("defaultValue"),null)))}}).do(function(e){return d.insert(e)}).do(function(){return i.insert({id:e,workflowRunThread:r.workflowRunThread,step:r.step,started:a.now(),status:CREATED$1,taskId:r.taskId},{returnChanges:n})}))})})})}function createStepRun(e){return function(r,t,n,o){var a=e.r,l=e.connection;return newStepRun$1(e,t,a.uuid())("changes").nth(0)("new_val").run(l)}}function startStepRun$1(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("StepRun");return t.started=a.now(),t.status=RUNNING$2,u.get(t.id).do(function(e){return e.eq(null).branch(a.error("StepRun not found"),e("status").ne(CREATED$1).branch(a.error("StepRun is not in a state that can be started"),u.get(t.id).update(_.omit(t,"id")).do(function(){return!0})))}).run(l)}}function setStepRunStatus$1(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("StepRun");return t.ended=a.now(),u.get(t.id).eq(null).branch(a.error("StepRun not found"),u.get(t.id).update(_.omit(t,"id")).do(function(){return!0})).run(l)}}function createForks(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("WorkflowRun"),i=e.getTypeCollection("WorkflowRunThread"),d=e.getTypeCollection("Step");return u.get(t.workflowRun).do(function(e){return e.eq(null).branch(a.error("Workflow run does not exist"),e)}).do(function(){return d.get(t.step).do(function(r){return r.eq(null).branch(a.error("Step does not exist"),r("type").ne(FORK).branch(a.error("Step is not a FORK"),d.filter({fork:r("id")}).coerceTo("array").map(function(e){return{threadId:a.uuid(),stepRunId:a.uuid(),step:e("id")}}).do(function(r){return r.forEach(function(r){return newStepRun$1(e,{workflowRun:t.workflowRun,step:r("step"),workflowRunThread:r("threadId")},r("stepRunId"),!1,!1)}).do(function(){return i.get(t.workflowRunThread).do(function(e){return e.eq(null).branch(a.error("Parent thread does not exist"),i.get(t.workflowRunThread).update({status:FORKED}))})}).do(function(){return r.map(function(e){return{id:e("threadId"),workflowRun:t.workflowRun,currentStepRun:e("stepRunId"),status:CREATED$1,parentThread:t.workflowRunThread}}).coerceTo("array").do(function(e){return i.insert(e,{returnChanges:!0})("changes")("new_val")})})})))})}).run(l)}}function getJoinThreads(e){return function(r,t,n,o){var a=(e.r,e.connection),l=e.getTypeCollection("WorkflowRunThread"),u=e.getTypeCollection("Step"),i=e.getTypeCollection("StepRun");return u.filter({join:t.step})("id").coerceTo("array").do(function(e){return l.filter({workflowRun:t.workflowRun}).merge(function(e){return{step:i.get(e("currentStepRun")).do(function(e){return u.get(e("step"))("id")})}}).filter(function(r){return e.contains(r("step"))}).coerceTo("array")}).run(a)}}function isNewId(e){return null!==e.match(/^new:/)}function mapIds(e,r,t){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",o={recordId:t.get(n).eq(null).branch(r.uuid(),t.get(n)("_temporal")("recordId"))};return o[e.id]=isNewId(e.id)?{op:INSERT,id:r.uuid()}:{op:UPDATE,id:e.id},_.forEach(e.parameters,function(e){o[e.id]=isNewId(e.id)?{op:INSERT,id:r.uuid()}:{op:UPDATE,id:e.id}}),_.forEach(e.steps,function(e){o[e.id]=isNewId(e.id)?{op:INSERT,id:r.uuid()}:{op:UPDATE,id:e.id},_.forEach(e.parameters,function(e){o[e.id]=isNewId(e.id)?{op:INSERT,id:r.uuid()}:{op:UPDATE,id:e.id}})}),o}function getOp(e,r,t){var n,o=_.get(e,r,{}),a=o.op,l=o.id;return n={},defineProperty(n,t+"Id",l),defineProperty(n,t+"Op",a),n}function syncWorkflow(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Parameter"),i=e.getTypeCollection("Workflow"),d=e.getTypeCollection("Step"),c=e.getTypeCollection("Folder"),s=e.getTypeCollection("FolderMembership"),p=t.owner||null,f=function(e,r){return _.merge(e,{_temporal:{recordId:r,name:"initial",validFrom:null,validTo:null,version:null,owner:p,changeLog:[{type:"CREATE",user:p,message:"created workflow"}]}})};return a.expr(mapIds(t,a,i,t.id)).run(l).then(function(e){var r,n=!1,o=[],p=[],y=[],m={},T=(r={},defineProperty(r,INSERT,{workflow:{},parameter:{},step:{}}),defineProperty(r,UPDATE,{workflow:{},parameter:{},step:{}}),r),S=getOp(e,t.id,"wf"),g=S.wfId,w=S.wfOp,b={id:g,entityType:WORKFLOW$2};return m[g]=[],w===INSERT&&(n=!0,f(b,e.recordId)),_.set(T,'["'+w+'"].workflow["'+g+'"]',_.merge({},_.omit(t,["parameters","steps","_temporal.owner","_temporal.name"]),b)),_.forEach(t.parameters,function(r){var t=getOp(e,r.id,"param"),n=t.paramId,o=t.paramOp;m[g].push(n),_.set(T,'["'+o+'"].parameter["'+n+'"]',_.merge({},r,{id:n,parentId:g,scope:ParameterScopeEnum.ATTRIBUTE,entityType:PARAMETER}))}),_.forEach(t.steps,function(r){var t=getOp(e,r.id,"step"),n=t.stepId,o=t.stepOp;m[n]=[],y.push(n);var a={id:n,success:_.get(e,'["'+r.success+'"].id',null),fail:_.get(e,'["'+r.fail+'"].id',null),task:_.get(r,"task._temporal.recordId"),subWorkflow:_.get(r,"subWorkflow._temporal.recordId"),entityType:STEP,workflowId:g};o===INSERT&&f(a),_.set(T,'["'+o+'"].step["'+n+'"]',_.merge({},_.omit(r,["threads","parameters"]),a)),_.forEach(r.parameters,function(r){var t=getOp(e,r.id,"param"),o=t.paramId,a=t.paramOp;m[n].push(o),_.set(T,'["'+a+'"].parameter["'+o+'"]',_.merge({},r,{id:o,parentId:n,mapsTo:_.get(e,'["'+r.mapsTo+'"].id',null),scope:ParameterScopeEnum.STEP,entityType:PARAMETER}))})}),_.forEach(t.steps,function(r){var t=getOp(e,r.id,"step"),n=t.stepId;r.threads.length&&p.push(n),_.forEach(r.threads,function(r){var t=getOp(e,r.id,"thread"),o=t.threadId;if(o){var a=_.get(T[INSERT].step,o)||_.get(T[UPDATE].step,o);a&&(a.fork=n)}})}),_.forEach(t.steps,function(r){var t=getOp(e,r.id,"step"),n=t.stepId,o=_.get(T[INSERT].step,n)||_.get(T[UPDATE].step,n);o.fork=_.includes(p,o.fork)?o.fork:null}),_.forEach(T,function(e,r){_.forEach(e,function(e,t){_.forEach(e,function(e,n){o.push({id:n,op:r,collection:t,data:e})})})}),a.expr(o).forEach(function(e){return e("op").eq(INSERT).branch(a.branch(e("collection").eq("workflow"),i.insert(e("data")),e("collection").eq("step"),d.insert(e("data")),u.insert(e("data"))),a.branch(e("collection").eq("workflow"),i.get(e("id")).update(e("data")),e("collection").eq("step"),d.get(e("id")).update(e("data")),u.get(e("id")).update(e("data"))))}).do(function(){return c.get(t.folder||"").ne(null).branch(a.expr(n).branch(s.insert({folder:t.folder,childId:e.recordId,childType:FolderType.WORKFLOW}),s.get(e.recordId).update({folder:t.folder})),c.filter({type:FolderType.WORKFLOW,parent:FolderType.ROOT}).nth(0).do(function(r){return a.expr(n).branch(s.insert({folder:r("id"),childId:e.recordId,childType:FolderType.WORKFLOW}),s.get(e.recordId).update({folder:r("id")}))}))}).do(function(){return d.filter({workflowId:g}).filter(function(e){return a.expr(y).contains(e("id")).not()}).forEach(function(e){return u.filter({parentId:e("id")}).delete().do(function(){return d.get(e("id")).delete()})})}).do(function(){var e=_.map(m,function(e,r){return{parentId:r,parameters:e}});return a.expr(e).forEach(function(e){return u.filter({parentId:e("parentId")}).filter(function(r){return e("parameters").contains(r("id")).not()}).delete()})}).do(function(){return i.get(g)}).run(l)})}}function isNewId$1(e){return null!==e.match(/^new:/)}function mapIds$1(e,r,t){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",o={recordId:t.get(n).eq(null).branch(r.uuid(),t.get(n)("_temporal")("recordId"))};return o[e.id]=isNewId$1(e.id)?{op:INSERT$1,id:r.uuid()}:{op:UPDATE$1,id:e.id},_.forEach(e.parameters,function(e){o[e.id]=isNewId$1(e.id)?{op:INSERT$1,id:r.uuid()}:{op:UPDATE$1,id:e.id}}),o}function getOp$1(e,r,t){var n,o=_.get(e,r,{}),a=o.op,l=o.id;return n={},defineProperty(n,t+"Id",l),defineProperty(n,t+"Op",a),n}function syncTask(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Task"),i=e.getTypeCollection("Parameter"),d=e.getTypeCollection("Folder"),c=e.getTypeCollection("FolderMembership"),s=t.owner||null,p=function(e,r){return _.merge(e,{_temporal:{recordId:r,name:"initial",validFrom:null,validTo:null,version:null,owner:s,changeLog:[{type:"CREATE",user:s,message:"created workflow"}]}})};return a.expr(mapIds$1(t,a,u,t.id)).run(l).then(function(e){var r,n=!1,o=[],s=[],f=(r={},defineProperty(r,INSERT$1,{task:{},parameter:{}}),defineProperty(r,UPDATE$1,{task:{},parameter:{}}),r),y=getOp$1(e,t.id,"task"),m=y.taskId,T=y.taskOp,S={id:m,entityType:TASK$2};return T===INSERT$1&&(n=!0,p(S,e.recordId)),_.set(f,'["'+T+'"].task["'+m+'"]',_.merge({},_.omit(t,["parameters","steps","_temporal.owner","_temporal.name"]),S)),_.forEach(t.parameters,function(r){var t=getOp$1(e,r.id,"param"),n=t.paramId,o=t.paramOp;s.push(n),_.set(f,'["'+o+'"].parameter["'+n+'"]',_.merge({},r,{id:n,parentId:m,scope:ParameterScopeEnum.TASK,entityType:PARAMETER$1}))}),_.forEach(f,function(e,r){_.forEach(e,function(e,t){_.forEach(e,function(e,n){o.push({id:n,op:r,collection:t,data:e})})})}),a.expr(o).forEach(function(e){return e("op").eq(INSERT$1).branch(a.branch(e("collection").eq("task"),u.insert(e("data")),i.insert(e("data"))),a.branch(e("collection").eq("task"),u.get(e("id")).update(e("data")),i.get(e("id")).update(e("data"))))}).do(function(){return d.get(t.folder||"").ne(null).branch(a.expr(n).branch(c.insert({folder:t.folder,childId:e.recordId,childType:FolderType$1.TASK}),c.get(e.recordId).update({folder:t.folder})),d.filter({type:FolderType$1.TASK,parent:FolderType$1.ROOT}).nth(0).do(function(r){return a.expr(n).branch(c.insert({folder:r("id"),childId:e.recordId,childType:FolderType$1.TASK}),c.get(e.recordId).update({folder:r("id")}))}))}).do(function(){return i.filter({parentId:m}).filter(function(e){return a.expr(s).contains(e("id")).not()}).delete()}).do(function(){return u.get(m)}).run(l)})}}function createTask(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Task"),i=this.globals._temporal.createTemporalTask;return t.entityType="TASK",u.filter(function(e){return e("name").match("(?i)^"+t.name+"$")}).count().ne(0).branch(a.error("A task with the name "+t.name+" already exists"),i(t)("changes").nth(0)("new_val")).run(l)}}function readTask(e){return function(r,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=(arguments[3],e.r),a=e.connection,l=_.get(r,"task")||_.get(r,"task.id"),u=this.globals._temporal,i=u.filterTemporalTask,d=u.mostCurrentTemporalTask;n.date=t.date||n.date;var c=o.expr(null);if(r)l&&(c=i({recordId:l,date:n.date}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0))}));else{if(!_.keys(t).length)return d().run(a);c=i(t)}return c.run(a)}}function readTaskVersions(e){return function(r,t){
var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},arguments[3],e.r,e.connection),o=e.getTypeCollection("Task"),a=o.filter({_temporal:{recordId:t.recordId}});return t.offset&&(a=a.skip(t.offset)),t.limit&&(a=a.limit(t.limit)),a.run(n)}}function updateTask(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Task");return isPublished(e,"Task",t.id).branch(a.error("This task is published and cannot be modified"),u.get(t.id).update(_.omit(t,"id")).do(function(){return u.get(t.id)})).run(l)}}function deleteTask(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Task"),i=e.getTypeCollection("Parameter"),d=e.getTypeCollection("Step");return isPublished(e,"Task",t.id).branch(a.error("This task is published and cannot be deleted"),d.filter(function(e){return e("task").eq(t.id).and(e("_temporal")("version").ne(null))}).count().ne(0).branch(a.error("This task belongs to a published step and cannot be deleted"),u.get(t.id).delete().do(function(){return i.filter({parentId:t.id}).delete().do(function(){return!0})}))).run(l)}}function getFullWorkflow(e,r){var t=e.r,n=(e.connection,e.getTypeCollection("Workflow")),o=e.getTypeCollection("Parameter"),a=e.getTypeCollection("Step");return n.get(r.id).eq(null).branch(t.error("Invalid workflow version"),n.get(r.id).merge(function(e){return{parameters:o.filter({parentId:r.id}).coerceTo("array"),steps:a.filter({workflowId:e("id")}).coerceTo("array").merge(function(e){return{parameters:o.filter({parentId:e("id")}).coerceTo("array")}})}}))}function getNewUuids(e,r,t){var n="fork"===e?["FORKID"]:[];return n.push(t.id),_.forEach(t.parameters,function(e){return n.push(e.id)}),_.forEach(t.steps,function(e){n.push(e.id),_.forEach(e.parameters,function(e){return n.push(e.id)})}),r.expr(n).map(function(e){return{orig:e,cur:r.uuid()}})}function remapObjects(e,r){var t=[],n=[],o=_.merge({},_.omit(e,["steps","parameters"]));return r.FORKID&&(o._temporal.recordId=r.FORKID),o._temporal.version=null,o._temporal.validFrom=null,o._temporal.validTo=null,o._temporal.changeLog=_.isArray(e._temporal.changeLog)?e._temporal.changeLog:[],o.id=r[e.id],_.forEach(e.parameters,function(e){n.push(_.merge({},e,{id:r[e.id],parentId:r[e.parentId]}))}),_.forEach(e.steps,function(e){var o=_.merge({},e);o._temporal.version=null,o._temporal.validFrom=null,o._temporal.validTo=null,o.id=_.get(r,e.id,null),o.workflowId=_.get(r,e.workflowId,null),o.success=_.get(r,e.success,null),o.fork=_.get(r,e.fork,null),o.fail=_.get(r,e.fail,null),t.push(o),_.forEach(e.parameters,function(e){n.push(_.merge({},e,{id:r[e.id],parentId:r[e.parentId]}))})}),{newWorkflow:o,newParams:n,newSteps:t}}function cloneWorkflow(e,r,t){var n=r.r,o=r.connection,a=r.getTypeCollection("Workflow"),l=r.getTypeCollection("Parameter"),u=r.getTypeCollection("Step"),i={};return getFullWorkflow(r,t).run(o).then(function(r){return getNewUuids(e,n,r).run(o).then(function(d){_.forEach(d,function(e){return i[e.orig]=e.cur});var c=remapObjects(r,i,t),s=c.newWorkflow,p=c.newSteps,f=c.newParams;return s._temporal.name=t.name||s.id,s._temporal.owner=t.owner||null,s._temporal.changeLog.push(_.merge(t.changeLog||{user:"SYSTEM",message:e},{date:n.now(),type:"branch"===e?"BRANCH":"FORK"})),n.expr([l.insert(f),u.insert(p)]).do(function(){return a.insert(s,{returnChanges:!0})("changes").nth(0)("new_val")}).run(o)})})}function branchWorkflow(e){return function(r,t,n,o){return cloneWorkflow("branch",e,t)}}function forkWorkflow(e){return function(r,t,n,o){return cloneWorkflow("fork",e,t)}}function publishWorkflow(e){return function(r,t,n,o){var a=(e.r,e.connection),l=e.getTypeCollection("Step"),u=e.getTypeComputed("Workflow").collection,i=this.globals._temporal.extendPublish;return i(u,t).then(function(e){var r=e._temporal,t=r.version,n=r.validFrom,o=r.validTo,u=e.id;return l.filter({workflowId:u}).update({_temporal:{version:t,validFrom:n,validTo:o}}).run(a).then(function(){return e})})}}function readWorkflowInputs(e){return function(r,t){var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},arguments[3],e.r,e.connection),o=e.getTypeCollection("Parameter"),a=e.getTypeCollection("Step");return getWorkflowInputs(a,o,r.id).run(n)}}function createWorkflow(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=this.globals._temporal,i=u.createTemporalWorkflow,d=u.createTemporalStep;return a.do(a.uuid(),a.uuid(),a.uuid(),function(e,r,n){return t.id=e,t.entityType="WORKFLOW",d([{id:r,entityType:"STEP",name:"Start",description:"Starting point of the workflow",type:"START",timeout:0,failsWorkflow:!1,waitOnSuccess:!1,requireResumeKey:!1,success:n,fail:n,workflowId:e},{id:n,entityType:"STEP",name:"End",description:"Ending point of the workflow",type:"END",timeout:0,failsWorkflow:!1,waitOnSuccess:!1,requireResumeKey:!1,success:n,fail:n,workflowId:e}]).do(function(){return i(t)("changes").nth(0)("new_val")})}).run(l)}}function readWorkflow(e){return function(r,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=(arguments[3],e.r),a=e.connection,l=e.getTypeCollection("Workflow"),u=this.globals._temporal,i=u.filterTemporalWorkflow,d=u.mostCurrentTemporalWorkflow;n.date=t.date||n.date;var c=o.expr(null);if(_.isEmpty(r)){if(!_.keys(t).length)return d().run(a);c=i(t)}else{if(r.workflow)return l.get(r.workflow).run(a);r.subWorkflow&&(c=i({recordId:r.subWorkflow,date:n.date}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0))}))}return c.run(a)}}function readWorkflowVersions(e){return function(r,t){var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},arguments[3],e.r,e.connection),o=e.getTypeCollection("Workflow"),a=o.filter({_temporal:{recordId:t.recordId}});return t.offset&&(a=a.skip(t.offset)),t.limit&&(a=a.limit(t.limit)),a.run(n)}}function updateWorkflow(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Workflow");return isPublished(e,"Workflow",t.id).branch(a.error("This workflow is published and cannot be modified"),u.get(t.id).update(_.omit(t,"id")).do(function(){return u.get(t.id)})).run(l)}}function deleteWorkflow(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("Workflow"),i=e.getTypeCollection("Parameter"),d=e.getTypeCollection("Step");return isPublished(e,"Workflow",t.id).branch(a.error("This workflow is published and cannot be deleted"),d.filter({workflowId:t.id}).map(function(e){return e("id")}).coerceTo("array").do(function(r){return destroyStep(e,r)}).do(function(){return i.filter({parentId:t.id}).delete()}).do(function(){return u.get(t.id).delete().do(function(){return!0})})).run(l)}}function readWorkflowParameters(e){return function(r,t,n,o){var a=(e.r,e.connection),l=e.getTypeCollection("Parameter");return l.filter({parentId:r.id,class:ATTRIBUTE$1}).run(a)}}function readEndStep(e){return function(r,t,n,o){var a=(e.r,e.connection),l=e.getTypeCollection("Step");return l.filter({workflowId:r.id,type:END$1}).coerceTo("array").do(function(e){return e.count().eq(0).branch(null,e.nth(0))}).run(a)}}function firstStep(e,r,t){return first(r.filter({workflowId:t,type:START}),e.error("no start step found")).do(function(t){return r.get(t("success")).do(function(r){return e.branch(r.eq(null),e.error("no first step found, make sure all steps have connections"),r("type").eq(END$2),e.error("start is directly connected to end and cannot determine the first step task"),r)})})}function createWorkflowRun(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("WorkflowRun"),i=e.getTypeCollection("Parameter"),d=e.getTypeCollection("ParameterRun"),c=e.getTypeCollection("Step"),s=e.getTypeCollection("StepRun"),p=e.getTypeCollection("WorkflowRunThread"),f=this.globals._temporal.filterTemporalWorkflow,y=_.isObject(t.input)?t.input:{};return first(f(t.args),a.error("wokflow not found")).merge(function(e){return{inputs:getWorkflowInputs(c,i,e("id")).coerceTo("array"),parameters:i.filter({parentId:e("id"),class:ATTRIBUTE$2}).coerceTo("array"),step:firstStep(a,c,e("id")).merge(function(e){return{subWorkflow:e.hasFields("subWorkflow").branch(first(f(a.expr(t).merge(function(){return{recordId:e("_temporal")("recordId")}},e.hasFields("versionArgs").branch(e("versionArgs"),{}))),null),null),parameters:i.filter({parentId:e("id")}).coerceTo("array")}})}}).run(l).then(function(e){var r=!0,n=!1,o=void 0;try{for(var i,c=e.inputs[Symbol.iterator]();!(r=(i=c.next()).done);r=!0){var f=i.value;if(f.required&&!_.has(y,f.name))throw new Error("missing required input "+f.name);_.has(y,f.name)&&(y[f.name]=convertType(f.type,f.name,y[f.name]))}}catch(e){n=!0,o=e}finally{try{!r&&c.return&&c.return()}finally{if(n)throw o}}return a.do(a.now(),a.uuid(),a.uuid(),a.uuid(),function(r,n,o,a){return u.insert({id:n,workflow:e.id,args:t.args,input:y,started:r,status:"RUNNING",taskId:t.taskId,parentStepRun:t.parent},{returnChanges:!0})("changes").nth(0)("new_val").do(function(r){return p.insert({id:a,workflowRun:n,currentStepRun:o,status:"CREATED"}).do(function(){return _.isArray(e.parameters)&&e.parameters.length?d.insert(_.map(e.parameters,function(e){return{parameter:e.id,parentId:n,class:e.class,value:_.get(e,"defaultValue")}})):null}).do(function(){return s.insert({id:o,workflowRunThread:a,step:e.step.id,status:"CREATED",taskId:t.taskId})}).do(function(){if(!e.step.parameters.length)return null;var r=[];return _.forEach(e.step.parameters,function(t){var n=null;if(t.mapsTo)n=_.get(_.find(e.parameters,{id:t.mapsTo}),"defaultValue");else if(!t.mapsTo&&_.has(y,t.name))try{n=convertType(t.type,t.name,_.get(y,t.name))}catch(e){}r.push({parameter:t.id,parentId:o,class:t.class,value:n})}),d.insert(r)}).do(function(){return r})})}).run(l)})}}function updateWorkflowRun(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("WorkflowRun");return u.get(t.id).eq(null).branch(a.error("WorkflowRun not found"),u.get(t.id).update(_.omit(t,"id")).do(function(){return u.get(t.id)})).run(l)}}function deleteWorkflowRun(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("WorkflowRun");return u.get(t.id).eq(null).branch(a.error("WorkflowRun not found"),u.get(t.id).delete().do(function(){return!0})).run(l)}}function endWorkflowRun$1(e){return function(r,t,n,o){var a=e.r,l=e.connection,u=e.getTypeCollection("WorkflowRun");return t.ended=a.now(),u.get(t.id).eq(null).branch(a.error("WorkflowRun not found"),u.get(t.id).update(_.omit(t,"id")).do(function(){return!0})).run(l)}}function readWorkflowRunThread(e){return function(r,t,n,o){var a=(e.r,e.connection),l=e.getTypeCollection("WorkflowRunThread");return r&&r.workflowRunThread?l.get(r.workflowRunThread).run(a):_.isArray(o.path)&&o.path.join(".").match(/threads$/)&&r&&r.id?l.filter({workflowRun:r.id}).run(a):t.id?l.filter({id:t.id}).run(a):l.run(a)}}function endWorkflow(e,r){var t=this;try{var n=function(){var n=e.workflowRun,o=e.thread,a=[],l=[];return{v:updateWorkflowRunThread(t,{id:o,status:"Enum::"+ENDING$1},function(u){return u?r(u):getRunThreads(t,n,function(n,u){return n?r(n):(_.forEach(u,function(e){_.includes(RUNNING_STATES$1,e.status)?l.push(e.id):e.status===ENDING$1&&a.push(e.id)}),l.length||!winTieBreak(o,a)?updateWorkflowRunThread(t,{id:o,status:"Enum::"+JOINED$2},function(e){return e?r(e):r()}):computeWorkflowStatus.call(t,e,r))})})}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){this.log.error({errors:e.message||e,stack:e.stack},"Failed to end workflow"),r(e)}}function handleContext(e,r){var t=this;return function(n){try{var o=function(){var o=[],a=(e.runner,e.workflowRun),l=e.thread,u=e.endStep,i=(e.localCtx,e.context),d=(e.args,e.step),c=e.stepRunId,s=d.async,p=(d.source,d.timeout,d.failsWorkflow,d.waitOnSuccess,d.success),f=d.fail,y=d.parameters;f=f||u;var m=n._exception||n._result===!1,T=m?f:p,S=m?FAIL$1:SUCCESS$2;switch(d.type){case CONDITION$1:S=SUCCESS$2;break;case LOOP$2:S=SUCCESS$2}return _.forEach(y,function(e){if(e.class===OUTPUT$1&&_.has(n,e.name)&&_.has(e,"mapsTo"))try{var r=_.find(i,{parameter:{id:e.mapsTo,class:ATTRIBUTE$3}});if(!r)return;o.push({id:r.id,value:convertType(e.type,e.name,_.get(n,e.name))})}catch(e){t.log.warn({error:e},"type conversion failed so value will not be set")}}),{v:updateAttributeValues(t,o,function(n){return n?r(n):d.waitOnSuccess&&S===SUCCESS$2?setStepRunStatus(t,c,WAITING$1,function(e){if(e)return r(e)}):setStepRunStatus(t,c,S,function(n){return n?r(n):T===u?endWorkflow.call(t,e,r):s?r():nextStepRun.call(t,{thread:l,workflowRun:a,nextStep:T,async:s},r)})})}}();if("object"===("undefined"==typeof o?"undefined":_typeof(o)))return o.v}catch(e){t.log.error({errors:e.message||e,stack:e.stack},"Failed to handle context"),r(e)}}}function basicRun(e){var r=this,t=e.source,n=e.context,o=e.timeout,a=e.payload,l=e.done,u=_.merge({context:n,timeout:o},_.get(this.options,"vm",{}));return sbx.vm(t,u,function(e,t){return e?l(e):handleContext.call(r,a,l)(t)})}function loopRun(e){var r=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=e.source,o=e.context,a=e.timeout,l=e.payload,u=e.done,i=_.merge({context:o,timeout:a},_.get(this.options,"vm",{}));return o.loop=t,sbx.vm(n,i,function(e,o){return e?u(e):o._result===!1||o._exception?handleContext.call(r,l,u)(o):loopRun.call(r,{source:n,context:o,timeout:a,payload:l,done:u},t++)})}function runSource(e,r){var t=this;try{var n=function(){var n=e.thread,o=e.endStep,a=e.localCtx,l=e.step,u=e.workflowRun,i=l.async,d=l.source,c=l.timeout,s=l.success;return d?{v:updateWorkflowRunThread(t,{id:n,status:"Enum::"+RUNNING$3},function(p){if(p)return r(p);var f={source:d,context:a,timeout:c,payload:e,done:r},y=l.type===LOOP$1?loopRun.call(t,f):basicRun.call(t,f);return i&&s!==o?nextStepRun.call(t,{thread:n,workflowRun:u,nextStep:s,async:i},r):y})}:{v:r(new Error("No source"))}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){this.log.error({errors:e.message||e,stack:e.stack},"Failed to run source step"),r(e)}}function forkSteps(e,r){var t=this;try{var n=function(){var n=e.workflowRun,o=e.thread,a=e.stepRunId,l=e.step.id,u=_.get(t,"server._emitter");return u?{v:newForks(t,l,n,o,function(e,o){return e?r(e):setStepRunStatus(t,a,FORKED$1,function(e){return e?r(e):(_.forEach(o,function(e){u.emit("schedule",{payload:{action:"runStep",context:{thread:e.id,workflowRun:n}}})}),r())})})}:{v:r(new Error("no event emitter"))}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){this.log.error({errors:e.message||e,stack:e.stack},"Failed to fork step"),r(e)}}function runSubWorkflow(e,r){var t=this;try{var n=function(){var n=e.runner,o=e.taskId,a=e.thread,l=e.localCtx,u=e.args,i=e.step,d=e.stepRunId,c=i.subWorkflow;return{v:updateWorkflowRunThread(t,{id:a,status:"Enum::"+RUNNING$5},function(e){return e?r(e):startWorkflow(t)(n,{id:o,context:{args:{recordId:_.get(c,"_temporal.recordId"),date:u.date,version:u.version},input:l,parent:d}},function(e){if(e)return r(e)})})}}();if("object"===("undefined"==typeof n?"undefined":_typeof(n)))return n.v}catch(e){return this.log.error({errors:e.message||e,stack:e.stack},"Failed to run sub workflow"),r(e)}}function runStep(e){return function(r,t,n){try{var o=function(){var o=t.resume,a=t.context,l=a.workflowRun,u=a.thread,i=t.id,d=_.get(t,"data.context",{});return l&&u?{v:getWorkflowRun(e,l,u,function(a,c){if(a)return n(a);var s=c.workflow,p=c.args,f=c.input,y=c.context,m=c.threads,T=_.get(m,"[0].currentStepRun.step"),S=_.get(m,"[0].currentStepRun.id"),g=_.get(s,"endStep.id");if(!T)return n(new Error("No step found in thread"));if(!g)return n(new Error("No end step found"));e.log.trace({step:T.id,type:T.type},"successfully read step");var w=mapInput(f,y,_.get(T,"parameters",[]));w._resumeKey=S,w._taskId=i;var b={runner:r,task:t,taskId:i,workflowRun:l,thread:u,endStep:g,localCtx:w,context:y,args:p,step:T,stepRunId:S};return o?handleContext.call(e,b,n)(d):startStepRun(e,S,i,function(r){if(r)return n(r);switch(T.type){case BASIC$1:return runSource.call(e,b,n);case TASK$4:return runSource.call(e,b,n);case LOOP:return runSource.call(e,b,n);case CONDITION:return runSource.call(e,b,n);case JOIN$1:return joinThreads.call(e,b,n);case WORKFLOW$4:return runSubWorkflow.call(e,b,n);case FORK$1:return forkSteps.call(e,b,n);default:return n(new Error("Invalid step type or action cannot be performed on type"))}})})}:{v:n(new Error("No workflow run or main thread created"))}}();if("object"===("undefined"==typeof o?"undefined":_typeof(o)))return o.v}catch(r){return e.log.error({errors:r.message||r,stack:r.stack},"Failed to start step"),n(r)}}}function startWorkflow(e){return function(r,t,n){try{var o=function(){var o=t.context,a=o.args,l=o.input,u=o.parent,i=t.id;return a?{v:newWorkflowRun(e,{args:a,input:l,taskId:i,parent:u},function(t,o){if(t)return n(t);var a=_.get(o,"id"),l=_.get(o,"threads[0].id");return runStep(e)(r,{id:i,context:{workflowRun:a,thread:l}},n)})}:{v:n(new Error("No arguments were supplied"))}}();if("object"===("undefined"==typeof o?"undefined":_typeof(o)))return o.v}catch(r){return e.log.error({errors:r.message||r,stack:r.stack},"Failed to start workflow"),n(r)}}}Object.defineProperty(exports,"__esModule",{value:!0});var _=_interopDefault(require("lodash")),chalk=require("chalk"),yellowjacket=require("yellowjacket"),FactoryTemporalPlugin=_interopDefault(require("graphql-factory-temporal")),graphqlFactoryTemporal_backend=require("graphql-factory-temporal/backend"),obj2arg=_interopDefault(require("graphql-obj2arg")),graphql_error=require("graphql/error"),sbx=_interopDefault(require("sbx")),S2FDescribed={description:{type:"String"}},S2FEntity={id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"}},S2FNamed={name:{type:"String"}},fields={S2FDescribed:S2FDescribed,S2FEntity:S2FEntity,S2FNamed:S2FNamed},EntitySummary={fields:{id:"String",branchId:"String",version:"String",name:"String",description:"String"}},EntityTypeEnum={type:"Enum",values:{PARAMETER:"PARAMETER",PARAMETERRUN:"PARAMETERRUN",STEP:"STEP",STEPRUN:"STEPRUN",TASK:"TASK",WORKFLOW:"WORKFLOW",WORKFLOWRUN:"WORKFLOWRUN",RUNQUEUE:"RUNQUEUE",FOLDER:"FOLDER"}},Folder={fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String",nullable:!1},parent:{type:"String",nullable:!1},type:{type:"FolderChildTypeEnum",nullable:!1}},_backend:{schema:"S2FWorkflow",collection:"folder",query:{readRootFolder:{type:"FolderView",args:{type:{type:"FolderChildTypeEnum",nullable:!1}},resolve:"readRootFolder"},readSubFolder:{type:"FolderView",args:{id:{type:"String",nullable:!1}},resolve:"readSubFolder"}}}},FolderChildTypeEnum={type:"Enum",values:{ROOT:"ROOT",WORKFLOW:"WORKFLOW",TASK:"TASK"}},FolderMembership={fields:{childId:{type:"String",primary:!0},folder:{type:"String"},childType:{type:"FolderChildTypeEnum"}},_backend:{schema:"S2FWorkflow",collection:"folder_membership"}},FolderView={fields:{id:"String",name:"String",parent:"String",type:"FolderChildTypeEnum",subFolders:["Folder"],entities:["EntitySummary"]}},Parameter={type:["Object","Input"],fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String"},description:{type:"String"},type:{description:"The data type of the parameter",type:"ParameterTypeEnum",nullable:!1},scope:{description:"The scope of the parameter",type:"ParameterScopeEnum",nullable:!1,omitFrom:"Input"},class:{description:"Class of parameter",type:"ParameterClassEnum"},required:{description:"Parameter is required",type:"Boolean",nullable:!1},mapsTo:{description:"Name of global context parameter to map",type:"String"},defaultValue:{description:"Default value",type:"String"},parentId:{description:"Object the parameter belongs to",type:"String",belongsTo:{Workflow:{parameters:"id"},Step:{parameters:"id"},Task:{parameters:"id"}}}},_backend:{schema:"S2FWorkflow",collection:"parameter",mutation:{create:{resolve:"createParameter"},update:{resolve:"updateParameter"},delete:{resolve:"deleteParameter"}}}},ParameterClassEnum={type:"Enum",values:{ATTRIBUTE:"ATTRIBUTE",INPUT:"INPUT",OUTPUT:"OUTPUT"}},ParameterRun={fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},parameter:{type:"Parameter",has:"id"},parentId:{type:"String",belongsTo:{WorkflowRun:{context:"id"},StepRun:{context:"id"}}},value:{type:"FactoryJSON"}},_backend:{schema:"S2FWorkflow",collection:"parameter_run",mutation:{create:{type:"ParameterRun",args:{parameter:{type:"String",nullable:!1},parentId:{type:"String",nullable:!1},value:{type:"FactoryJSON"}},resolve:"createParameterRun"},update:{type:"ParameterRun",args:{id:{type:"String",nullable:!1},value:{type:"FactoryJSON"}},resolve:"updateParameterRun"},delete:{args:{id:{type:"String",nullable:!1}},resolve:"deleteParameterRun"},updateAttributeValues:{type:"Boolean",args:{values:{type:["ParameterRunValueInput"],nullable:!1}},resolve:"updateAttributeValues"}}}},ParameterRunValueInput={type:"Input",fields:{id:{type:"String"},value:{type:"FactoryJSON"}}},ParameterTypeEnum={type:"Enum",values:{ARRAY:"ARRAY",BOOLEAN:"BOOLEAN",DATE:"DATE",NUMBER:"NUMBER",OBJECT:"OBJECT",STRING:"STRING",PASSWORD:"PASSWORD"}},ParameterScopeEnum={type:"Enum",values:{WORKFLOW:"WORKFLOW",STEP:"STEP",TASK:"TASK"}},RunStatusEnum={type:"Enum",values:{CREATED:"CREATED",RUNNING:"RUNNING",WAITING:"WAITING",JOINING:"JOINING",FORKING:"FORKING",SUCCESS:"SUCCESS",FAIL:"FAIL",FORKED:"FORKED",JOINED:"JOINED",ENDING:"ENDING",ENDED:"ENDED"}},Step={extendFields:["TemporalType"],fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String"},description:{type:"String"},workflowId:{description:"Workflow the step belongs to",type:"String",nullable:!1,belongsTo:{Workflow:{steps:"id"}}},type:{description:"Step type (condition, loop, fork, join, workflow, task, etc...)",type:"StepTypeEnum",nullable:!1},async:{description:"Step runs asynchronously",type:"Boolean"},source:{description:"Source code to run. Can be null if a task or subworkflow is being used",type:"String",resolve:"readSource"},task:{description:"Published task to use as source for execution code",type:"Task",has:"id",resolve:"readTask"},subWorkflow:{description:"Nested workflow to run",type:"Workflow",has:"id",resolve:"readWorkflow"},versionArgs:{description:"Lock a task or subworkflow into a specific version",type:"FactoryJSON"},timeout:{description:"Time in ms to allow the step to run before timing out",type:"Int"},failsWorkflow:{description:"If true and this step fails, the workflow will be considered failed",type:"Boolean",nullable:!1},waitOnSuccess:{description:"On successful step completion wait for external input to resume",type:"Boolean",nullable:!1},requireResumeKey:{description:"Used with waitOnSuccess. The StepRun key is required to initiate a workflow resume",type:"Boolean",nullable:!1},success:{description:"Step to execute on success",type:"String"},fail:{description:"Step to execute on failure, defaults to end",type:"String"},parameters:{description:"Local parameters associated with the step",type:["Parameter"],resolve:"readParameter"},fork:{type:"String",belongsTo:{Step:{threads:"id"}}},threads:{description:"Keeps track of the forked threads for a fork or the threads that will join if a join",type:["Step"],resolve:"readStepThreads"},ex:{description:"Extension data, can be used by plugins for example ui positioning information",type:"FactoryJSON"}},_backend:{schema:"S2FWorkflow",collection:"step",temporal:!0,query:{read:{resolve:"readStep"}},mutation:{create:{type:"Step",args:{workflowId:{type:"String",nullable:!1},name:{type:"String",nullable:!1},type:{type:"StepTypeEnum",nullable:!1},async:{type:"Boolean",defaultValue:!1},source:{type:"String"},task:{type:"String"},subWorkflow:{type:"String"},timeout:{type:"Int",defaultValue:0},failsWorkflow:{type:"Boolean",defaultValue:!1},waitOnSuccess:{type:"Boolean",defaultValue:!1},requireResumeKey:{type:"Boolean",defaultValue:!1},success:{type:"String"},fail:{type:"String"}},resolve:"createStep"},update:{type:"Step",args:{id:{type:"String",nullable:!1},name:{type:"String"},async:{type:"Boolean"},source:{type:"String"},task:{type:"String"},subWorkflow:{type:"String"},timeout:{type:"Int"},failsWorkflow:{type:"Boolean"},waitOnSuccess:{type:"Boolean"},requireResumeKey:{type:"Boolean"},success:{type:"String"},fail:{type:"String"}},resolve:"updateStep"},delete:{type:"Boolean",args:{id:{type:"String",nullable:!1}},resolve:"deleteStep"}}}},StepInput={type:"Input",fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String"},description:{type:"String"},type:{description:"Step type (condition, loop, fork, join, workflow, task, etc...)",type:"StepTypeEnum",nullable:!1},async:{description:"Step runs asynchronously",type:"Boolean"},source:{description:"Source code to run. Can be null if a task or subworkflow is being used",type:"String"},subWorkflow:{description:"Nested workflow to run",type:"String"},timeout:{description:"Time in ms to allow the step to run before timing out",type:"Int",nullable:!1},failsWorkflow:{description:"If true and this step fails, the workflow will be considered failed",type:"Boolean",nullable:!1},waitOnSuccess:{description:"On successful step completion wait for external input to resume",type:"Boolean",nullable:!1},requireResumeKey:{description:"Used with waitOnSuccess. The StepRun key is required to initiate a workflow resume",type:"Boolean",nullable:!1},success:{description:"Step to execute on success",type:"String"},fail:{description:"Step to execute on failure, defaults to end",type:"String"},parameters:{type:["ParameterInput"]}}},StepRun={fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},workflowRunThread:{type:"String",belongsTo:{WorkflowRunThread:{stepRuns:"id"}}},thread:{type:"WorkflowRunThread",resolve:"readWorkflowRunThread"},context:{type:["ParameterRun"]},step:{description:"The step associated with this run",type:"Step",has:"id"},started:{type:"FactoryDateTime"},ended:{type:"FactoryDateTime"},status:{type:"RunStatusEnum"},taskId:{type:"String"}},_backend:{schema:"S2FWorkflow",collection:"step_run",mutation:{create:{type:"StepRun",args:{step:{type:"String",nullable:!1},workflowRunThread:{type:"String",nullable:!1},taskId:{type:"String"}},resolve:"createStepRun"},update:{type:"StepRun",args:{id:{type:"String",nullable:!1},status:{type:"RunStatusEnum"},taskId:{type:"String"},ended:{type:"FactoryDateTime"}}},delete:{type:"Boolean",args:{id:{type:"String",nullable:!1}}},startStepRun:{type:"Boolean",args:{id:{type:"String",nullable:!1},taskId:{type:"String"}},resolve:"startStepRun"},setStepRunStatus:{type:"Boolean",args:{id:{type:"String",nullable:!1},status:{type:"RunStatusEnum",nullable:!1}},resolve:"setStepRunStatus"},createForks:{type:["WorkflowRunThread"],args:{step:{type:"String",nullable:!1},workflowRun:{type:"String",nullable:!1},workflowRunThread:{type:"String",nullable:!1}},resolve:"createForks"},getJoinThreads:{type:["WorkflowRunThread"],args:{step:{type:"String",nullable:!1},workflowRun:{type:"String",nullable:!1}},resolve:"getJoinThreads"}}}},StepTypeEnum={type:"Enum",values:{BASIC:"BASIC",CONDITION:"CONDITION",END:"END",FORK:"FORK",JOIN:"JOIN",LOOP:"LOOP",START:"START",TASK:"TASK",WORKFLOW:"WORKFLOW"}},SyncIdInput={type:"Input",fields:{id:{type:"String",nullable:!1}}},SyncParameterInput={type:"Input",fields:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},description:{type:"String"},type:{type:"ParameterTypeEnum",nullable:!1},scope:{type:"ParameterScopeEnum",nullable:!1},class:{type:"ParameterClassEnum",nullable:!1},required:{type:"Boolean"},mapsTo:{type:"String"},defaultValue:{type:"String"}}},SyncStepInput={type:"Input",fields:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},description:{type:"String"},type:{type:"StepTypeEnum",nullable:!1},async:"Boolean",source:"String",versionArgs:"FactoryJSON",timeout:"Int",failsWorkflow:"Boolean",waitOnSuccess:"Boolean",requireResumeKey:"Boolean",parameters:["SyncParameterInput"],task:"SyncTemporalInput",subWorkflow:"SyncTemporalInput",success:"String",fail:"String",ex:"FactoryJSON",threads:["SyncIdInput"]}},SyncTemporalInput={type:"Input",fields:{_temporal:{type:"SyncTemporalMetadataInput"},id:{type:"String"}}},SyncTemporalMetadataInput={type:"Input",fields:{recordId:{type:"String"}}},Task={extendFields:["TemporalType"],fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String"},description:{type:"String"},source:{type:"String",nullable:!1},parameters:{type:["Parameter"],resolve:"readParameter"}},_backend:{schema:"S2FWorkflow",collection:"task",temporal:!0,query:{read:{type:["Task"],args:{recordId:{type:"String"},id:{type:"String"},version:{type:"String"},date:{type:"FactoryDateTime"}},resolve:"readTask"},readTaskVersions:{type:["Task"],args:{recordId:{type:"String",nullable:!1},limit:{type:"Int"},offset:{type:"Int"}},resolve:"readTaskVersions"}},mutation:{create:{type:"Task",args:{name:{type:"String",nullable:!1},description:{type:"String"},source:{type:"String",nullable:!1}},resolve:"createTask"},update:{type:"Task",args:{id:{type:"String",nullable:!1},name:{type:"String"},description:{type:"String"},source:{type:"String"}},resolve:"updateTask"},delete:{type:"Boolean",args:{id:{type:"String",nullable:!1}},resolve:"deleteTask"},branchTask:{type:"Task",args:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},owner:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"branchTemporalTask"},forkTask:{type:"Task",args:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},owner:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"forkTemporalTask"},publishTask:{type:"Task",args:{id:{type:"String",nullable:!1},version:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"publishTemporalTask"},syncTask:{type:"Task",args:{owner:{type:"String"},id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},description:{type:"String"},source:{type:"String",nullable:!1},folder:{type:"String"},parameters:["SyncParameterInput"]},resolve:"syncTask"}}}},Workflow={extendFields:["TemporalType"],fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},name:{type:"String"},description:{type:"String"},folder:{type:"String",resolve:"readWorkflowFolder"},inputs:{description:"Inputs from steps",type:["Parameter"],args:{id:{type:"String"}},resolve:"readWorkflowInputs"},parameters:{description:"Global parameters",type:["Parameter"],args:{id:{type:"String"}},resolve:"readParameter"},steps:{description:"Steps in the workflow",type:["Step"],args:{id:{type:"String"},first:{type:"Boolean"}},resolve:"readStep"},endStep:{type:"Step",resolve:"readEndStep"}},_backend:{schema:"S2FWorkflow",collection:"workflow",temporal:!0,query:{read:{type:["Workflow"],args:{recordId:{type:"String"},id:{type:"String"},version:{type:"String"},date:{type:"FactoryDateTime"}},resolve:"readWorkflow"},readWorkflowVersions:{type:["Workflow"],args:{recordId:{type:"String",nullable:!1},limit:{type:"Int"},offset:{type:"Int"}},resolve:"readWorkflowVersions"}},mutation:{create:{type:"Workflow",args:{name:{type:"String",nullable:!1},description:{type:"String"}},resolve:"createWorkflow"},update:{type:"Workflow",args:{name:{type:"String"},description:{type:"String"}},resolve:"updateWorkflow"},delete:{type:"Boolean",args:{id:{type:"String",nullable:!1}},resolve:"deleteWorkflow"},branchWorkflow:{type:"Workflow",args:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},owner:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"branchWorkflow"},forkWorkflow:{type:"Workflow",args:{id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},owner:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"forkWorkflow"},publishWorkflow:{type:"Workflow",args:{id:{type:"String",nullable:!1},version:{type:"String"},changeLog:{type:"TemporalChangeLogInput"}},resolve:"publishWorkflow"},syncWorkflow:{type:"Workflow",args:{owner:{type:"String"},
id:{type:"String",nullable:!1},name:{type:"String",nullable:!1},description:{type:"String"},folder:{type:"String"},parameters:["SyncParameterInput"],steps:["SyncStepInput"]},resolve:"syncWorkflow"}}}},WorkflowRun={fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},workflow:{type:"Workflow",has:"id",resolve:"readWorkflow"},args:{type:"FactoryJSON"},input:{type:"FactoryJSON"},context:{type:["ParameterRun"],resolve:"readParameterRun"},threads:{type:["WorkflowRunThread"],resolve:"readWorkflowRunThread"},started:{type:"FactoryDateTime"},ended:{type:"FactoryDateTime"},status:{type:"RunStatusEnum"},taskId:{type:"String"},parentStepRun:{type:"String"}},_backend:{schema:"S2FWorkflow",collection:"workflow_run",mutation:{create:{args:{workflow:{type:"String"},args:{type:"FactoryJSON"},input:{type:"FactoryJSON"},parameters:{type:["ParameterInput"]},step:{type:"StepInput"},taskId:{type:"String"},parent:{type:"String"}},resolve:"createWorkflowRun"},update:{type:"WorkflowRun",args:{id:{type:"String",nullable:!1},status:{type:"RunStatusEnum"},ended:{type:"FactoryDateTime"}},resolve:"updateWorkflowRun"},delete:{type:"Boolean",args:{id:{type:"String",nullable:!1}},resolve:"deleteWorkflowRun"},endWorkflowRun:{type:"Boolean",args:{id:{type:"String",nullable:!1},status:{type:"RunStatusEnum",nullable:!1}},resolve:"endWorkflowRun"}}}},WorkflowRunThread={fields:{id:{type:"String",primary:!0},entityType:{type:"EntityTypeEnum"},parentThread:{type:"WorkflowRunThread",has:"id",resolve:"readWorkflowRunThread"},workflowRun:{type:"WorkflowRun",belongsTo:{WorkflowRun:{threads:"id"}},has:"id"},currentStepRun:{type:"StepRun",has:"id",resolve:"readStepRun"},stepRuns:{type:["StepRun"],resolve:"readStepRun"},status:{type:"RunStatusEnum"}},_backend:{schema:"S2FWorkflow",collection:"workflow_run_thread",mutation:{create:{args:{workflowRun:{type:"String",nullable:!1},currentStepRun:{type:"String",nullable:!1}}},update:{args:{id:{type:"String",nullable:!1},currentStepRun:{type:"String"},status:{type:"RunStatusEnum"}}},delete:{args:{id:{type:"String",nullable:!1}}}}}},types={EntitySummary:EntitySummary,EntityTypeEnum:EntityTypeEnum,Folder:Folder,FolderChildTypeEnum:FolderChildTypeEnum,FolderMembership:FolderMembership,FolderView:FolderView,Parameter:Parameter,ParameterClassEnum:ParameterClassEnum,ParameterRun:ParameterRun,ParameterRunValueInput:ParameterRunValueInput,ParameterTypeEnum:ParameterTypeEnum,ParameterScopeEnum:ParameterScopeEnum,RunStatusEnum:RunStatusEnum,Step:Step,StepInput:StepInput,StepRun:StepRun,StepTypeEnum:StepTypeEnum,SyncIdInput:SyncIdInput,SyncParameterInput:SyncParameterInput,SyncStepInput:SyncStepInput,SyncTemporalInput:SyncTemporalInput,SyncTemporalMetadataInput:SyncTemporalMetadataInput,Task:Task,Workflow:Workflow,WorkflowRun:WorkflowRun,WorkflowRunThread:WorkflowRunThread},_ParameterClassEnum$v=ParameterClassEnum.values,INPUT=_ParameterClassEnum$v.INPUT,_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")},defineProperty=function(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e},get=function e(r,t,n){null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,t);if(void 0===o){var a=Object.getPrototypeOf(r);return null===a?void 0:e(a,t,n)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(n)},inherits=function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)},possibleConstructorReturn=function(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r},set=function e(r,t,n,o){var a=Object.getOwnPropertyDescriptor(r,t);if(void 0===a){var l=Object.getPrototypeOf(r);null!==l&&e(l,t,n,o)}else if("value"in a&&a.writable)a.value=n;else{var u=a.set;void 0!==u&&u.call(o,n)}return n},_StepTypeEnum$values=StepTypeEnum.values,BASIC=_StepTypeEnum$values.BASIC,TASK=_StepTypeEnum$values.TASK,WORKFLOW=_StepTypeEnum$values.WORKFLOW,_RunStatusEnum$values$2=RunStatusEnum.values,FAIL=_RunStatusEnum$values$2.FAIL,SUCCESS$1=_RunStatusEnum$values$2.SUCCESS,JOINED$1=_RunStatusEnum$values$2.JOINED,RUNNING=RunStatusEnum.values.RUNNING,JOIN=StepTypeEnum.values.JOIN,_RunStatusEnum$values=RunStatusEnum.values,SUCCESS=_RunStatusEnum$values.SUCCESS,WAITING=_RunStatusEnum$values.WAITING,resume={handler:function(e){var r=e.payload,t=e.socket,n=e.requestId,o=this.backend.log,a="workflow.resume."+n,l=_.get(this.backend,"server._emitter"),u=r.resumeKey;if(!u||!n){var i=[new Error("no resumeKey or requestId specified")];o.error({resumeKey:u,requestId:n},"missing resume key or requestId"),l.emit(a,{errors:i}),t&&t.emit(a,{errors:i})}return resumeStep(this.backend,u,function(e){var r=e?{errors:[e]}:{status:"OK"};r.errors&&o.error({errors:r.errors},"failed to resume step"),l.emit(a,r),t&&t.emit(a,r)})}},workflow={handler:function(e){var r=e.payload,t=e.socket,n=e.requestId,o=r.query,a=r.rootValue,l=r.contextValue,u=r.variableValues,i=r.operationName;return this.backend.lib.S2FWorkflow(o,a,l,u,i).then(function(e){t&&t.emit("result."+n,e)}).catch(function(e){t&&t.emit("result."+n,{errors:[e]})})}},local={"workflow.resume":resume,workflow:workflow},resume$1={handler:function(e){this._emitter.emit("workflow.resume",e)}},workflow$1={handler:function(e){this._emitter.emit("workflow",e)}},socket={"workflow.resume":resume$1,workflow:workflow$1},events={local:local,socket:socket},ATTRIBUTE=ParameterClassEnum.values.ATTRIBUTE,INPUT$1=ParameterClassEnum.values.INPUT,_StepTypeEnum$values$1=StepTypeEnum.values,WORKFLOW$1=_StepTypeEnum$values$1.WORKFLOW,TASK$1=_StepTypeEnum$values$1.TASK,INPUT$2=ParameterClassEnum.values.INPUT,_RunStatusEnum$values$3=RunStatusEnum.values,FORKED=_RunStatusEnum$values$3.FORKED,CREATED$1=_RunStatusEnum$values$3.CREATED,RUNNING$2=_RunStatusEnum$values$3.RUNNING,FORK=StepTypeEnum.values.FORK,UPDATE="update",INSERT="insert",_EntityTypeEnum$value=EntityTypeEnum.values,PARAMETER=_EntityTypeEnum$value.PARAMETER,WORKFLOW$2=_EntityTypeEnum$value.WORKFLOW,STEP=_EntityTypeEnum$value.STEP,FolderType=FolderChildTypeEnum.values,UPDATE$1="update",INSERT$1="insert",_EntityTypeEnum$value$1=EntityTypeEnum.values,PARAMETER$1=_EntityTypeEnum$value$1.PARAMETER,TASK$2=_EntityTypeEnum$value$1.TASK,FolderType$1=FolderChildTypeEnum.values,_StepTypeEnum$values$2=StepTypeEnum.values,END$1=_StepTypeEnum$values$2.END,_ParameterClassEnum$v$1=ParameterClassEnum.values,ATTRIBUTE$1=_ParameterClassEnum$v$1.ATTRIBUTE,ATTRIBUTE$2=ParameterClassEnum.values.ATTRIBUTE,_StepTypeEnum$values$3=StepTypeEnum.values,START=_StepTypeEnum$values$3.START,END$2=_StepTypeEnum$values$3.END,functions={createFolder:createFolder,readFolder:readFolder,updateFolder:updateFolder,deleteFolder:deleteFolder,readRootFolder:readRootFolder,readSubFolder:readSubFolder,readWorkflowFolder:readWorkflowFolder,createParameter:createParameter,updateParameter:updateParameter,deleteParameter:deleteParameter,createParameterRun:createParameterRun,updateParameterRun:updateParameterRun,deleteParameterRun:deleteParameterRun,updateAttributeValues:updateAttributeValues$1,createStep:createStep,readStep:readStep,updateStep:updateStep,deleteStep:deleteStep,readStepThreads:readStepThreads,readSource:readSource,readStepParams:readStepParams,createStepRun:createStepRun,startStepRun:startStepRun$1,setStepRunStatus:setStepRunStatus$1,createForks:createForks,getJoinThreads:getJoinThreads,syncWorkflow:syncWorkflow,syncTask:syncTask,createTask:createTask,readTask:readTask,readTaskVersions:readTaskVersions,updateTask:updateTask,deleteTask:deleteTask,branchWorkflow:branchWorkflow,forkWorkflow:forkWorkflow,publishWorkflow:publishWorkflow,createWorkflow:createWorkflow,readWorkflow:readWorkflow,updateWorkflow:updateWorkflow,deleteWorkflow:deleteWorkflow,readWorkflowInputs:readWorkflowInputs,readWorkflowVersions:readWorkflowVersions,readWorkflowParameters:readWorkflowParameters,readEndStep:readEndStep,createWorkflowRun:createWorkflowRun,updateWorkflowRun:updateWorkflowRun,deleteWorkflowRun:deleteWorkflowRun,endWorkflowRun:endWorkflowRun$1,readWorkflowRunThread:readWorkflowRunThread},_RunStatusEnum$values$5=RunStatusEnum.values,CREATED$2=_RunStatusEnum$values$5.CREATED,FORKING$1=_RunStatusEnum$values$5.FORKING,JOINING$1=_RunStatusEnum$values$5.JOINING,ENDING$1=_RunStatusEnum$values$5.ENDING,RUNNING$4=_RunStatusEnum$values$5.RUNNING,JOINED$2=_RunStatusEnum$values$5.JOINED,RUNNING_STATES$1=[CREATED$2,FORKING$1,JOINING$1,RUNNING$4],_RunStatusEnum$values$4=RunStatusEnum.values,SUCCESS$2=_RunStatusEnum$values$4.SUCCESS,FAIL$1=_RunStatusEnum$values$4.FAIL,WAITING$1=_RunStatusEnum$values$4.WAITING,_ParameterClassEnum$v$2=ParameterClassEnum.values,OUTPUT$1=_ParameterClassEnum$v$2.OUTPUT,ATTRIBUTE$3=_ParameterClassEnum$v$2.ATTRIBUTE,_StepTypeEnum$values$4=StepTypeEnum.values,CONDITION$1=_StepTypeEnum$values$4.CONDITION,LOOP$2=_StepTypeEnum$values$4.LOOP,RUNNING$3=RunStatusEnum.values.RUNNING,LOOP$1=StepTypeEnum.values.LOOP,FORKED$1=RunStatusEnum.values.FORKED,RUNNING$5=RunStatusEnum.values.RUNNING,_StepTypes$values=StepTypeEnum.values,BASIC$1=_StepTypes$values.BASIC,CONDITION=_StepTypes$values.CONDITION,FORK$1=_StepTypes$values.FORK,JOIN$1=_StepTypes$values.JOIN,LOOP=_StepTypes$values.LOOP,TASK$4=_StepTypes$values.TASK,WORKFLOW$4=_StepTypes$values.WORKFLOW,actions=function(e){return{startWorkflow:startWorkflow(e),runStep:runStep(e)}},Task$2=[{_temporal:{changeLog:[{date:new Date(1473606625377),message:"Publish",type:"PUBLISH",user:"SYSTEM"}],recordId:"4c35b5a7-e971-4719-9846-ca06db2f8eb2",validFrom:new Date(1473606625377),validTo:null,version:"0.1.0"},entityType:"TASK",id:"0ea85a8a-ba97-4c31-8ed0-37926989b384",name:"Say Hello",source:'console.log("Hello", name)'},{_temporal:{recordId:"4c35b5a7-e971-4719-9846-ca06db2f8eb2",validFrom:null,validTo:null,version:null},entityType:"TASK",id:"b98548c6-d294-4406-88c1-3d7cffb97cfa",name:"Say Hello",source:'console.log("Hi", name)'}],Parameter$2=[{entityType:"PARAMETER",id:"0a329a80-3b97-4b83-832f-7f9c960afdfc",name:"name",parentId:"0ea85a8a-ba97-4c31-8ed0-37926989b384",required:"false",scope:"TASK",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"fed6aa1e-5a25-4cd6-8b35-20ad0e6547df",name:"name",parentId:"b98548c6-d294-4406-88c1-3d7cffb97cfa",required:"false",scope:"TASK",class:"INPUT",type:"STRING"}],SayHello={Task:Task$2,Parameter:Parameter$2},tasks=[SayHello],Workflow$2=[{_temporal:{changeLog:[],recordId:"72264666-5e7b-4bd7-b6f6-efff3a5aa73c",validFrom:null,validTo:null,version:null},entityType:"WORKFLOW",id:"170ab3d5-4ff4-41ed-b875-010067d1ebc5",name:"Fork Join Test",endStep:"44dad1a6-31d6-4d9b-9106-b80d05823195"}],Step$2=[{_temporal:{changeLog:[],recordId:"f32485c9-3087-43bc-9565-55a594fe9224",validFrom:null,validTo:null,version:null},description:"Ending point of the workflow",entityType:"STEP",fail:"44dad1a6-31d6-4d9b-9106-b80d05823195",failsWorkflow:!1,id:"44dad1a6-31d6-4d9b-9106-b80d05823195",name:"End",requireResumeKey:!1,success:"44dad1a6-31d6-4d9b-9106-b80d05823195",timeout:0,type:"END",waitOnSuccess:!1,workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"f1b70a2c-e583-4fcb-abf0-ae01621678c5",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"b6a0edaa-2417-4e75-8083-c62250dae391",name:"Fork",requireResumeKey:!1,timeout:0,type:"FORK",waitOnSuccess:!1,workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"e432ac48-6f52-4776-8c20-842246fe54f9",validFrom:null,validTo:null,version:null},async:!0,entityType:"STEP",failsWorkflow:!1,id:"80c73966-aac8-4f7b-b889-e64363322b4b",name:"Fork Left",source:'console.log("===========");\nconsole.log("=========== Forking Left", name);\nconsole.log("===========")',requireResumeKey:!1,success:"453721c9-9347-4d22-a07f-b85630954835",timeout:0,type:"BASIC",waitOnSuccess:!1,fork:"b6a0edaa-2417-4e75-8083-c62250dae391",workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"2108ead8-917f-43ef-ba2a-0d074bb300bd",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"453721c9-9347-4d22-a07f-b85630954835",name:"After Fork Left",source:'console.log("===========");\nconsole.log("=========== After Fork Left");\nconsole.log("===========")',requireResumeKey:!1,success:"b97ca7ae-b5de-4204-8440-5b695dfe45f9",timeout:0,type:"BASIC",waitOnSuccess:!1,workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"86393566-88b7-4971-97bf-6f60ea8df80c",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"3e5d2306-d12d-48f9-a9ee-a4b53acc753b",name:"Fork Right",source:'console.log("===========");\nconsole.log("=========== Forking Right");\nconsole.log("===========")',requireResumeKey:!1,success:"b97ca7ae-b5de-4204-8440-5b695dfe45f9",timeout:0,type:"BASIC",waitOnSuccess:!1,fork:"b6a0edaa-2417-4e75-8083-c62250dae391",workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"75c03bdd-ec3d-49ad-9ecb-207e9b511869",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"b97ca7ae-b5de-4204-8440-5b695dfe45f9",name:"Join",requireResumeKey:!1,timeout:0,type:"JOIN",success:"44dad1a6-31d6-4d9b-9106-b80d05823195",waitOnSuccess:!1,workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"},{_temporal:{changeLog:[],recordId:"7af16dd4-346a-4527-b9d4-b58d31017c4d",validFrom:null,validTo:null,version:null},description:"Starting point of the workflow",entityType:"STEP",fail:"44dad1a6-31d6-4d9b-9106-b80d05823195",failsWorkflow:!1,id:"1cb92ccb-e022-4b43-aa29-8e37492b021e",name:"Start",requireResumeKey:!1,success:"b6a0edaa-2417-4e75-8083-c62250dae391",timeout:0,type:"START",waitOnSuccess:!1,workflowId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5"}],Parameter$3=[{entityType:"PARAMETER",id:"c9cf9ca4-4053-4c32-b052-ad79f262df27",name:"name",parentId:"80c73966-aac8-4f7b-b889-e64363322b4b",required:"false",scope:"STEP",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"4686b2eb-7815-4bad-a941-dcbd36f1fba7",name:"name",parentId:"80c73966-aac8-4f7b-b889-e64363322b4b",required:"false",scope:"STEP",mapsTo:"9bbf9716-f6eb-4dd5-a9c5-b44fb29f93d0",class:"OUTPUT",type:"STRING"},{entityType:"PARAMETER",id:"9bbf9716-f6eb-4dd5-a9c5-b44fb29f93d0",name:"message",defaultValue:"Hello",parentId:"170ab3d5-4ff4-41ed-b875-010067d1ebc5",required:"false",scope:"WORKFLOW",class:"ATTRIBUTE",type:"STRING"}],ForkJoinTest={Workflow:Workflow$2,Step:Step$2,Parameter:Parameter$3},Workflow$3=[{_temporal:{changeLog:[],recordId:"151743c4-93ee-48ab-a7d3-608a5d06900e",validFrom:null,validTo:null,version:null},entityType:"WORKFLOW",id:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a",name:"Fork Test",endStep:"c6c463db-68bf-4e6f-aeaa-c546dae14525"}],Step$3=[{_temporal:{changeLog:[],recordId:"17bbc6b5-00c8-4aab-a9ca-05cdd38ab1ae",validFrom:null,validTo:null,version:null},description:"Ending point of the workflow",entityType:"STEP",fail:"c6c463db-68bf-4e6f-aeaa-c546dae14525",failsWorkflow:!1,id:"c6c463db-68bf-4e6f-aeaa-c546dae14525",name:"End",requireResumeKey:!1,success:"c6c463db-68bf-4e6f-aeaa-c546dae14525",timeout:0,type:"END",waitOnSuccess:!1,workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"},{_temporal:{changeLog:[],recordId:"31f7d5cf-4799-4029-a4b8-45be79f33e3f",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"4cc47451-7115-49b5-ace2-4d05fc3ad09c",name:"Fork",requireResumeKey:!1,timeout:0,type:"FORK",waitOnSuccess:!1,workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"},{_temporal:{changeLog:[],recordId:"c9c1531e-ef6d-4199-b559-796fd144d983",validFrom:null,validTo:null,version:null},async:!0,entityType:"STEP",failsWorkflow:!1,id:"9417a242-0f72-4ef7-b876-61efb23ad446",name:"Fork Left",source:'console.log("===========");\nconsole.log("=========== Forking Left", name);\nconsole.log("===========")',requireResumeKey:!1,success:"aff95d33-9f8a-4ece-87f7-462d1b71eeb9",timeout:0,type:"BASIC",waitOnSuccess:!1,fork:"4cc47451-7115-49b5-ace2-4d05fc3ad09c",workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"},{_temporal:{changeLog:[],recordId:"bbfe82e3-6ee6-4001-8ea6-2b00d932f2d3",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"aff95d33-9f8a-4ece-87f7-462d1b71eeb9",name:"After Fork Left",source:'console.log("===========");\nconsole.log("=========== After Fork Left");\nconsole.log("===========")',requireResumeKey:!1,success:"c6c463db-68bf-4e6f-aeaa-c546dae14525",timeout:0,type:"BASIC",waitOnSuccess:!1,workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"},{_temporal:{changeLog:[],recordId:"2a7f16df-3c7f-46ab-bdf9-9314a46c0c29",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"44580253-4216-4fe1-9333-dcef4927280f",name:"Fork Right",source:'console.log("===========");\nconsole.log("=========== Forking Right");\nconsole.log("===========")',requireResumeKey:!1,success:"c6c463db-68bf-4e6f-aeaa-c546dae14525",timeout:0,type:"BASIC",waitOnSuccess:!1,fork:"4cc47451-7115-49b5-ace2-4d05fc3ad09c",workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"},{_temporal:{changeLog:[],recordId:"ceff4a5d-3f73-4c63-8ba2-5fef6d65be28",validFrom:null,validTo:null,version:null},description:"Starting point of the workflow",entityType:"STEP",fail:"c6c463db-68bf-4e6f-aeaa-c546dae14525",failsWorkflow:!1,id:"3347466a-3abf-42c6-9fd7-3ddf22976af8",name:"Start",requireResumeKey:!1,success:"4cc47451-7115-49b5-ace2-4d05fc3ad09c",timeout:0,type:"START",waitOnSuccess:!1,workflowId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a"}],Parameter$4=[{entityType:"PARAMETER",id:"912f5d3b-9d4f-4fe5-93f1-a6446b983ed5",name:"name",parentId:"9417a242-0f72-4ef7-b876-61efb23ad446",required:"false",scope:"STEP",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"3361dde6-3db4-4a4e-8b4f-58d7f8fd2a90",name:"name",parentId:"9417a242-0f72-4ef7-b876-61efb23ad446",required:"false",scope:"STEP",mapsTo:"93f439a5-9833-4706-9cd8-7acf19b01901",class:"OUTPUT",type:"STRING"},{entityType:"PARAMETER",id:"93f439a5-9833-4706-9cd8-7acf19b01901",name:"message",defaultValue:"Hello",parentId:"dd64cdb7-d089-48e0-8994-33dbc9ed6c4a",required:"false",scope:"WORKFLOW",class:"ATTRIBUTE",type:"STRING"}],ForkTest={Workflow:Workflow$3,Step:Step$3,Parameter:Parameter$4},Workflow$4=[{_temporal:{changeLog:[],recordId:"c5801b61-a7cd-4995-964b-c0a1f368de7c",validFrom:null,validTo:null,version:null},entityType:"WORKFLOW",id:"f4a8f894-06ba-4213-80f1-80ff72e1039b",name:"Hello World",endStep:"d2618ad7-a4d2-4213-b921-935b6eeafaf4"},{_temporal:{changeLog:[],recordId:"c5801b61-a7cd-4995-964b-c0a1f368de7c",validFrom:new Date("2016-01-01"),validTo:null,version:"0.1.0"},entityType:"WORKFLOW",id:"e38faf1f-1ae4-4450-91b8-afb7c2e472c8",name:"Hello World",endStep:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb"}],Step$4=[{_temporal:{changeLog:[],recordId:"2f703d65-3aa7-40fc-b99d-3a0610ee6645",validFrom:null,validTo:null,version:null},description:"Ending point of the workflow",entityType:"STEP",fail:"d2618ad7-a4d2-4213-b921-935b6eeafaf4",failsWorkflow:!1,id:"d2618ad7-a4d2-4213-b921-935b6eeafaf4",name:"End",requireResumeKey:!1,success:"d2618ad7-a4d2-4213-b921-935b6eeafaf4",timeout:0,type:"END",waitOnSuccess:!1,workflowId:"f4a8f894-06ba-4213-80f1-80ff72e1039b"},{_temporal:{changeLog:[],recordId:"e86715f1-11a4-402c-9aa3-1b7c61a4af8c",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"68e5264a-89ef-4c85-9235-09d8e944580f",name:"Say Hello",requireResumeKey:!1,task:"4c35b5a7-e971-4719-9846-ca06db2f8eb2",versionArgs:{},success:"d2618ad7-a4d2-4213-b921-935b6eeafaf4",timeout:0,type:"TASK",waitOnSuccess:!1,workflowId:"f4a8f894-06ba-4213-80f1-80ff72e1039b"},{_temporal:{changeLog:[],recordId:"19a1e436-3532-4f51-8508-868d4f234bd2",validFrom:null,validTo:null,version:null},description:"Starting point of the workflow",entityType:"STEP",fail:"d2618ad7-a4d2-4213-b921-935b6eeafaf4",failsWorkflow:!1,id:"93a66216-21f5-45b5-92ae-f200a23c5c82",name:"Start",requireResumeKey:!1,success:"68e5264a-89ef-4c85-9235-09d8e944580f",timeout:0,type:"START",waitOnSuccess:!1,workflowId:"f4a8f894-06ba-4213-80f1-80ff72e1039b"},{_temporal:{changeLog:[],recordId:"b0199df1-50be-4958-9e51-39104ead1bee",validFrom:null,validTo:null,version:null},description:"Ending point of the workflow",entityType:"STEP",fail:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb",failsWorkflow:!1,id:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb",name:"End",requireResumeKey:!1,success:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb",timeout:0,type:"END",waitOnSuccess:!1,workflowId:"e38faf1f-1ae4-4450-91b8-afb7c2e472c8"},{_temporal:{changeLog:[],recordId:"cc76353e-5de4-44e8-8523-fd64f5a9149c",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"f8904d60-a73c-4348-867a-6d5df19bf6cc",name:"Say Hello",requireResumeKey:!1,task:"4c35b5a7-e971-4719-9846-ca06db2f8eb2",versionArgs:{},success:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb",timeout:0,type:"TASK",waitOnSuccess:!1,workflowId:"e38faf1f-1ae4-4450-91b8-afb7c2e472c8"},{_temporal:{changeLog:[],recordId:"758c4bea-0fc0-4f61-888c-7ef45d8fef35",validFrom:null,validTo:null,version:null},description:"Starting point of the workflow",entityType:"STEP",fail:"6c8f92a0-661c-49c8-981d-b44dc5a7feeb",failsWorkflow:!1,id:"85a7ba22-4d74-41e1-b291-c82f69d15456",name:"Start",requireResumeKey:!1,success:"f8904d60-a73c-4348-867a-6d5df19bf6cc",timeout:0,type:"START",waitOnSuccess:!1,workflowId:"e38faf1f-1ae4-4450-91b8-afb7c2e472c8"}],Parameter$5=[{entityType:"PARAMETER",id:"a2189572-dce9-46b8-897f-18d5bb221c08",name:"name",parentId:"68e5264a-89ef-4c85-9235-09d8e944580f",required:"false",scope:"STEP",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"1e5782b6-e8c0-47c0-b4bc-a0eca56805c1",name:"message",defaultValue:"Hello",parentId:"f4a8f894-06ba-4213-80f1-80ff72e1039b",required:"false",scope:"WORKFLOW",class:"ATTRIBUTE",type:"STRING"},{entityType:"PARAMETER",id:"97eacabd-6dbd-42fa-b6c4-3e8c49cde118",name:"name",parentId:"f8904d60-a73c-4348-867a-6d5df19bf6cc",required:"false",scope:"STEP",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"d01a6dad-9a0a-4eb5-abf6-04a212eda686",name:"message",defaultValue:"Hello",parentId:"e38faf1f-1ae4-4450-91b8-afb7c2e472c8",required:"false",scope:"WORKFLOW",class:"ATTRIBUTE",type:"STRING"}],HelloWorld={Workflow:Workflow$4,Step:Step$4,Parameter:Parameter$5},Workflow$5=[{_temporal:{changeLog:[],recordId:"2464780a-92ba-475b-b7a6-c49a0a9d189b",validFrom:null,validTo:null,version:null},entityType:"WORKFLOW",id:"de3f6477-aafb-49bb-9c88-ee3d7f65beff",name:"Sub Workflow Test",endStep:"c3dd216f-aa42-472d-806e-7beaf48609ed"}],Step$5=[{_temporal:{changeLog:[],recordId:"9231a271-0f03-418d-ac9c-faa46c59506e",validFrom:null,validTo:null,version:null},description:"Starting point of the workflow",entityType:"STEP",fail:"c3dd216f-aa42-472d-806e-7beaf48609ed",failsWorkflow:!1,id:"68084694-e75a-45ab-816e-615c3c606596",name:"Start",requireResumeKey:!1,success:"6cb7a7e5-1c6c-468e-8106-29abeb585844",timeout:0,type:"START",waitOnSuccess:!1,workflowId:"de3f6477-aafb-49bb-9c88-ee3d7f65beff"},{_temporal:{changeLog:[],recordId:"a0c84a22-4bde-4ee7-abc9-f098b082bef0",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"6cb7a7e5-1c6c-468e-8106-29abeb585844",name:"Test Name",source:'console.log("===========");\nconsole.log("Sub Workflow Start");\nconsole.log("===========");',requireResumeKey:!1,task:"5ca86058-4b93-4feb-8136-554195516cd1",success:"845a78a5-a2fa-422c-9cd5-806004be0038",timeout:0,type:"BASIC",waitOnSuccess:!1,workflowId:"de3f6477-aafb-49bb-9c88-ee3d7f65beff"},{_temporal:{changeLog:[],recordId:"4fb2fdd9-8698-4f97-ad37-19bfe9f05bad",validFrom:null,validTo:null,version:null},async:!1,entityType:"STEP",failsWorkflow:!1,id:"845a78a5-a2fa-422c-9cd5-806004be0038",name:"Hello World",requireResumeKey:!1,subWorkflow:"c5801b61-a7cd-4995-964b-c0a1f368de7c",success:"c3dd216f-aa42-472d-806e-7beaf48609ed",timeout:0,type:"WORKFLOW",waitOnSuccess:!1,workflowId:"de3f6477-aafb-49bb-9c88-ee3d7f65beff"},{_temporal:{changeLog:[],recordId:"94aa101f-4a8a-47a8-aae2-699cfeba541c",validFrom:null,validTo:null,version:null},description:"Ending point of the workflow",entityType:"STEP",fail:"c3dd216f-aa42-472d-806e-7beaf48609ed",failsWorkflow:!1,id:"c3dd216f-aa42-472d-806e-7beaf48609ed",name:"End",requireResumeKey:!1,success:"c3dd216f-aa42-472d-806e-7beaf48609ed",timeout:0,type:"END",waitOnSuccess:!1,workflowId:"de3f6477-aafb-49bb-9c88-ee3d7f65beff"}],Parameter$6=[{entityType:"PARAMETER",id:"1cf60c78-bfc9-4845-985c-343923f8c1d1",name:"name",parentId:"6cb7a7e5-1c6c-468e-8106-29abeb585844",required:"false",scope:"STEP",class:"INPUT",type:"STRING"},{entityType:"PARAMETER",id:"3fc2c440-5c1e-442f-9bfd-2250f88b2f0b",name:"message",defaultValue:"Hello",parentId:"de3f6477-aafb-49bb-9c88-ee3d7f65beff",required:"false",scope:"WORKFLOW",class:"ATTRIBUTE",type:"STRING"}],SubWorkflowTest={Workflow:Workflow$5,Step:Step$5,Parameter:Parameter$6},workflows=[ForkJoinTest,ForkTest,HelloWorld,SubWorkflowTest],Workflow$1=[],Step$1=[],Parameter$1=[],Task$1=[],Folder$1=[{id:"c841607d-9d26-43fc-9e7e-8eab7c9fd892",entityType:"FOLDER",name:"Workflows",parent:"ROOT",type:"WORKFLOW"},{id:"4acb1f18-2935-4708-8d3c-69c7209f8d87",entityType:"FOLDER",name:"Tasks",parent:"ROOT",type:"TASK"},{id:"9595014b-5614-4475-8e0e-4d07e4e865b6",entityType:"FOLDER",name:"Examples",parent:"c841607d-9d26-43fc-9e7e-8eab7c9fd892",type:"WORKFLOW"},{id:"067c20db-c009-4277-aeda-e3db9af31472",entityType:"FOLDER",name:"Examples",parent:"4acb1f18-2935-4708-8d3c-69c7209f8d87",type:"TASK"}],FolderMembership$1=[{folder:"067c20db-c009-4277-aeda-e3db9af31472",childType:"TASK",childId:"4c35b5a7-e971-4719-9846-ca06db2f8eb2"},{folder:"c841607d-9d26-43fc-9e7e-8eab7c9fd892",childType:"WORKFLOW",childId:"72264666-5e7b-4bd7-b6f6-efff3a5aa73c"},{folder:"c841607d-9d26-43fc-9e7e-8eab7c9fd892",childType:"WORKFLOW",childId:"151743c4-93ee-48ab-a7d3-608a5d06900e"},{folder:"9595014b-5614-4475-8e0e-4d07e4e865b6",childType:"WORKFLOW",childId:"c5801b61-a7cd-4995-964b-c0a1f368de7c"},{folder:"9595014b-5614-4475-8e0e-4d07e4e865b6",childType:"WORKFLOW",childId:"2464780a-92ba-475b-b7a6-c49a0a9d189b"}];_.forEach(_.union(workflows,tasks),function(e){_.isArray(e.Workflow)&&(Workflow$1=_.union(Workflow$1,e.Workflow)),_.isArray(e.Step)&&(Step$1=_.union(Step$1,e.Step)),_.isArray(e.Parameter)&&(Parameter$1=_.union(Parameter$1,e.Parameter)),_.isArray(e.Task)&&(Task$1=_.union(Task$1,e.Task))});var installData={Workflow:Workflow$1,Step:Step$1,Parameter:Parameter$1,Task:Task$1,Folder:Folder$1,FolderMembership:FolderMembership$1},S2fRethinkDBBackend=function(e){function r(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments[4];classCallCheck(this,r),o=mergeConfig(o);var l={tables:temporalTables(o.types),prefix:_.get(o,"options.prefix"),db:_.get(o,"options.store")},u=new graphqlFactoryTemporal_backend.rethinkdb(n,t,l,a),i=FactoryTemporalPlugin(u);o.plugin=_.union([i],_.isArray(o.plugin)?o.plugin:[]);var d=possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e,t,n,o,a));return d.type="S2fRethinkDBBackend",d.addInstallData(installData),d.addFunctions(functions),d.addActions(actions(d)),d.addEvents(events),d}return inherits(r,e),r}(yellowjacket.YellowjacketRethinkDBBackend),rethinkdb$1=function(e,r,t,n,o){return new S2fRethinkDBBackend(e,r,t,n,o)},index={rethinkdb:rethinkdb$1,S2fRethinkDBBackend:S2fRethinkDBBackend};exports.rethinkdb=rethinkdb$1,exports.S2fRethinkDBBackend=S2fRethinkDBBackend,exports.default=index;
